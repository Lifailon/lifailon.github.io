<!DOCTYPE html>
<html lang="en-us">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.123.8">

    

    

    
        
            <meta
                name="description"
                content="Large base of PowerShell notes in Russian language" />
        

        
            <meta
                name="keywords"
                content="PowerShell" />
        

        
            <meta name="author" content="Lifailon" />
        

    


    <title>
        
            Active Directory |
            Lifailon.GitHub.io
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_d751713.min.912d03bce61461ecbc3ca083479e1ed814bba94df76d0bdc6aa88fdca33621b9bb410dc2c81af31e8101fec62decfa5f6e48901ad673bc5056d2f1d1f2368a34.css"
            integrity="sha512-kS0DvOYUYey8PKCDR54e2BS7qU33bQvcaqiP3KM2Ibm7QQ3CyBrzHoEB/sYt7PpfbkiQGtZzvFBW0vHR8jaKNA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Active Directory -
            Lifailon.GitHub.io
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/github/" title="./github/">
                        GitHub
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/powershell/" title="./powershell/">
                        PowerShell
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/dotnet/" title="./dotnet/">
                        .NET
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/activedirectory/" title="./activedirectory/">
                        Active Directory
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/ansible/" title="./ansible/">
                        Ansible
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/api/" title="./api/">
                        API
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/apps/" title="./apps/">
                        Apps
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/com/" title="./com/">
                        Component Object Model
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/git/" title="./git/">
                        Git
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/html/" title="./html/">
                        HTML
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/influxdb/" title="./influxdb/">
                        InfluxDB
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/exchange/" title="./exchange/">
                        MS Exchange
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/mssql/" title="./mssql/">
                        MS SQL
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/mysql/" title="./mysql/">
                        MySQL
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/network/" title="./network/">
                        Network
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/virtualization/" title="./virtualization/">
                        Virtualization
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/wmi/" title="./wmi/">
                        WMI
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/zabbix/" title="./zabbix/">
                        Zabbix
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Active Directory
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/lifailon/"
                                class="cat-btn">
                                Lifailon
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="Mar 14 2024"
                            >Mar 14 2024
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        18 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    




<a href="https://lifailon.github.io/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://lifailon.github.io/activedirectory/" class="bread-btn">
    

    
        Active Directory
    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#active-directory">Active Directory</a>
      <ul>
        <li><a href="#rsat-remote-server-administration-tools">RSAT (Remote Server Administration Tools)</a></li>
        <li><a href="#import-module-activedirectory">Import-Module ActiveDirectory</a></li>
        <li><a href="#adsi-active-directory-service-interface">ADSI (Active Directory Service Interface)</a></li>
        <li><a href="#ldap-lightweight-directory-access-protocol">LDAP (Lightweight Directory Access Protocol)</a></li>
        <li><a href="#laps-local-admin-password-management">LAPS (Local Admin Password Management)</a></li>
        <li><a href="#recycle-bin">Recycle Bin</a></li>
        <li><a href="#thumbnailphoto">thumbnailPhoto</a></li>
        <li><a href="#addomaincontroller">ADDomainController</a></li>
        <li><a href="#adcomputer">ADComputer</a></li>
        <li><a href="#aduser">ADUser</a></li>
        <li><a href="#adgroupmember">ADGroupMember</a></li>
        <li><a href="#adreplication">ADReplication</a></li>
      </ul>
    </li>
    <li><a href="#repadmin">repadmin</a></li>
    <li><a href="#dcdiag">dcdiag</a></li>
    <li><a href="#ntdsutil">ntdsutil</a></li>
    <li><a href="#gpo">GPO</a></li>
    <li><a href="#servermanager">ServerManager</a>
      <ul>
        <li><a href="#pswa">PSWA</a></li>
        <li><a href="#wsb-windows-server-backup">WSB (Windows Server Backup)</a></li>
        <li><a href="#rds">RDS</a></li>
      </ul>
    </li>
    <li><a href="#dnsserver">DNSServer</a></li>
    <li><a href="#dhcpserver">DHCPServer</a></li>
    <li><a href="#dfs">DFS</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="active-directory">Active Directory</h2>
<h3 id="rsat-remote-server-administration-tools">RSAT (Remote Server Administration Tools)</h3>
<p><code>DISM.exe /Online /add-capability /CapabilityName:Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0 /CapabilityName:Rsat.GroupPolicy.Management.Tools~~~~0.0.1.0</code> <br>
<code>Add-WindowsCapability –online –Name Rsat.Dns.Tools~~~~0.0.1.0</code> <br>
<code>Add-WindowsCapability -Online -Name Rsat.DHCP.Tools~~~~0.0.1.0</code> <br>
<code>Add-WindowsCapability –online –Name Rsat.FileServices.Tools~~~~0.0.1.0</code> <br>
<code>Add-WindowsCapability -Online -Name Rsat.WSUS.Tools~~~~0.0.1.0</code> <br>
<code>Add-WindowsCapability -Online -Name Rsat.CertificateServices.Tools~~~~0.0.1.0</code> <br>
<code>Add-WindowsCapability -Online -Name Rsat.RemoteDesktop.Services.Tools~~~~0.0.1.0</code> <br>
<code>Get-WindowsCapability -Name RSAT* -Online | Select-Object -Property DisplayName, State</code> отобразить список установленных компанентов</p>
<h3 id="import-module-activedirectory">Import-Module ActiveDirectory</h3>
<p><code>$Session = New-PSSession -ComputerName $srv</code> -Credential $cred<code>\</code>Export-PSsession -Session $Session -Module ActiveDirectory -OutputModule ActiveDirectory<code>экспортировать модуль из удаленной сесси (например, с DC) \</code>Remove-PSSession -Session $Session<code>\</code>Import-Module ActiveDirectory<code>\</code>Get-Command -Module ActiveDirectory`</p>
<h3 id="adsi-active-directory-service-interface">ADSI (Active Directory Service Interface)</h3>
<p><code>$d0 = $env:userdnsdomain</code> <br>
<code>$d0 = $d0 -split &quot;\.&quot;</code> <br>
<code>$d1 = $d0[0]</code> <br>
<code>$d2 = $d0[1]</code> <br>
<code>$group = [ADSI]&quot;LDAP://OU=Domain Controllers,DC=$d1,DC=$d2&quot;</code> <br>
<code>$group | select *</code></p>
<p><code>$Local_User = [ADSI]&quot;WinNT://./Администратор,user&quot;</code> <br>
<code>$Local_User | Get-Member</code> <br>
<code>$Local_User.Description</code> <br>
<code>$Local_User.LastLogin</code> время последней авторизации локального пользователя</p>
<h3 id="ldap-lightweight-directory-access-protocol">LDAP (Lightweight Directory Access Protocol)</h3>
<p><code>$ldapsearcher = New-Object System.DirectoryServices.DirectorySearcher</code> <br>
<code>$ldapsearcher.SearchRoot = &quot;LDAP://OU=Domain Controllers,DC=$d1,DC=$d2&quot;</code> <br>
<code>$ldapsearcher.Filter = &quot;(objectclass=computer)&quot;</code> <br>
<code>$dc = $ldapsearcher.FindAll().path</code></p>
<p><code>$usr = $env:username</code> cписок групп текущего пользователя <br>
<code>$ldapsearcher = New-Object System.DirectoryServices.DirectorySearcher</code> <br>
<code>$ldapsearcher.Filter = &quot;(&amp;(objectCategory=User)(samAccountName=$usr))&quot;</code> <br>
<code>$usrfind = $ldapsearcher.FindOne()</code> <br>
<code>$groups = $usrfind.properties.memberof -replace &quot;(,OU=.+)&quot;</code> <br>
<code>$groups = $groups -replace &quot;(CN=)&quot;</code></p>
<p>DC (Domain Component) - компонент доменного имени <br>
OU (Organizational Unit) - организационные подразделения (type), используются для упорядочения объектов <br>
Container - так же используется для упорядочения объектов, контейнеры в отличии от подраделений не могут быть переименованы, удалены, созданы или связаны с объектом групповой политики (Computers, Domain Controllers, Users) <br>
DN (Distinguished Name) — уникальное имя объекта и местоположение в лесу AD. В DN описывается содержимое атрибутов в дереве (путь навигации), требуемое для доступа к конкретной записи или ее поиска <br>
CN (Common Name) - общее имя</p>
<p><code>(Get-ADObject (Get-ADRootDSE).DefaultNamingContext -Properties wellKnownObjects).wellKnownObjects</code> отобразить отобразить контейнеры по умолчанию <br>
<code>redircmp OU=Client Computers,DC=root,DC=domain,DC=local</code> изменить контейнер компьютеров по умолчанию <br>
<code>redirusr</code> изменить контейнер пользователей по умолчанию</p>
<h3 id="laps-local-admin-password-management">LAPS (Local Admin Password Management)</h3>
<p><code>Import-module AdmPwd.ps</code> импортировать модуль <br>
<code>Get-AdmPwdPassword -ComputerName NAME</code> посмотреть пароль <br>
<code>Reset-AdmPwdPassword -ComputerName NAME</code> изменить пароль <br>
<code>Get-ADComputer -Filter * -SearchBase &quot;DC=$d1,DC=$d2&quot; | Get-AdmPwdPassword -ComputerName {$_.Name} | select ComputerName,Password,ExpirationTimestamp | Out-GridView</code> <br>
<code>Get-ADComputer -Identity $srv | Get-AdmPwdPassword -ComputerName {$_.Name} | select ComputerName,Password,ExpirationTimestamp</code></p>
<h3 id="recycle-bin">Recycle Bin</h3>
<p>Удаленные объекты хранятся в корзине AD в течении времени захоронения (определяется в атрибуте домена msDS-deletedObjectLifetime), заданном для леса. По умолчанию это 180 дней. Если данный срок прошел, объект все еще остается в контейнере Deleted Objects, но большинство его атрибутов и связей очищаются (Recycled Object). После истечения периода tombstoneLifetime (по умолчанию также 180 дней, но можно увеличить) объект полностью удаляется из AD автоматическим процессом очистки. <br>
<code>Get-ADForest domain.local</code> отобразить уровень работы леса <br>
<code>Set-ADForestMode -Identity domain.local -ForestMode Windows2008R2Forest -force</code> увеличить уровень работы леса <br>
<code>Enable-ADOptionalFeature –Identity &quot;CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,DC=domain,DC=local&quot; –Scope ForestOrConfigurationSet –Target &quot;domain.local&quot;</code> включить корзину <br>
<code>Get-ADOptionalFeature &quot;Recycle Bin Feature&quot; | select-object name,EnabledScopes</code> если значение EnabledScopes не пустое, значит в домене корзина Active Directory включена <br>
<code>Get-ADObject -Filter 'Name -like &quot;*tnas*&quot;' -IncludeDeletedObjects</code> найти удаленную (Deleted: True) УЗ (ObjectClass: user) в AD <br>
<code>Get-ADObject -Filter 'Name -like &quot;*tnas*&quot;' –IncludeDeletedObjects -Properties *| select-object Name, sAMAccountName, LastKnownParent, memberOf, IsDeleted | fl</code> проверить значение атрибута IsDeleted, контейнер, в котором находился пользователе перед удалением (LastKnownParent) и список групп, в которых он состоял <br>
<code>Get-ADObject –filter {Deleted -eq $True -and ObjectClass -eq &quot;user&quot;} –includeDeletedObjects</code> вывести список удаленных пользователей <br>
<code>Restore-ADObject -Identity &quot;3dc33c7c-b912-4a19-b1b7-415c1395a34e&quot;</code> восстановить по значению атрибута ObjectGUID <br>
<code>Get-ADObject -Filter 'SAMAccountName -eq &quot;tnas-01&quot;' –IncludeDeletedObjects | Restore-ADObject</code> восстановить по SAMAccountName <br>
<code>Get-ADObject -Filter {Deleted -eq $True -and ObjectClass -eq 'group' -and Name -like '*Allow*'} –IncludeDeletedObjects | Restore-ADObject –Verbose</code> восстановить группу или компьютер</p>
<h3 id="thumbnailphoto">thumbnailPhoto</h3>
<p><code>$photo = [byte[]](Get-Content C:\Install\adm.jpg -Encoding byte)</code> преобразовать файл картинки в массив байтов (jpeg/bmp файл, размером фото до 100 Кб и разрешением 96?96) <br>
<code>Set-ADUser support4 -Replace @{thumbnailPhoto=$photo}</code> задать значение атрибута thumbnailPhoto</p>
<h3 id="addomaincontroller">ADDomainController</h3>
<p><code>Get-ADDomainController</code> выводит информацию о текущем контроллере домена (LogonServer), который используется данным компьютером для аутентификации (DC выбирается при загрузке в соответствии с топологией сайтов AD) <br>
<code>Get-ADDomainController -Discover -Service PrimaryDC</code> найти контроллер с ролью PDC в домене <br>
<code>Get-ADDomainController -Filter * | ft HostName,IPv4Address,Name,Site,OperatingSystem,IsGlobalCatalog</code> список все DC, принадлежность к сайту, версии ОС и GC</p>
<p>При загрузке ОС служба NetLogon делает DNS запрос со списком контроллеров домена (к SRV записи _ldap._tcp.dc.<em>msdcs.domain</em>), DNS возвращает список DC в домене с записью Service Location (SRV). Клиент делает LDAP запрос к DC для определения сайта AD по своему IP адресу. Клиент через DNS запрашивает список контроллеров домена в сайте (в разделе _tcp.sitename._sites&hellip;).</p>
<p>USN (Update Sequence Numbers) - счетчик номера последовательного обновления, который существует у каждого объекта AD. При репликации контроллеры обмениваются значениями USN, объект с более низким USN будет при репликации перезаписан объектом с более высоким USN. Находится в свойствах - Object (включить View - Advanced Features). Каждый контроллер домена содержит отдельный счетчик USN, который начинает отсчет в момент запуска процесса Dcpromo и продолжает увеличивать значения в течение всего времени существования контроллера домена. Значение счетчика USN увеличивается каждый раз, когда на контроллере домена происходит транзакция, это операции создания, обновления или удаления объекта.</p>
<p><code>Get-ADDomainController -Filter * | % {</code> отобразить USN объекта на всех DC в домене<code>\</code>Get-ADUser -Server $_.HostName -Identity support4 -Properties uSNChanged | select SamAccountName,uSNChanged<code>\</code>}`</p>
<p><code>dcpromo /forceremoval</code> принудительно выполнит понижение в роли контроллера домена до уровня рядового сервера. После понижения роли выполняется удаление всех ссылок в домене на этот контроллер. Далее производит включение сервера в состав домена, и выполнение обратного процесса, т.е. повышение сервера до уровня контроллера домена.</p>
<h3 id="adcomputer">ADComputer</h3>
<p><code>nltest /DSGETDC:$env:userdnsdomain</code> узнать на каком DC аудентифицирован хост (Logon Server) <br>
<code>nltest /SC_RESET:$env:userdnsdomain\srv-dc2.$env:userdnsdomain</code> переключить компьютер на другой контроллер домена AD вручную (The command completed successfully) <br>
<code>Get-ADComputer –Identity $env:computername -Properties PasswordLastSet</code> время последней смены пароля на сервере <br>
<code>Test-ComputerSecureChannel –verbose</code> проверить доверительные отношения с доменом (соответствует ли локальный пароль компьютера паролю, хранящемуся в AD) <br>
<code>Reset-ComputerMachinePassword -Credential domain\admin</code> принудительно обновить пароль <br>
<code>Netdom ResetPWD /Server:dc-01 /UserD:domain\admin /PasswordD:*</code> сбросить хэш пароля компьютера в домене (перезагрузка не требуется) <br>
<code>Search-ADAccount -AccountDisabled -ComputersOnly | select Name,LastLogonDate,Enabled</code> отобразить все отключенные компьютеры</p>
<p><code>Get-ADComputer -Filter * -Properties * | select name</code> список всех компьютеров в домене (Filter), вывести все свойства (Properties) <br>
<code>Get-ADComputer -Identity $srv -Properties * | ft Name,LastLogonDate,PasswordLastSet,ms-Mcs-AdmPwd -Autosize</code> конкретного компьютера в AD (Identity) <br>
<code>Get-ADComputer -SearchBase &quot;OU=Domain Controllers,DC=$d1,DC=$d2&quot; -Filter * -Properties * | ft Name, LastLogonDate, distinguishedName -Autosize</code> поиск в базе по DN (SearchBase)</p>
<p><code>(Get-ADComputer -Filter {enabled -eq &quot;true&quot;}).count</code> получить общее количество активных (незаблокированных) компьютеров <br>
<code>(Get-ADComputer -Filter {enabled -eq &quot;true&quot; -and OperatingSystem -like &quot;*Windows Server 2016*&quot;}).count</code> кол-во активных копьютеров с ОС WS 2016</p>
<p><code>Get-ADComputer -Filter * -Properties * | select @{Label=&quot;Ping Status&quot;; Expression={</code> <br>
<code>$ping = ping -n 1 -w 50 $_.Name</code> <br>
<code>if ($ping -match &quot;TTL&quot;) {&quot;Online&quot;} else {&quot;Offline&quot;}</code> <br>
<code>}},</code> <br>
<code>@{Label=&quot;Status&quot;; Expression={</code> <br>
<code>if ($_.Enabled -eq &quot;True&quot;) {$_.Enabled -replace &quot;True&quot;,&quot;Active&quot;} else {$_.Enabled -replace &quot;False&quot;,&quot;Blocked&quot;}</code> <br>
<code>}}, Name, IPv4Address, OperatingSystem, @{Label=&quot;UserOwner&quot;; Expression={$_.ManagedBy -replace &quot;(CN=|,.+)&quot;}</code> <br>
<code>},Created | Out-GridView</code></p>
<h3 id="aduser">ADUser</h3>
<p><code>Get-ADUser -Identity support4 -Properties *</code> список всех атрибутов <br>
<code>Get-ADUser -Identity support4 -Properties DistinguishedName, EmailAddress, Description</code> путь DN, email и описание <br>
<code>Get-ADUser -Filter {(Enabled -eq &quot;True&quot;) -and (mail -ne &quot;null&quot;)} -Properties mail | ft Name,mail</code> список активных пользователей и есть почтовый ящик <br>
<code>Get-ADUser -Filter {SamAccountName -like &quot;*&quot;} | Measure-Object</code> посчитать кол-во всех аккаунтов (Count) <br>
<code>Get-ADUser -Filter * -Properties WhenCreated | sort WhenCreated | ft Name, whenCreated</code> дата создания <br>
<code>Get-ADUser -Identity support4 -property LockedOut | select samaccountName,Name,Enabled,Lockedout</code> <br>
<code>Enabled=True</code> учетная запись включена - да <br>
<code>Lockedout=False</code> учетная запись заблокирована (например, политикой паролей) - нет <br>
<code>Get-ADUser -Identity support4 | Unlock-ADAccount</code> разблокировать учетную запись <br>
<code>Disable-ADAccount -Identity support4</code> отключить учетную запись <br>
<code>Enable-ADAccount -Identity support4</code> включить учетную запись <br>
<code>Search-ADAccount -LockedOut</code> найти все заблокированные учетные записи <br>
<code>Search-ADAccount -AccountDisabled | select Name,LastLogonDate,Enabled</code> отобразить все отключенные учетные записи с временем последнего входа</p>
<p><code>Get-ADUser -Identity support4 -Properties PasswordLastSet,PasswordExpired,PasswordNeverExpires</code> <br>
<code>PasswordLastSet</code> время последней смены пароля <br>
<code>PasswordExpired=False</code> пароль истек - нет <br>
<code>PasswordNeverExpires=True</code> срок действия пароля не истекает - да <br>
<code>Set-ADAccountPassword support4 -Reset -NewPassword (ConvertTo-SecureString -AsPlainText &quot;password&quot; -Force -Verbose)</code> изменить пароль учетной записи <br>
<code>Set-ADUser -Identity support4 -ChangePasswordAtLogon $True</code> смена пароля при следующем входе в систему</p>
<p><code>$day = (Get-Date).adddays(-90)</code> <br>
<code>Get-ADUser -filter {(passwordlastset -le $day)} | ft</code> пользователи, которые не меняли свой пароль больше 90 дней</p>
<p><code>$day = (Get-Date).adddays(-30)</code> <br>
<code>Get-ADUser -filter {(Created -ge $day)} -Property Created | select Name,Created</code> Новые пользователи за 30 дней</p>
<p><code>$day = (Get-Date).adddays(-360)</code> <br>
<code>Get-ADUser -Filter {(LastLogonTimestamp -le $day)} -Property LastLogonTimestamp | select Name,SamAccountName,@{n='LastLogonTimestamp';e={[DateTime]::FromFileTime($_.LastLogonTimestamp)}} | sort -Descending LastLogonTimestamp</code> пользователи, которые не логинились больше 360 дней. Репликация атрибута LastLogonTimestamp составляет от 9 до 14 дней. <br>
<code>| Disable-ADAccount $_.SamAccountName</code> заблокировать <br>
<code>-WhatIf</code> отобразить вывод без применения изменений</p>
<h3 id="adgroupmember">ADGroupMember</h3>
<p><code>(Get-ADUser -Identity support4 -Properties MemberOf).memberof</code> список групп в которых состоит пользователь <br>
<code>Get-ADGroupMember -Identity &quot;Domain Admins&quot; | Select Name,SamAccountName</code> список пользователей в группе <br>
<code>Add-ADGroupMember -Identity &quot;Domain Admins&quot; -Members support5</code> добавить в группу <br>
<code>Remove-ADGroupMember -Identity &quot;Domain Admins&quot; -Members support5 -force</code> удалить из группы <br>
<code>Get-ADGroup -filter * | where {!($_ | Get-ADGroupMember)} | Select Name</code> отобразить список пустых групп (-Not)</p>
<h3 id="adreplication">ADReplication</h3>
<p><code>Get-Command -Module ActiveDirectory -Name *Replication*</code> список всех командлетов модуля <br>
<code>Get-ADReplicationFailure -Target dc-01</code> список ошибок репликации с партнерами <br>
<code>Get-ADReplicationFailure -Target $env:userdnsdomain -Scope Domain</code> <br>
<code>Get-ADReplicationPartnerMetadata -Target dc-01 | select Partner,LastReplicationAttempt,LastReplicationSuccess,LastReplicationResult,LastChangeUsn</code> время последней и время успешной репликации с партнерами <br>
<code>Get-ADReplicationUpToDatenessVectorTable -Target dc-01</code> Update Sequence Number (USN) увеличивается каждый раз, когда на контроллере домена происходит транзакция (операции создания, обновления или удаления объекта), при репликации DC обмениваются значениями USN, объект с более низким USN при репликации будет перезаписан высоким USN.</p>
<h2 id="repadmin">repadmin</h2>
<p><code>repadmin /replsummary</code> отображает время последней репликации на всех DC по направлению (Source и Destination) и их состояние с учетом партнеров <br>
<code>repadmin /showrepl $srv</code> отображает всех партнеров по реплкации и их статус для всех разделов Naming Contexts (DC=ForestDnsZones, DC=DomainDnsZones, CN=Schema, CN=Configuration) <br>
<code>repadmin /replicate $srv2 $srv1 DC=domain,DC=local </code> выполнить репликацию с $srv1 на $srv2 только указанный раздела домена <br>
<code>repadmin /SyncAll /AdeP</code> запустить межсайтовую исходящую репликацию всех разделов от текущего сервера со всеми партнерами по репликации <br>
<code>/A</code> выполнить для всех разделов NC <br>
<code>/d</code> в сообщениях идентифицировать серверы по DN (вместо GUID DNS - глобальным уникальным идентификаторам) <br>
<code>/e</code> межсайтовая синхронизация (по умолчанию синхронизирует только с DC текущего сайта) <br>
<code>/P</code> извещать об изменениях с этого сервера (по умолчанию: опрашивать об изменениях) <br>
<code>repadmin /Queue $srv</code> отображает кол-во запросов входящей репликации (очередь), которое необходимо обработать (причиной может быть большое кол-во партнеров или формирование 1000 объектов скриптом) <br>
<code>repadmin /showbackup *</code> узнать дату последнего Backup</p>
<p><code>Error: 1722</code> сервер rpc недоступен (ошибка отката репликации). Проверить имя домена в настройках сетевого адаптера, первым должен идти адрес DNS-сервера другого контроллера домена, вторым свой адрес. <br>
<code>Get-Service -ComputerName $srv | select name,status | ? name -like &quot;RpcSs&quot;</code> <br>
<code>Get-Service -ComputerName $srv -Name RpcSs -RequiredServices</code> зависимые службы <br>
Зависимые службы RPC: <br>
&ldquo;Служба сведений о подключенных сетях&rdquo; - должен быть включен отложенный запуск. Если служба срабатывает до &ldquo;службы списка сетей&rdquo;, может падать связь с доменом (netlogon) <br>
&ldquo;Центр распространения ключей Kerberos&rdquo; <br>
&ldquo;DNS-сервер&rdquo; <br>
<code>nslookup $srv</code> <br>
<code>tnc $srv -p 135</code> <br>
<code>repadmin /retry</code> повторить попытку привязки к целевому DC, если была ошибка 1722 или 1753 (RPC недоступен)</p>
<p><code>repadmin /showrepl $srv</code> <br>
<code>Last attempt @ 2022-07-15 10:46:01 завершена с ошибкой, результат 8456 (0x2108)</code> при проверки showrepl этого партнера, его ошибка: 8457 (0x2109) <br>
<code>Last success @ 2022-07-11 02:29:46</code> последний успех <br>
Когда репликация автоматически отключена, ОС записывает в DSA - not writable одно из четырех значений: <br>
<code>Path: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\NTDS\Parameters</code> <br>
<code>Dsa Not Writable</code> <br>
<code>#define DSA_WRITABLE_GEN 1</code> версия леса несовместима с ОС <br>
<code>#define DSA_WRITABLE_NO_SPACE 2</code> на диске, где размещена база данных Active Directory или файлы журналов (логи), недостаточно свободного места <br>
<code>#define DSA_WRITABLE_USNROLLBCK 4</code> откат USN произошел из-за неправильного отката базы данных Active Directory во времени (восстановление из снапшота) <br>
<code>#define DSA_WRITABLE_CORRUPT_UTDV 8</code> вектор актуальности поврежден на локальном контроллере домена</p>
<h2 id="dcdiag">dcdiag</h2>
<p><code>dcdiag /s:&lt;DomainController&gt; [/n:&lt;NamingContext&gt;] [[/u:&lt;domain\user&gt;] [/p:&lt;password&gt;]] [{/a|/e}{/q|/v}] [/f:&lt;LogFile&gt;] [/ferr:&lt;ErrorLog&gt;] [/test:&lt;test&gt;] [/fix]</code> <br>
<code>dcdiag /Test:replications /s:dc-01</code> отображает ошибки репликации <br>
<code>dcdiag /Test:DNS /e /v /q</code> тест DNS <br>
<code>/a</code> проверка всех серверов данного сайта <br>
<code>/e</code> проверка всех серверов предприятия <br>
<code>/q</code> выводить только сообщения об ошибках <br>
<code>/v</code> выводить подробную информацию <br>
<code>/fix</code> автоматически исправляет ошибки <br>
<code>/test:</code> <br>
<code>NetLogons</code> проверка наличие прав на выполнение репликации <br>
<code>Connectivity</code> проверяет регистрацию DNS для каждого контроллера домена, отправляет тестовый эхо-пакет на каждый контроллер домена и проверяет подключение по протоколам LDAP и RPC к каждому контроллеру домена <br>
<code>Services</code> проверяет работоспособность всех служб, необходимых для работы контроллера домена, на указанном контроллере домена <br>
<code>Systemlog</code> проверяет наличие ошибок в журналах контроллера домена <br>
<code>FRSEvent</code> проверяет ошибки репликации в работе службы репликации файлов, что может означать наличие проблем в репликации SYSVOL и, таким образом, целостности копий объектов групповых политик <br>
<code>FSMOCheck</code> не проверяет роли хозяев операций, а вместо этого запрашивает сервер глобального каталога, первичный контроллер домена, предпочтительный сервер времени, сервер времени и центр распространения ключей (контроллер домена может подключиться к KDC, PDC, серверу глобального каталога) <br>
<code>KnowsOfRoleHolders</code> пgроверяет возможность подключения контроллеров домена ко всем пяти хозяевам операций (ролями FSMO) <br>
<code>MachineAccount</code> проверяет правильность регистрации учетной записи целевого компьютера и правильность объявлений служб этого компьютера (корректность доверительных отношения с доменом). Если обнаружена ошибка, ее можно исправить с помощью утилиты dcdiag, указав параметры /fixmachineaccount или /recreatemachineaccount <br>
<code>Advertising</code> проверяет, правильно ли контроллер домена сообщает о себе и о своей роли хозяина операций. Этот тест завершиться неудачно, если служба NetLogon не запущена <br>
<code>CheckSDRefDom</code> проверяет правильность доменов ссылок дескрипторов безопасности для каждого раздела каталогов программ <br>
<code>CrossRefValidation</code> проверяет правильность перекрестных ссылок для доменов <br>
<code>RRSSysvol</code> проверяет состояние готовности для FRS SYSVOL <br>
<code>Intersite</code> проверяет наличие ошибок, которые могут помешать нормальной репликации между сайтами. Компания Microsoft предупреждает, что иногда результаты этого теста могут оказаться неточными <br>
<code>KCCEvent</code> проверяет безошибочность создания объектов соединений для репликации между сайтами <br>
<code>NCSecDesc</code> проверяет правильность разрешений для репликации в дескрипторах безопасности для заголовков контекста именования <br>
<code>ObjectsReplicated</code> проверяет правильность репликации агента сервера каталогов и объектов учетных записей компьютеров <br>
<code>OutboundSecureChannels</code> проверяется наличие безопасных каналов между всеми контроллерами домена в интересующем домене <br>
<code>Replications</code> проверяет возможность репликации между контроллерами домена и сообщает обо всех ошибках при репликации <br>
<code>RidManager</code> проверяет работоспособность и доступность хозяина относительных идентификаторов <br>
<code>VerifyEnterpriseReferences</code> проверяет действительность системных ссылок службы репликации файлов для всех объектов на всех контроллерах домена в лесу <br>
<code>VerifyReferences</code> проверяет действительность системных ссылок службы репликации файлов для всех объектов на указанном контроллере домена <br>
<code>VerifyReplicas</code> проверяет действительность всех разделов каталога приложения на всех серверах, принимающих участие в репликации</p>
<h2 id="ntdsutil">ntdsutil</h2>
<p>Перенос БД AD (ntds.dit): <br>
<code>Get-Acl C:\Windows\NTDS | Set-Acl D:\AD-DB</code> скопировать NTFS разрешения на новый каталог <br>
<code>Stop-Service -ComputerName dc -name NTDS</code> остановить службу Active Directory Domain Services <br>
<code>ntdsutil</code> запустить утилиту ntdsutil <br>
<code>activate instance NTDS</code> выбрать активный экземпляр базы AD <br>
<code>files</code> перейдем в контекст files, в котором возможно выполнение операция с файлами базы ntds.dit <br>
<code>move DB to D:\AD-DB\</code> перенести базу AD в новый каталог (предварительно нужно его создать) <br>
<code>info</code> проверить, что БД находится в новом каталоге <br>
<code>move logs to D:\AD-DB\</code> переместим в тот же каталог файлы с журналами транзакций <br>
<code>quit</code> <br>
<code>Start-Service -ComputerName dc -name NTDS</code></p>
<p>Сброс пароля DSRM (режим восстановления служб каталогов):  <br>
<code>ntdsutil</code> <br>
<code>set dsrm password</code> <br>
<code>reset password on server NULL</code> <br>
новый пароль <br>
подтверждение пароля <br>
<code>quit</code> <br>
<code>quit</code></p>
<p>Синхронизировать с паролем УЗ в AD: <br>
<code>ntdsutil</code> <br>
<code>set dsrm password</code> <br>
<code>sync from domain account dsrmadmin</code> <br>
<code>quit</code> <br>
<code>quit</code></p>
<p>Ошибка 0x00002e2 при загрузке ОС. <br>
Загрузиться в режиме восстанавления WinRE (Windows Recovery Environment) - Startup Settings - Restart - DSRM (Directory Services Restore Mode) <br>
<code>reagentc /boottore</code> shutdown /f /r /o /t 0 перезагрузка в режиме WinRE - ОС на базе WinPE (Windows Preinstallation Environment), образ winre.wim находится на скрытом разделе System Restore <br>
На контроллере домена единственная локальная учетная запись — администратор DSRM. Пароль создается при установке роли контроллера домена ADDS на сервере (SafeModeAdministratorPassword). <br>
<code>ntdsutil</code> <br>
<code>activate instance ntds</code> <br>
<code>Files</code> <br>
<code>Info</code> <br>
<code>integrity</code> проверить целостность БД <br>
Ошибка: Failed to open DIT for AD DS/LDS instance NTDS. Error -2147418113 <br>
<code>mkdir c:\ntds_bak</code> <br>
<code>xcopy c:\Windows\NTDS\*.* c:\ntds_bak</code> backup содержимого каталога с БД <br>
<code>esentutl /g c:\windows\ntds\ntds.dit</code> проверим целостность файла <br>
Вывод: Integrity check completed. Database is CORRUPTED ошибка, база AD повреждена <br>
<code>esentutl /p c:\windows\ntds\ntds.dit</code> исправить ошибки <br>
Вывод: Operation completed successfully in xx seconds. нет ошибок <br>
<code>esentutl /g c:\windows\ntds\ntds.dit</code> проверим целостность файла <br>
Выполнить анализ семантики базы с помощью ntdsutil: <br>
<code>ntdsutil</code> <br>
<code>activate instance ntds</code> <br>
<code>semantic database analysis</code> <br>
<code>go</code> <br>
<code>go fixup</code> исправить семантические ошибки <br>
Сжать файл БД: <br>
<code>activate instance ntds</code> <br>
<code>files</code> <br>
<code>compact to C:\Windows\NTDS\TEMP</code> <br>
<code>copy C:\Windows\NTDS\TEMP\ntds.dit C:\Windows\NTDS\ntds.dit</code> заменить оригинальный файл ntds.dit <br>
<code>Del C:\Windows\NTDS\*.log</code> удалить все лог файлы из каталога NTDS</p>
<h2 id="gpo">GPO</h2>
<p><code>Get-Command -Module GroupPolicy</code> <br>
<code>Get-GPO -Domain domain.local -All | ft</code> <br>
<code>Get-GPO -Name LAPS</code> <br>
<code>[xml](Get-GPOReport LAPS -ReportType Xml)</code> <br>
<code>Get-GPPermission -Name LAPS -All</code> <br>
<code>Get-GPO LAPS | New-GPLink -Target &quot;ou=servers,dc=domain,dc=local&quot;</code> <br>
<code>Set-GPLink -Name LAPS -Target &quot;ou=servers,dc=domain,dc=local&quot; -LinkEnabled No</code> <br>
<code>Backup-GPO -Name LAPS -Path &quot;$home\Desktop&quot;</code> <br>
<code>Backup-GPO -All -Path &quot;$home\Desktop&quot;</code> <br>
<code>Restore-GPO -Name LAPS -Path C:\Backup\GPOs\</code></p>
<h2 id="servermanager">ServerManager</h2>
<p><code>Get-Command *WindowsFeature*</code> source module ServerManager <br>
<code>Get-WindowsFeature -ComputerName &quot;localhost&quot;</code> <br>
<code>Get-WindowsFeature | where Installed -eq $True</code> список установленных ролей и компонентов <br>
<code>Get-WindowsFeature | where FeatureType -eq &quot;Role&quot;</code> отсортировать по списку ролей <br>
<code>Install-WindowsFeature -Name DNS</code> установить роль <br>
<code>Get-Command *DNS*</code> <br>
<code>Get-DnsServerSetting -ALL</code> <br>
<code>Uninstall-WindowsFeature -Name DNS</code> удалить роль</p>
<h3 id="pswa">PSWA</h3>
<p><code>Install-WindowsFeature -Name WindowsPowerShellWebAccess -IncludeManagementTools</code> <br>
<code>Install-PswaWebApplication -UseTestCertificate</code> Создать веб-приложение /pswa <br>
<code>Add-PswaAuthorizationRule -UserGroupName &quot;$domain\Domain Admins&quot; -ComputerName * -ConfigurationName * -RuleName &quot;For Admins&quot;</code> добавить права авторизации</p>
<h3 id="wsb-windows-server-backup">WSB (Windows Server Backup)</h3>
<p>При создании backup DC через WSB, создается копия состояния системы (System State), куда попадает база AD (NTDS.DIT), объекты групповых политик, содержимое каталога SYSVOL, реестр, метаданные IIS, база AD CS, и другие системные файлы и ресурсы. Резервная копия создается через службу теневого копирования VSS. <br>
<code>Get-WindowsFeature Windows-Server-Backup</code> проверить установлена ли роль <br>
<code>Add-Windowsfeature Windows-Server-Backup –Includeallsubfeature</code> установить роль</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$path=<span style="color:#e6db74">&#34;\\</span>$srv<span style="color:#e6db74">\bak-dc\dc-03\&#34;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">string</span>]$TargetUNC=$path+(get-date <span style="color:#f92672">-f</span> <span style="color:#e6db74">&#39;yyyy-MM-dd&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ((Test-Path -Path $path) <span style="color:#f92672">-eq</span> $true) {New-Item -Path $TargetUNC -ItemType directory} <span style="color:#75715e"># если путь доступен, создать новую директорию по дате</span>
</span></span><span style="display:flex;"><span>$WBadmin_cmd = <span style="color:#e6db74">&#34;wbadmin.exe START BACKUP -backupTarget:</span>$TargetUNC<span style="color:#e6db74"> -systemState -noverify -vssCopy -quiet&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># $WBadmin_cmd = &#34;wbadmin start backup -backuptarget:$path -include:C:\Windows\NTDS\ntds.dit -quiet&#34; # Backup DB NTDS</span>
</span></span><span style="display:flex;"><span>Invoke-Expression $WBadmin_cmd</span></span></code></pre></div>
    
</div>
<h3 id="rds">RDS</h3>
<p><code>Get-Command -Module RemoteDesktop</code> <br>
<code>Get-RDServer -ConnectionBroker $broker</code> список всех серверов в фермеы, указывается полное доменное имя при обращение к серверу с ролью RDCB <br>
<code>Get-RDRemoteDesktop -ConnectionBroker $broker</code> список коллекций <br>
<code>(Get-RDLicenseConfiguration -ConnectionBroker $broker | select *).LicenseServer</code> список серверов с ролью RDL <br>
<code>Get-RDUserSession -ConnectionBroker $broker</code> список всех активных пользователей <br>
<code>Disconnect-RDUser -HostServer $srv -UnifiedSessionID $id -Force</code> отключить сессию пользователя <br>
<code>Get-RDAvailableApp -ConnectionBroker $broker -CollectionName C03</code> список установленного ПО на серверах в коллекции <br>
<code>(Get-RDSessionCollectionConfiguration -ConnectionBroker $broker -CollectionName C03 | select *).CustomRdpProperty</code> use redirection server name:i:1 <br>
<code>Get-RDConnectionBrokerHighAvailability</code></p>
<h2 id="dnsserver">DNSServer</h2>
<p><code>Get-Command -Module DnsServer</code> <br>
<code>Show-DnsServerCache</code> отобразить весь кэш DNS-сервера <br>
<code>Show-DnsServerCache | where HostName -match ru</code> <br>
<code>Clear-DnsServerCache</code> <br>
<code>Get-DnsServerCache</code> <br>
<code>Get-DnsServerDiagnostics</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$zone = icm $srv {Get-DnsServerZone} | select ZoneName,ZoneType,DynamicUpdate,ReplicationScope,SecureSecondaries,
</span></span><span style="display:flex;"><span>DirectoryPartitionName | Out-GridView -Title <span style="color:#e6db74">&#34;DNS Server: </span>$srv<span style="color:#e6db74">&#34;</span> <span style="color:#960050;background-color:#1e0010">–</span>PassThru
</span></span><span style="display:flex;"><span>$zone_name = $zone.ZoneName
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($zone_name <span style="color:#f92672">-ne</span> $null) {
</span></span><span style="display:flex;"><span>icm $srv {Get-DnsServerResourceRecord -ZoneName $using<span style="color:#960050;background-color:#1e0010">:</span>zone_name | sort RecordType | select RecordType,HostName, @{
</span></span><span style="display:flex;"><span>Label=<span style="color:#e6db74">&#34;IPAddress&#34;</span>; Expression={$_.RecordData.IPv4Address.IPAddressToString}},TimeToLive,Timestamp
</span></span><span style="display:flex;"><span>} | select RecordType,HostName,IPAddress,TimeToLive,Timestamp | Out-GridView -Title <span style="color:#e6db74">&#34;DNS Server: </span>$srv<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p><code>Sync-DnsServerZone –passthru</code> синхронизировать зоны с другими DC в домене <br>
<code>Remove-DnsServerZone -Name domain.local</code> удалить зону <br>
<code>Get-DnsServerResourceRecord -ZoneName domain.local -RRType A</code> вывести все А-записи в указанной зоне <br>
<code>Add-DnsServerResourceRecordA -Name new-host-name -IPv4Address 192.168.1.100 -ZoneName domain.local -TimeToLive 01:00:00 -CreatePtr</code> создать А-запись и PTR для нее <br>
<code>Remove-DnsServerResourceRecord -ZoneName domain.local -RRType A -Name new-host-name –Force</code> удалить А-запись</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$DNSServer = <span style="color:#e6db74">&#34;DC-01&#34;</span>
</span></span><span style="display:flex;"><span>$DNSFZone = <span style="color:#e6db74">&#34;domain.com&#34;</span>
</span></span><span style="display:flex;"><span>$DataFile = <span style="color:#e6db74">&#34;C:\Scripts\DNS-Create-A-Records-from-File.csv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cat $DataFile</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;HostName;IP&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;server-01;192.168.1.10&#34;</span>
</span></span><span style="display:flex;"><span>$DNSRR = [<span style="color:#66d9ef">WmiClass</span>]<span style="color:#e6db74">&#34;\\</span>$DNSServer<span style="color:#e6db74">\root\MicrosoftDNS:MicrosoftDNS_ResourceRecord&#34;</span>
</span></span><span style="display:flex;"><span>$ConvFile = $DataFile + <span style="color:#e6db74">&#34;_unicode&#34;</span>
</span></span><span style="display:flex;"><span>Get-Content $DataFile | Set-Content $ConvFile -Encoding Unicode
</span></span><span style="display:flex;"><span>Import-CSV $ConvFile -Delimiter <span style="color:#e6db74">&#34;;&#34;</span> | ForEach-Object {
</span></span><span style="display:flex;"><span>$FQDN = $_.HostName + <span style="color:#e6db74">&#34;.&#34;</span> + $DNSFZone
</span></span><span style="display:flex;"><span>$IP = $_.HostIP
</span></span><span style="display:flex;"><span>$TextA = <span style="color:#e6db74">&#34;</span>$FQDN<span style="color:#e6db74"> IN A </span>$IP<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">Void</span>]$DNSRR.CreateInstanceFromTextRepresentation($DNSServer,$DNSFZone,$TextA)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<h2 id="dhcpserver">DHCPServer</h2>
<p><code>Get-Command -Module DhcpServer</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$mac = icm $srv -ScriptBlock {Get-DhcpServerv4Scope | Get-DhcpServerv4Lease} | select AddressState,
</span></span><span style="display:flex;"><span>HostName,IPAddress,ClientId,DnsRegistration,DnsRR,ScopeId,ServerIP | Out-GridView -Title <span style="color:#e6db74">&#34;HDCP Server: </span>$srv<span style="color:#e6db74">&#34;</span> <span style="color:#960050;background-color:#1e0010">–</span>PassThru
</span></span><span style="display:flex;"><span>(New-Object -ComObject Wscript.Shell).Popup($mac.ClientId,<span style="color:#ae81ff">0</span>,$mac.HostName,<span style="color:#ae81ff">64</span>)</span></span></code></pre></div>
    
</div>
<p><code>Add-DhcpServerv4Reservation -ScopeId 192.168.1.0 -IPAddress 192.168.1.10 -ClientId 00-50-56-C0-00-08 -Description &quot;new reservation&quot;</code></p>
<h2 id="dfs">DFS</h2>
<p><code>dfsutil /root:\\domain.sys\public /export:C:\export-dfs.txt</code> экспорт конфигурации namespace root <br>
<code>dfsutil /AddFtRoot /Server:\\$srv /Share:public</code> на новой машине предварительно создать корень на основе домена <br>
<code>dfsutil /root:\\domain.sys\public /import:C:\export-dfs.txt /&lt;verify /set</code> Import (перед импортом данных в существующий корень DFS, утилита создает резервную копию конфигурации корня в текущем каталоге, из которого запускается утилита dfsutil) <br>
<code>/verify</code> выводит изменения, которые будут внесены в процессе импорта, без применения <br>
<code>/set</code> меняет целевое пространство имен путем полной перезаписи и замены на конфигурацию пространства имен из импортируемого файла <br>
<code>/merge</code> импортирует конфигурацию пространства имен в дополнение к существующей конфигурации для слияния, параметры из файла конфигурации будут иметь больший приоритет, чем существующие параметры пространства имен</p>
<p><code>Export-DfsrClone</code> экспортирует клонированную базу данных репликации DFS и параметры конфигурации тома <br>
<code>Get-DfsrCloneState</code> получает состояние операции клонирования базы данных <br>
<code>Import-DfsrClone</code> импортирует клонированную базу данных репликации DFS и параметры конфигурации тома</p>
<p><code>net use x: \\$srv1\public\*</code> примонтировать диск <br>
<code>Get-DfsrFileHash x:\* | Out-File C:\$srv1.txt</code> забрать hash всех файлов диска в файл (файлы с одинаковыми хешами всегда являются точными копиями друг друга) <br>
<code>net use x: /d</code> отмонтировать <br>
<code>net use x: \\$srv2\public\*</code> <br>
<code>Get-DfsrFileHash x:\* | Out-File C:\$srv2.txt</code> <br>
<code>net use x: /d</code> <br>
<code>Compare-Object -ReferenceObject (Get-Content C:\$srv1.txt) -DifferenceObject (Get-Content C:\$srv2.txt) -IncludeEqual</code> сравнить содержимое файлов</p>
<p><code>Get-DfsrBacklog -DestinationComputerName &quot;fs-06&quot; -SourceComputerName &quot;fs-05&quot; -GroupName &quot;folder-rep&quot; -FolderName &quot;folder&quot; -Verbose</code> получает список ожидающих обновлений файлов между двумя партнерами репликации DFS <br>
<code>Get-DfsrConnection</code> отображает группы репликации, участников и статус <br>
<code>Get-DfsReplicatedFolder</code> отображает имя и полный путь к папкам реликации в системе DFS <br>
<code>Get-DfsrState -ComputerName fs-06 -Verbose</code> состояние репликации DFS для члена группы <br>
<code>Get-DfsReplicationGroup</code> отображает группы репликации и их статус <br>
<code>Add-DfsrConnection</code> создает соединение между членами группы репликации <br>
<code>Add-DfsrMember</code> добавляет компьютеры в группу репликации <br>
<code>ConvertFrom-DfsrGuid</code> преобразует идентификаторы GUID в понятные имена в заданной группы репликации <br>
<code>Get-DfsrConnectionSchedule</code> получает расписание соединений между членами группы репликации <br>
<code>Get-DfsrGroupSchedule</code> извлекает расписание группы репликации <br>
<code>Get-DfsrIdRecord</code> получает записи ID для реплицированных файлов или папок из базы данных репликации DFS <br>
<code>Get-DfsrMember</code> получает компьютеры в группе репликации <br>
<code>Get-DfsrMembership</code> получает параметры членства для членов групп репликации <br>
<code>Get-DfsrPreservedFiles</code> получает список файлов и папок, ранее сохраненных репликацией DFS <br>
<code>Get-DfsrServiceConfiguration</code> получает параметры службы репликации DFS для членов группы <br>
<code>Grant-DfsrDelegation</code> предоставляет разрешения участникам безопасности для группы репликации <br>
<code>Revoke-DfsrDelegation</code> отменяет разрешения участников безопасности для группы репликации <br>
<code>New-DfsReplicationGroup</code> создает группу репликации <br>
<code>New-DfsReplicatedFolder</code> создает реплицированную папку в группе репликации <br>
<code>Remove-DfsrConnection</code> удаляет соединение между членами группы репликации <br>
<code>Remove-DfsReplicatedFolder</code> удаляет реплицированную папку из группы репликации <br>
<code>Remove-DfsReplicationGroup</code> удаляет группу репликации <br>
<code>Remove-DfsrMember</code> удаляет компьютеры из группы репликации <br>
<code>Restore-DfsrPreservedFiles</code> восстанавливает файлы и папки, ранее сохраненные репликацией DFS <br>
<code>Set-DfsrConnection</code> изменяет параметры соединения между членами группы репликации <br>
<code>Set-DfsrConnectionSchedule</code> изменяет параметры расписания соединений между членами группы репликации <br>
<code>Set-DfsReplicatedFolder</code> изменяет настройки реплицированной папки <br>
<code>Set-DfsReplicationGroup</code> изменяет группу репликации <br>
<code>Set-DfsrGroupSchedule</code> изменяет расписание группы репликации <br>
<code>Set-DfsrMember</code> изменяет информацию о компьютере-участнике в группе репликации <br>
<code>Set-DfsrMembership</code> настраивает параметры членства для членов группы репликации <br>
<code>Set-DfsrServiceConfiguration</code> изменяет параметры службы репликации DFS <br>
<code>Sync-DfsReplicationGroup</code> синхронизирует репликацию между компьютерами независимо от расписания <br>
<code>Suspend-DfsReplicationGroup</code> приостанавливает репликацию между компьютерами независимо от расписания <br>
<code>Update-DfsrConfigurationFromAD</code> инициирует обновление службы репликации DFS <br>
<code>Write-DfsrHealthReport</code> создает отчет о работоспособности репликации DFS <br>
<code>Write-DfsrPropagationReport</code> создает отчеты для тестовых файлов распространения в группе репликации <br>
<code>Start-DfsrPropagationTest</code> создает тестовый файл распространения в реплицированной папке</p>
<h1 id="storagereplica">StorageReplica</h1>
<p><code>Install-WindowsFeature Storage-Replica –IncludeManagementTools -Restart</code> <br>
<code>Get-Command -Module StorageReplica</code> <br>
<code>Test-SRTopology</code> проверить соответствует ли сервер и канал связи технологии Storage Replica <br>
<code>New-SRPartnership -SourceComputerName srv-01 -SourceRGName srv-01-rep-group-01 -SourceVolumeName D: -SourceLogVolumeName L: -DestinationComputerName srv-02 -DestinationRGName srv-02-rep-group-01 -DestinationVolumeName D: -DestinationLogVolumeName L: -LogSizeInBytes 1GB</code> <br>
<code>Get-Counter -Counter &quot;\Storage Replica Statistics(*)&quot;</code> <br>
<code>Get-WinEvent -ProviderName Microsoft-Windows-StorageReplica -max 10</code> <br>
<code>Set-SRPartnership -ReplicationMode Asynchronous</code> переключить режим репликации на асинхронный <br>
<code>Set-SRPartnership -NewSourceComputerName srv-02 -SourceRGName srv-02-rep-group-01 -DestinationComputerName srv-01 -DestinationRGName srv-01-rep-group-01</code> изменить вручную направление репликации данных, переведя вторичную копию в онлайн режим (при выходе из строя основного сервера) <br>
<code>Get-SRGroup</code> информация о состояние группы реплизации <br>
<code>Get-SRPartnerShip</code> информация о направлении репликации <br>
<code>(Get-SRGroup).Replicas | Select-Object numofbytesremaining</code> проверить длину очереди копирования <br>
<code>Get-SRPartnership | Remove-SRPartnership</code> удалить реплизацию на основном сервере <br>
<code>Get-SRGroup | Remove-SRGroup</code> удалить реплизацию на обоих серверах</p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>GitHub</li>
            

            
                <li>Lifailon</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/Lifailon" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            

            
            

            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.123.8</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Mar 14 2024
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
