<!doctype html><html data-theme=light lang=en xmlns=http://www.w3.org/1999/xhtml><head><meta charset=UTF-8><meta content="Web version for PowerShell notes in Russian language (Сheat Sheet & Documentation) and RuDocs (node.js)" name=description><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ff7800 name=theme-color><meta content=#ffa348 media=(prefers-color-scheme:dark) name=theme-color><meta content="default-src 'none';font-src 'self';img-src 'self' https: data:;media-src 'self' https:;style-src 'self' 'unsafe-inline';frame-src https://player.vimeo.com https://www.youtube-nocookie.com https://toot.community;frame-ancestors 'none';base-uri 'none';form-action 'none';connect-src 'self' https://toot.community;script-src 'self' 'self'" http-equiv=content-security-policy><title>Active Directory - PowerShell Commands / RuDocs</title><link href=https://lifailon.github.io/activedirectory/ rel=canonical><link href=https://lifailon.github.io/favicon.png rel=icon type=image/png><link href=https://lifailon.github.io/apple-touch-icon.png rel=apple-touch-icon sizes=180x180 type=image/png><link title="PowerShell Commands / RuDocs - RSS Feed" href=https://lifailon.github.io/rss.xml rel=alternate type=application/rss+xml><link title="PowerShell Commands / RuDocs - Atom Feed" href=https://lifailon.github.io/atom.xml rel=alternate type=application/atom+xml><style>:root{--accent-color:#ff7800;--contrast-color:#000c}[data-theme=dark]{--accent-color:#ffa348}@media (prefers-color-scheme:dark){:root:not([data-theme=light]){--accent-color:#ffa348}}[data-theme=dark]{--contrast-color:#000c}@media (prefers-color-scheme:dark){:root:not([data-theme=light]){--contrast-color:#000c}}</style><link href=https://lifailon.github.io/style.css rel=stylesheet><link media="(prefers-color-scheme: light)" href=https://lifailon.github.io/syntax-theme-light.css rel=stylesheet><link media="(prefers-color-scheme: dark)" href=https://lifailon.github.io/syntax-theme-dark.css rel=stylesheet><script defer src=https://lifailon.github.io/closable.js></script><script defer src=https://lifailon.github.io/copy-button.js></script><script defer src=https://lifailon.github.io/elasticlunr.min.js></script><script defer src=https://lifailon.github.io/search-elasticlunr.js></script><script defer src=https://lifailon.github.io/theme-switcher.js></script><meta content="PowerShell Commands / RuDocs" property=og:site_name><meta content="Active Directory - PowerShell Commands / RuDocs" property=og:title><meta content=https://lifailon.github.io/activedirectory/ property=og:url><meta content="Web version for PowerShell notes in Russian language (Сheat Sheet & Documentation) and RuDocs (node.js)" property=og:description><meta content=https://lifailon.github.io/card.png property=og:image><meta content=en_US property=og:locale><body><div id=handle></div><header id=site-nav><nav><a href=#main-content tabindex=0> Skip to Main Content </a><ul><li id=home><a href=https://lifailon.github.io> <i class=icon></i>PowerShell Commands / RuDocs</a><li class=divider><li><details class=closable><summary>PowerShell</summary> <ul><li><a href=https://lifailon.github.io/syntax/>PowerShell Syntax</a><li><a href=https://lifailon.github.io/filesystem/>File System</a><li><a href=https://lifailon.github.io/windows/>Operating System</a><li><a href=https://lifailon.github.io/network/>Network</a><li><a href=https://lifailon.github.io/threads/>Threads</a><li><a href=https://lifailon.github.io/modules/>Modules</a><li><a href=https://lifailon.github.io/dotnet/>dotNET</a><li><a href=https://lifailon.github.io/com/>COM</a><li><a href=https://lifailon.github.io/servermanager/>Server Manager</a><li><a class=active href=https://lifailon.github.io/activedirectory/>Active Directory</a><li><a href=https://lifailon.github.io/exchange/>Exchange</a><li><a href=https://lifailon.github.io/virtualization/>Virtualization</a><li><a href=https://lifailon.github.io/database/>Database</a><li><a href=https://lifailon.github.io/markuplanguages/>Markup Languages</a><li><a href=https://lifailon.github.io/api/>API</a><li><a href=https://lifailon.github.io/zabbix/>Zabbix</a><li><a href=https://lifailon.github.io/devops/>DevOps</a></ul></details><li><a href=https://lifailon.github.io/node-js/>Node.js</a><li><a href=https://lifailon.github.io/linux/>Linux</a><li><a href=https://lifailon.github.io/docker/>Docker</a><li id=search><button class=circle id=search-toggle title=Search><i class=icon></i></button><li id=theme-switcher><details class=closable><summary class=circle title=Theme><i class=icon></i></summary> <ul><li><button title="Switch to Light Theme" class=circle id=theme-light><i class=icon></i></button><li><button title="Switch to Dark Theme" class=circle id=theme-dark><i class=icon></i></button><li><button title="Use System Theme" class=circle id=theme-system><i class=icon></i></button></ul></details><li id=repo><a class=circle href=https://github.com/Lifailon/PS-Commands title=Repository> <i class=icon></i> </a></ul></nav><div id=search-container><label class=visually-hidden for=search-bar>Search</label><input placeholder="Search for…" autocomplete=off disabled id=search-bar type=search><div id=search-results-container><div id=search-results></div></div></div></header><main id=main-content><h1>Active Directory</h1><h2 id=rsat-remote-server-administration-tools><a aria-label="Anchor link for: rsat-remote-server-administration-tools" class=zola-anchor href=#rsat-remote-server-administration-tools><i class=icon></i></a> RSAT (Remote Server Administration Tools)</h2><p><code>DISM.exe /Online /add-capability /CapabilityName:Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0 /CapabilityName:Rsat.GroupPolicy.Management.Tools~~~~0.0.1.0</code><br> <code>Add-WindowsCapability –online –Name Rsat.Dns.Tools~~~~0.0.1.0</code><br> <code>Add-WindowsCapability -Online -Name Rsat.DHCP.Tools~~~~0.0.1.0</code><br> <code>Add-WindowsCapability –online –Name Rsat.FileServices.Tools~~~~0.0.1.0</code><br> <code>Add-WindowsCapability -Online -Name Rsat.WSUS.Tools~~~~0.0.1.0</code><br> <code>Add-WindowsCapability -Online -Name Rsat.CertificateServices.Tools~~~~0.0.1.0</code><br> <code>Add-WindowsCapability -Online -Name Rsat.RemoteDesktop.Services.Tools~~~~0.0.1.0</code><br> <code>Get-WindowsCapability -Name RSAT* -Online | Select-Object -Property DisplayName, State</code> отобразить список установленных компанентов<h2 id=import-module-activedirectory><a aria-label="Anchor link for: import-module-activedirectory" class=zola-anchor href=#import-module-activedirectory><i class=icon></i></a> Import-Module ActiveDirectory</h2><p><code>$Session = New-PSSession -ComputerName $srv</code> -Credential $cred<br> <code>Export-PSsession -Session $Session -Module ActiveDirectory -OutputModule ActiveDirectory</code> экспортировать модуль из удаленной сесси (например, с DC)<br> <code>Remove-PSSession -Session $Session</code><br> <code>Import-Module ActiveDirectory</code><br> <code>Get-Command -Module ActiveDirectory</code><h2 id=adsi-active-directory-service-interface><a aria-label="Anchor link for: adsi-active-directory-service-interface" class=zola-anchor href=#adsi-active-directory-service-interface><i class=icon></i></a> ADSI (Active Directory Service Interface)</h2><p><code>$d0 = $env:userdnsdomain</code><br> <code>$d0 = $d0 -split "\."</code><br> <code>$d1 = $d0[0]</code><br> <code>$d2 = $d0[1]</code><br> <code>$group = [ADSI]"LDAP://OU=Domain Controllers,DC=$d1,DC=$d2"</code><br> <code>$group | select *</code><p><code>$Local_User = [ADSI]"WinNT://./Администратор,user"</code><br> <code>$Local_User | Get-Member</code><br> <code>$Local_User.Description</code><br> <code>$Local_User.LastLogin</code> время последней авторизации локального пользователя<h2 id=ldap-lightweight-directory-access-protocol><a aria-label="Anchor link for: ldap-lightweight-directory-access-protocol" class=zola-anchor href=#ldap-lightweight-directory-access-protocol><i class=icon></i></a> LDAP (Lightweight Directory Access Protocol)</h2><p><code>$ldapsearcher = New-Object System.DirectoryServices.DirectorySearcher</code><br> <code>$ldapsearcher.SearchRoot = "LDAP://OU=Domain Controllers,DC=$d1,DC=$d2"</code><br> <code>$ldapsearcher.Filter = "(objectclass=computer)"</code><br> <code>$dc = $ldapsearcher.FindAll().path</code><p><code>$usr = $env:username</code> cписок групп текущего пользователя<br> <code>$ldapsearcher = New-Object System.DirectoryServices.DirectorySearcher</code><br> <code>$ldapsearcher.Filter = "(&(objectCategory=User)(samAccountName=$usr))"</code><br> <code>$usrfind = $ldapsearcher.FindOne()</code><br> <code>$groups = $usrfind.properties.memberof -replace "(,OU=.+)"</code><br> <code>$groups = $groups -replace "(CN=)"</code><p>DC (Domain Component) - компонент доменного имени<br> OU (Organizational Unit) - организационные подразделения (type), используются для упорядочения объектов<br> Container - так же используется для упорядочения объектов, контейнеры в отличии от подраделений не могут быть переименованы, удалены, созданы или связаны с объектом групповой политики (Computers, Domain Controllers, Users)<br> DN (Distinguished Name) — уникальное имя объекта и местоположение в лесу AD. В DN описывается содержимое атрибутов в дереве (путь навигации), требуемое для доступа к конкретной записи или ее поиска<br> CN (Common Name) - общее имя<p><code>(Get-ADObject (Get-ADRootDSE).DefaultNamingContext -Properties wellKnownObjects).wellKnownObjects</code> отобразить отобразить контейнеры по умолчанию<br> <code>redircmp OU=Client Computers,DC=root,DC=domain,DC=local</code> изменить контейнер компьютеров по умолчанию<br> <code>redirusr</code> изменить контейнер пользователей по умолчанию<h2 id=laps-local-admin-password-management><a aria-label="Anchor link for: laps-local-admin-password-management" class=zola-anchor href=#laps-local-admin-password-management><i class=icon></i></a> LAPS (Local Admin Password Management)</h2><p><code>Import-module AdmPwd.ps</code> импортировать модуль<br> <code>Get-AdmPwdPassword -ComputerName NAME</code> посмотреть пароль<br> <code>Reset-AdmPwdPassword -ComputerName NAME</code> изменить пароль<br> <code>Get-ADComputer -Filter * -SearchBase "DC=$d1,DC=$d2" | Get-AdmPwdPassword -ComputerName {$_.Name} | select ComputerName,Password,ExpirationTimestamp | Out-GridView</code><br> <code>Get-ADComputer -Identity $srv | Get-AdmPwdPassword -ComputerName {$_.Name} | select ComputerName,Password,ExpirationTimestamp</code><h2 id=recycle-bin><a aria-label="Anchor link for: recycle-bin" class=zola-anchor href=#recycle-bin><i class=icon></i></a> Recycle Bin</h2><p>Удаленные объекты хранятся в корзине AD в течении времени захоронения (определяется в атрибуте домена msDS-deletedObjectLifetime), заданном для леса. По умолчанию это 180 дней. Если данный срок прошел, объект все еще остается в контейнере Deleted Objects, но большинство его атрибутов и связей очищаются (Recycled Object). После истечения периода tombstoneLifetime (по умолчанию также 180 дней, но можно увеличить) объект полностью удаляется из AD автоматическим процессом очистки.<br> <code>Get-ADForest domain.local</code> отобразить уровень работы леса<br> <code>Set-ADForestMode -Identity domain.local -ForestMode Windows2008R2Forest -force</code> увеличить уровень работы леса<br> <code>Enable-ADOptionalFeature –Identity "CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,DC=domain,DC=local" –Scope ForestOrConfigurationSet –Target "domain.local"</code> включить корзину<br> <code>Get-ADOptionalFeature "Recycle Bin Feature" | select-object name,EnabledScopes</code> если значение EnabledScopes не пустое, значит в домене корзина Active Directory включена<br> <code>Get-ADObject -Filter 'Name -like "*tnas*"' -IncludeDeletedObjects</code> найти удаленную (Deleted: True) УЗ (ObjectClass: user) в AD<br> <code>Get-ADObject -Filter 'Name -like "*tnas*"' –IncludeDeletedObjects -Properties *| select-object Name, sAMAccountName, LastKnownParent, memberOf, IsDeleted | fl</code> проверить значение атрибута IsDeleted, контейнер, в котором находился пользователе перед удалением (LastKnownParent) и список групп, в которых он состоял<br> <code>Get-ADObject –filter {Deleted -eq $True -and ObjectClass -eq "user"} –includeDeletedObjects</code> вывести список удаленных пользователей<br> <code>Restore-ADObject -Identity "3dc33c7c-b912-4a19-b1b7-415c1395a34e"</code> восстановить по значению атрибута ObjectGUID<br> <code>Get-ADObject -Filter 'SAMAccountName -eq "tnas-01"' –IncludeDeletedObjects | Restore-ADObject</code> восстановить по SAMAccountName<br> <code>Get-ADObject -Filter {Deleted -eq $True -and ObjectClass -eq 'group' -and Name -like '*Allow*'} –IncludeDeletedObjects | Restore-ADObject –Verbose</code> восстановить группу или компьютер<h2 id=thumbnailphoto><a aria-label="Anchor link for: thumbnailphoto" class=zola-anchor href=#thumbnailphoto><i class=icon></i></a> thumbnailPhoto</h2><p><code>$photo = [byte[]](Get-Content C:\Install\adm.jpg -Encoding byte)</code> преобразовать файл картинки в массив байтов (jpeg/bmp файл, размером фото до 100 Кб и разрешением 96?96)<br> <code>Set-ADUser support4 -Replace @{thumbnailPhoto=$photo}</code> задать значение атрибута thumbnailPhoto<h2 id=addomaincontroller><a aria-label="Anchor link for: addomaincontroller" class=zola-anchor href=#addomaincontroller><i class=icon></i></a> ADDomainController</h2><p><code>Get-ADDomainController</code> выводит информацию о текущем контроллере домена (LogonServer), который используется данным компьютером для аутентификации (DC выбирается при загрузке в соответствии с топологией сайтов AD)<br> <code>Get-ADDomainController -Discover -Service PrimaryDC</code> найти контроллер с ролью PDC в домене<br> <code>Get-ADDomainController -Filter * | ft HostName,IPv4Address,Name,Site,OperatingSystem,IsGlobalCatalog</code> список все DC, принадлежность к сайту, версии ОС и GC<p>При загрузке ОС служба NetLogon делает DNS запрос со списком контроллеров домена (к SRV записи <em>ldap._tcp.dc._msdcs.domain</em>), DNS возвращает список DC в домене с записью Service Location (SRV). Клиент делает LDAP запрос к DC для определения сайта AD по своему IP адресу. Клиент через DNS запрашивает список контроллеров домена в сайте (в разделе _tcp.sitename._sites…).<p>USN (Update Sequence Numbers) - счетчик номера последовательного обновления, который существует у каждого объекта AD. При репликации контроллеры обмениваются значениями USN, объект с более низким USN будет при репликации перезаписан объектом с более высоким USN. Находится в свойствах - Object (включить View - Advanced Features). Каждый контроллер домена содержит отдельный счетчик USN, который начинает отсчет в момент запуска процесса Dcpromo и продолжает увеличивать значения в течение всего времени существования контроллера домена. Значение счетчика USN увеличивается каждый раз, когда на контроллере домена происходит транзакция, это операции создания, обновления или удаления объекта.<p><code>Get-ADDomainController -Filter * | % {</code> отобразить USN объекта на всех DC в домене<code>Get-ADUser -Server \$\_.HostName -Identity support4  -Properties uSNChanged \| select SamAccountName,uSNChanged</code>}`<p><code>dcpromo /forceremoval</code> принудительно выполнит понижение в роли контроллера домена до уровня рядового сервера. После понижения роли выполняется удаление всех ссылок в домене на этот контроллер. Далее производит включение сервера в состав домена, и выполнение обратного процесса, т.е. повышение сервера до уровня контроллера домена.<h2 id=adcomputer><a aria-label="Anchor link for: adcomputer" class=zola-anchor href=#adcomputer><i class=icon></i></a> ADComputer</h2><p><code>nltest /DSGETDC:$env:userdnsdomain</code> узнать на каком DC аудентифицирован хост (Logon Server)<br> <code>nltest /SC_RESET:$env:userdnsdomain\srv-dc2.$env:userdnsdomain</code> переключить компьютер на другой контроллер домена AD вручную (The command completed successfully)<br> <code>Get-ADComputer –Identity $env:computername -Properties PasswordLastSet</code> время последней смены пароля на сервере<br> <code>Test-ComputerSecureChannel –verbose</code> проверить доверительные отношения с доменом (соответствует ли локальный пароль компьютера паролю, хранящемуся в AD)<br> <code>Reset-ComputerMachinePassword -Credential domain\admin</code> принудительно обновить пароль<br> <code>Netdom ResetPWD /Server:dc-01 /UserD:domain\admin /PasswordD:*</code> сбросить хэш пароля компьютера в домене (перезагрузка не требуется)<br> <code>Search-ADAccount -AccountDisabled -ComputersOnly | select Name,LastLogonDate,Enabled</code> отобразить все отключенные компьютеры<p><code>Get-ADComputer -Filter * -Properties * | select name</code> список всех компьютеров в домене (Filter), вывести все свойства (Properties)<br> <code>Get-ADComputer -Identity $srv -Properties * | ft Name,LastLogonDate,PasswordLastSet,ms-Mcs-AdmPwd -Autosize</code> конкретного компьютера в AD (Identity)<br> <code>Get-ADComputer -SearchBase "OU=Domain Controllers,DC=$d1,DC=$d2" -Filter * -Properties * | ft Name, LastLogonDate, distinguishedName -Autosize</code> поиск в базе по DN (SearchBase)<p><code>(Get-ADComputer -Filter {enabled -eq "true"}).count</code> получить общее количество активных (незаблокированных) компьютеров<br> <code>(Get-ADComputer -Filter {enabled -eq "true" -and OperatingSystem -like "*Windows Server 2016*"}).count</code> кол-во активных копьютеров с ОС WS 2016<p><code>Get-ADComputer -Filter * -Properties * | select @{Label="Ping Status"; Expression={</code><br> <code>$ping = ping -n 1 -w 50 $_.Name</code><br> <code>if ($ping -match "TTL") {"Online"} else {"Offline"}</code><br> <code>}},</code><br> <code>@{Label="Status"; Expression={</code><br> <code>if ($_.Enabled -eq "True") {$_.Enabled -replace "True","Active"} else {$_.Enabled -replace "False","Blocked"}</code><br> <code>}}, Name, IPv4Address, OperatingSystem, @{Label="UserOwner"; Expression={$_.ManagedBy -replace "(CN=|,.+)"}</code><br> <code>},Created | Out-GridView</code><h2 id=aduser><a aria-label="Anchor link for: aduser" class=zola-anchor href=#aduser><i class=icon></i></a> ADUser</h2><p><code>Get-ADUser -Identity support4 -Properties *</code> список всех атрибутов<br> <code>Get-ADUser -Identity support4 -Properties DistinguishedName, EmailAddress, Description</code> путь DN, email и описание<br> <code>Get-ADUser -Filter {(Enabled -eq "True") -and (mail -ne "null")} -Properties mail | ft Name,mail</code> список активных пользователей и есть почтовый ящик<br> <code>Get-ADUser -Filter {SamAccountName -like "*"} | Measure-Object</code> посчитать кол-во всех аккаунтов (Count)<br> <code>Get-ADUser -Filter * -Properties WhenCreated | sort WhenCreated | ft Name, whenCreated</code> дата создания<br> <code>Get-ADUser -Identity support4 -property LockedOut | select samaccountName,Name,Enabled,Lockedout</code><br> <code>Enabled=True</code> учетная запись включена - да<br> <code>Lockedout=False</code> учетная запись заблокирована (например, политикой паролей) - нет<br> <code>Get-ADUser -Identity support4 | Unlock-ADAccount</code> разблокировать учетную запись<br> <code>Disable-ADAccount -Identity support4</code> отключить учетную запись<br> <code>Enable-ADAccount -Identity support4</code> включить учетную запись<br> <code>Search-ADAccount -LockedOut</code> найти все заблокированные учетные записи<br> <code>Search-ADAccount -AccountDisabled | select Name,LastLogonDate,Enabled</code> отобразить все отключенные учетные записи с временем последнего входа<p><code>Get-ADUser -Identity support4 -Properties PasswordLastSet,PasswordExpired,PasswordNeverExpires</code><br> <code>PasswordLastSet</code> время последней смены пароля<br> <code>PasswordExpired=False</code> пароль истек - нет<br> <code>PasswordNeverExpires=True</code> срок действия пароля не истекает - да<br> <code>Set-ADAccountPassword support4 -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "password" -Force -Verbose)</code> изменить пароль учетной записи<br> <code>Set-ADUser -Identity support4 -ChangePasswordAtLogon $True</code> смена пароля при следующем входе в систему<p><code>$day = (Get-Date).adddays(-90)</code><br> <code>Get-ADUser -filter {(passwordlastset -le $day)} | ft</code> пользователи, которые не меняли свой пароль больше 90 дней<p><code>$day = (Get-Date).adddays(-30)</code><br> <code>Get-ADUser -filter {(Created -ge $day)} -Property Created | select Name,Created</code> Новые пользователи за 30 дней<p><code>$day = (Get-Date).adddays(-360)</code><br> <code>Get-ADUser -Filter {(LastLogonTimestamp -le $day)} -Property LastLogonTimestamp | select Name,SamAccountName,@{n='LastLogonTimestamp';e={[DateTime]::FromFileTime($_.LastLogonTimestamp)}} | sort -Descending LastLogonTimestamp</code> пользователи, которые не логинились больше 360 дней. Репликация атрибута LastLogonTimestamp составляет от 9 до 14 дней.<br> <code>| Disable-ADAccount $_.SamAccountName</code> заблокировать<br> <code>-WhatIf</code> отобразить вывод без применения изменений<h2 id=adgroupmember><a aria-label="Anchor link for: adgroupmember" class=zola-anchor href=#adgroupmember><i class=icon></i></a> ADGroupMember</h2><p><code>(Get-ADUser -Identity support4 -Properties MemberOf).memberof</code> список групп в которых состоит пользователь<br> <code>Get-ADGroupMember -Identity "Domain Admins" | Select Name,SamAccountName</code> список пользователей в группе<br> <code>Add-ADGroupMember -Identity "Domain Admins" -Members support5</code> добавить в группу<br> <code>Remove-ADGroupMember -Identity "Domain Admins" -Members support5 -force</code> удалить из группы<br> <code>Get-ADGroup -filter * | where {!($_ | Get-ADGroupMember)} | Select Name</code> отобразить список пустых групп (-Not)<h2 id=adreplication><a aria-label="Anchor link for: adreplication" class=zola-anchor href=#adreplication><i class=icon></i></a> ADReplication</h2><p><code>Get-Command -Module ActiveDirectory -Name *Replication*</code> список всех командлетов модуля<br> <code>Get-ADReplicationFailure -Target dc-01</code> список ошибок репликации с партнерами<br> <code>Get-ADReplicationFailure -Target $env:userdnsdomain -Scope Domain</code><br> <code>Get-ADReplicationPartnerMetadata -Target dc-01 | select Partner,LastReplicationAttempt,LastReplicationSuccess,LastReplicationResult,LastChangeUsn</code> время последней и время успешной репликации с партнерами<br> <code>Get-ADReplicationUpToDatenessVectorTable -Target dc-01</code> Update Sequence Number (USN) увеличивается каждый раз, когда на контроллере домена происходит транзакция (операции создания, обновления или удаления объекта), при репликации DC обмениваются значениями USN, объект с более низким USN при репликации будет перезаписан высоким USN.<h2 id=repadmin><a aria-label="Anchor link for: repadmin" class=zola-anchor href=#repadmin><i class=icon></i></a> repadmin</h2><p><code>repadmin /replsummary</code> отображает время последней репликации на всех DC по направлению (Source и Destination) и их состояние с учетом партнеров<br> <code>repadmin /showrepl $srv</code> отображает всех партнеров по реплкации и их статус для всех разделов Naming Contexts (DC=ForestDnsZones, DC=DomainDnsZones, CN=Schema, CN=Configuration)<br> <code>repadmin /replicate $srv2 $srv1 DC=domain,DC=local</code> выполнить репликацию с $srv1 на $srv2 только указанный раздела домена<br> <code>repadmin /SyncAll /AdeP</code> запустить межсайтовую исходящую репликацию всех разделов от текущего сервера со всеми партнерами по репликации<br> <code>/A</code> выполнить для всех разделов NC<br> <code>/d</code> в сообщениях идентифицировать серверы по DN (вместо GUID DNS - глобальным уникальным идентификаторам)<br> <code>/e</code> межсайтовая синхронизация (по умолчанию синхронизирует только с DC текущего сайта)<br> <code>/P</code> извещать об изменениях с этого сервера (по умолчанию: опрашивать об изменениях)<br> <code>repadmin /Queue $srv</code> отображает кол-во запросов входящей репликации (очередь), которое необходимо обработать (причиной может быть большое кол-во партнеров или формирование 1000 объектов скриптом)<br> <code>repadmin /showbackup *</code> узнать дату последнего Backup<p><code>Error: 1722</code> сервер rpc недоступен (ошибка отката репликации). Проверить имя домена в настройках сетевого адаптера, первым должен идти адрес DNS-сервера другого контроллера домена, вторым свой адрес.<br> <code>Get-Service -ComputerName $srv | select name,status | ? name -like "RpcSs"</code><br> <code>Get-Service -ComputerName $srv -Name RpcSs -RequiredServices</code> зависимые службы<br> Зависимые службы RPC:<br> “Служба сведений о подключенных сетях” - должен быть включен отложенный запуск. Если служба срабатывает до “службы списка сетей”, может падать связь с доменом (netlogon)<br> “Центр распространения ключей Kerberos”<br> “DNS-сервер”<br> <code>nslookup $srv</code><br> <code>tnc $srv -p 135</code><br> <code>repadmin /retry</code> повторить попытку привязки к целевому DC, если была ошибка 1722 или 1753 (RPC недоступен)<p><code>repadmin /showrepl $srv</code><br> <code>Last attempt @ 2022-07-15 10:46:01 завершена с ошибкой, результат 8456 (0x2108)</code> при проверки showrepl этого партнера, его ошибка: 8457 (0x2109)<br> <code>Last success @ 2022-07-11 02:29:46</code> последний успех<br> Когда репликация автоматически отключена, ОС записывает в DSA - not writable одно из четырех значений:<br> <code>Path: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\NTDS\Parameters</code><br> <code>Dsa Not Writable</code><br> <code>##define DSA_WRITABLE_GEN 1</code> версия леса несовместима с ОС<br> <code>##define DSA_WRITABLE_NO_SPACE 2</code> на диске, где размещена база данных Active Directory или файлы журналов (логи), недостаточно свободного места<br> <code>##define DSA_WRITABLE_USNROLLBCK 4</code> откат USN произошел из-за неправильного отката базы данных Active Directory во времени (восстановление из снапшота)<br> <code>##define DSA_WRITABLE_CORRUPT_UTDV 8</code> вектор актуальности поврежден на локальном контроллере домена<h2 id=dcdiag><a aria-label="Anchor link for: dcdiag" class=zola-anchor href=#dcdiag><i class=icon></i></a> dcdiag</h2><p><code>dcdiag /s:&LTDomainController> [/n:&LTNamingContext>] [[/u:&LTdomain\user>] [/p:&LTpassword>]] [{/a|/e}{/q|/v}] [/f:&LTLogFile>] [/ferr:&LTErrorLog>] [/test:&LTtest>] [/fix]</code><br> <code>dcdiag /Test:replications /s:dc-01</code> отображает ошибки репликации<br> <code>dcdiag /Test:DNS /e /v /q</code> тест DNS<br> <code>/a</code> проверка всех серверов данного сайта<br> <code>/e</code> проверка всех серверов предприятия<br> <code>/q</code> выводить только сообщения об ошибках<br> <code>/v</code> выводить подробную информацию<br> <code>/fix</code> автоматически исправляет ошибки<br> <code>/test:</code><br> <code>NetLogons</code> проверка наличие прав на выполнение репликации<br> <code>Connectivity</code> проверяет регистрацию DNS для каждого контроллера домена, отправляет тестовый эхо-пакет на каждый контроллер домена и проверяет подключение по протоколам LDAP и RPC к каждому контроллеру домена<br> <code>Services</code> проверяет работоспособность всех служб, необходимых для работы контроллера домена, на указанном контроллере домена<br> <code>Systemlog</code> проверяет наличие ошибок в журналах контроллера домена<br> <code>FRSEvent</code> проверяет ошибки репликации в работе службы репликации файлов, что может означать наличие проблем в репликации SYSVOL и, таким образом, целостности копий объектов групповых политик<br> <code>FSMOCheck</code> не проверяет роли хозяев операций, а вместо этого запрашивает сервер глобального каталога, первичный контроллер домена, предпочтительный сервер времени, сервер времени и центр распространения ключей (контроллер домена может подключиться к KDC, PDC, серверу глобального каталога)<br> <code>KnowsOfRoleHolders</code> пgроверяет возможность подключения контроллеров домена ко всем пяти хозяевам операций (ролями FSMO)<br> <code>MachineAccount</code> проверяет правильность регистрации учетной записи целевого компьютера и правильность объявлений служб этого компьютера (корректность доверительных отношения с доменом). Если обнаружена ошибка, ее можно исправить с помощью утилиты dcdiag, указав параметры /fixmachineaccount или /recreatemachineaccount<br> <code>Advertising</code> проверяет, правильно ли контроллер домена сообщает о себе и о своей роли хозяина операций. Этот тест завершиться неудачно, если служба NetLogon не запущена<br> <code>CheckSDRefDom</code> проверяет правильность доменов ссылок дескрипторов безопасности для каждого раздела каталогов программ<br> <code>CrossRefValidation</code> проверяет правильность перекрестных ссылок для доменов<br> <code>RRSSysvol</code> проверяет состояние готовности для FRS SYSVOL<br> <code>Intersite</code> проверяет наличие ошибок, которые могут помешать нормальной репликации между сайтами. Компания Microsoft предупреждает, что иногда результаты этого теста могут оказаться неточными<br> <code>KCCEvent</code> проверяет безошибочность создания объектов соединений для репликации между сайтами<br> <code>NCSecDesc</code> проверяет правильность разрешений для репликации в дескрипторах безопасности для заголовков контекста именования<br> <code>ObjectsReplicated</code> проверяет правильность репликации агента сервера каталогов и объектов учетных записей компьютеров<br> <code>OutboundSecureChannels</code> проверяется наличие безопасных каналов между всеми контроллерами домена в интересующем домене<br> <code>Replications</code> проверяет возможность репликации между контроллерами домена и сообщает обо всех ошибках при репликации<br> <code>RidManager</code> проверяет работоспособность и доступность хозяина относительных идентификаторов<br> <code>VerifyEnterpriseReferences</code> проверяет действительность системных ссылок службы репликации файлов для всех объектов на всех контроллерах домена в лесу<br> <code>VerifyReferences</code> проверяет действительность системных ссылок службы репликации файлов для всех объектов на указанном контроллере домена<br> <code>VerifyReplicas</code> проверяет действительность всех разделов каталога приложения на всех серверах, принимающих участие в репликации<h2 id=ntdsutil><a aria-label="Anchor link for: ntdsutil" class=zola-anchor href=#ntdsutil><i class=icon></i></a> ntdsutil</h2><p>Перенос БД AD (ntds.dit):<br> <code>Get-Acl C:\Windows\NTDS | Set-Acl D:\AD-DB</code> скопировать NTFS разрешения на новый каталог<br> <code>Stop-Service -ComputerName dc -name NTDS</code> остановить службу Active Directory Domain Services<br> <code>ntdsutil</code> запустить утилиту ntdsutil<br> <code>activate instance NTDS</code> выбрать активный экземпляр базы AD<br> <code>files</code> перейдем в контекст files, в котором возможно выполнение операция с файлами базы ntds.dit<br> <code>move DB to D:\AD-DB\</code> перенести базу AD в новый каталог (предварительно нужно его создать)<br> <code>info</code> проверить, что БД находится в новом каталоге<br> <code>move logs to D:\AD-DB\</code> переместим в тот же каталог файлы с журналами транзакций<br> <code>quit</code><br> <code>Start-Service -ComputerName dc -name NTDS</code><p>Сброс пароля DSRM (режим восстановления служб каталогов):<br> <code>ntdsutil</code><br> <code>set dsrm password</code><br> <code>reset password on server NULL</code><br> новый пароль<br> подтверждение пароля<br> <code>quit</code><br> <code>quit</code><p>Синхронизировать с паролем УЗ в AD:<br> <code>ntdsutil</code><br> <code>set dsrm password</code><br> <code>sync from domain account dsrmadmin</code><br> <code>quit</code><br> <code>quit</code><p>Ошибка 0x00002e2 при загрузке ОС.<br> Загрузиться в режиме восстанавления WinRE (Windows Recovery Environment) - Startup Settings - Restart - DSRM (Directory Services Restore Mode)<br> <code>reagentc /boottore</code> shutdown /f /r /o /t 0 перезагрузка в режиме WinRE - ОС на базе WinPE (Windows Preinstallation Environment), образ winre.wim находится на скрытом разделе System Restore<br> На контроллере домена единственная локальная учетная запись — администратор DSRM. Пароль создается при установке роли контроллера домена ADDS на сервере (SafeModeAdministratorPassword).<br> <code>ntdsutil</code><br> <code>activate instance ntds</code><br> <code>Files</code><br> <code>Info</code><br> <code>integrity</code> проверить целостность БД<br> Ошибка: Failed to open DIT for AD DS/LDS instance NTDS. Error -2147418113<br> <code>mkdir c:\ntds_bak</code><br> <code>xcopy c:\Windows\NTDS\*.* c:\ntds_bak</code> backup содержимого каталога с БД<br> <code>esentutl /g c:\windows\ntds\ntds.dit</code> проверим целостность файла<br> Вывод: Integrity check completed. Database is CORRUPTED ошибка, база AD повреждена<br> <code>esentutl /p c:\windows\ntds\ntds.dit</code> исправить ошибки<br> Вывод: Operation completed successfully in xx seconds. нет ошибок<br> <code>esentutl /g c:\windows\ntds\ntds.dit</code> проверим целостность файла<br> Выполнить анализ семантики базы с помощью ntdsutil:<br> <code>ntdsutil</code><br> <code>activate instance ntds</code><br> <code>semantic database analysis</code><br> <code>go</code><br> <code>go fixup</code> исправить семантические ошибки<br> Сжать файл БД:<br> <code>activate instance ntds</code><br> <code>files</code><br> <code>compact to C:\Windows\NTDS\TEMP</code><br> <code>copy C:\Windows\NTDS\TEMP\ntds.dit C:\Windows\NTDS\ntds.dit</code> заменить оригинальный файл ntds.dit<br> <code>Del C:\Windows\NTDS\*.log</code> удалить все лог файлы из каталога NTDS<h2 id=gpo><a aria-label="Anchor link for: gpo" class=zola-anchor href=#gpo><i class=icon></i></a> GPO</h2><p><code>Get-Command -Module GroupPolicy</code><br> <code>Get-GPO -Domain domain.local -All | ft</code><br> <code>Get-GPO -Name LAPS</code><br> <code>[xml](Get-GPOReport LAPS -ReportType Xml)</code><br> <code>Get-GPPermission -Name LAPS -All</code><br> <code>Get-GPO LAPS | New-GPLink -Target "ou=servers,dc=domain,dc=local"</code><br> <code>Set-GPLink -Name LAPS -Target "ou=servers,dc=domain,dc=local" -LinkEnabled No</code><br> <code>Backup-GPO -Name LAPS -Path "$home\Desktop"</code><br> <code>Backup-GPO -All -Path "$home\Desktop"</code><br> <code>Restore-GPO -Name LAPS -Path C:\Backup\GPOs\</code></p><span class=hidden id=copy-code-text>Copy Code</span><span class=hidden id=search-index>https://lifailon.github.io/search_index.en.json</span><span class=hidden id=more-matches-text>$MATCHES more matches</span></main><footer id=site-footer><nav><ul><li><a href=https://lifailon.github.io/syntax/>PowerShell Syntax</a><li><a href=https://lifailon.github.io/filesystem/>File System</a><li><a href=https://lifailon.github.io/windows/>Operating System</a><li><a href=https://lifailon.github.io/network/>Network</a><li><a href=https://lifailon.github.io/threads/>Threads</a><li><a href=https://lifailon.github.io/modules/>Modules</a><li><a href=https://lifailon.github.io/dotnet/>dotNET</a><li><a href=https://lifailon.github.io/com/>COM</a><li><a href=https://lifailon.github.io/servermanager/>Server Manager</a><li><a class=active href=https://lifailon.github.io/activedirectory/>Active Directory</a><li><a href=https://lifailon.github.io/exchange/>Exchange</a><li><a href=https://lifailon.github.io/virtualization/>Virtualization</a><li><a href=https://lifailon.github.io/database/>Database</a><li><a href=https://lifailon.github.io/markuplanguages/>Markup Languages</a><li><a href=https://lifailon.github.io/api/>API</a><li><a href=https://lifailon.github.io/zabbix/>Zabbix</a><li><a href=https://lifailon.github.io/devops/>DevOps</a><li><a href=https://lifailon.github.io/docker/>Docker</a><li><a href=https://lifailon.github.io/linux/>Linux</a><li><a href=https://lifailon.github.io/node-js/>Node.js</a></ul></nav><p>© <strong>2023-2024</strong> <code>Lifailon</code><p><small>Powered by <a class="link external" href=https://www.getzola.org>Zola</a> and <a class="link external" href=https://duckquill.daudix.one>Duckquill</a> </small><ul id=socials><li><a rel=" me" href=https://github.com title=GitHub> <i style="--icon:url(&#34data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EGitHub%3C/title%3E%3Cpath d='M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12'/%3E%3C/svg%3E&#34)" class=icon></i> <span>GitHub</span> </a></ul></footer>