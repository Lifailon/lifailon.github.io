<!DOCTYPE html>
<html lang="en-us">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.123.8">

    

    

    
        
            <meta
                name="description"
                content="Large base of PowerShell notes in Russian language" />
        

        
            <meta
                name="keywords"
                content="PowerShell" />
        

        
            <meta name="author" content="Lifailon" />
        

    


    <title>
        
            Network |
            Lifailon.GitHub.io
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_d751713.min.912d03bce61461ecbc3ca083479e1ed814bba94df76d0bdc6aa88fdca33621b9bb410dc2c81af31e8101fec62decfa5f6e48901ad673bc5056d2f1d1f2368a34.css"
            integrity="sha512-kS0DvOYUYey8PKCDR54e2BS7qU33bQvcaqiP3KM2Ibm7QQ3CyBrzHoEB/sYt7PpfbkiQGtZzvFBW0vHR8jaKNA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            Network -
            Lifailon.GitHub.io
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/powershell/" title="./powershell/">
                        PowerShell
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/dotnet/" title="./dotnet/">
                        .NET
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/activedirectory/" title="./activedirectory/">
                        Active Directory
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/ansible/" title="./ansible/">
                        Ansible
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/apps/" title="./apps/">
                        Apps
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/com/" title="./com/">
                        Component Object Model
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/git/" title="./git/">
                        Git
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/html/" title="./html/">
                        HTML
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/influxdb/" title="./influxdb/">
                        InfluxDB
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/exchange/" title="./exchange/">
                        MS Exchange
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/mssql/" title="./mssql/">
                        MS SQL
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/mysql/" title="./mysql/">
                        MySQL
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/network/" title="./network/">
                        Network
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/api/" title="./api/">
                        REST API
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/virtualization/" title="./virtualization/">
                        Virtualization
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/wmi/" title="./wmi/">
                        WMI
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/zabbix/" title="./zabbix/">
                        Zabbix
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                Network
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/lifailon/"
                                class="cat-btn">
                                Lifailon
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="Mar 14 2024"
                            >Mar 14 2024
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        18 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    




<a href="https://lifailon.github.io/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://lifailon.github.io/network/" class="bread-btn">
    

    
        Network
    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#network">Network</a>
      <ul>
        <li><a href="#ping">ping</a></li>
        <li><a href="#dhcp">dhcp</a></li>
        <li><a href="#port">port</a></li>
        <li><a href="#nslookup">nslookup</a></li>
        <li><a href="#ipconfig">ipconfig</a></li>
        <li><a href="#adapter">Adapter</a></li>
        <li><a href="#dnsclient">DNSClient</a></li>
        <li><a href="#dnscache">DNSCache</a></li>
        <li><a href="#binding">Binding</a></li>
        <li><a href="#tcpsetting">TCPSetting</a></li>
        <li><a href="#netstat">netstat</a></li>
        <li><a href="#statistics">Statistics</a></li>
        <li><a href="#hostname">hostname</a></li>
        <li><a href="#arp">arp</a></li>
      </ul>
    </li>
    <li><a href="#firewall">Firewall</a>
      <ul>
        <li><a href="#firewall-manager">Firewall-Manager</a></li>
      </ul>
    </li>
    <li><a href="#rdp">RDP</a>
      <ul>
        <li><a href="#ipban">IPBan</a></li>
      </ul>
    </li>
    <li><a href="#smtp">SMTP</a></li>
    <li><a href="#snmp">SNMP</a>
      <ul>
        <li><a href="#setup-snmp-service">Setup SNMP Service</a></li>
        <li><a href="#setting-snmp-service-via-regedit">Setting SNMP Service via Regedit</a></li>
        <li><a href="#snmpwalk">snmpwalk</a></li>
        <li><a href="#snmp-modules">SNMP Modules</a></li>
        <li><a href="#lextmsharpsnmplib">Lextm.SharpSnmpLib</a></li>
        <li><a href="#walk">Walk</a></li>
      </ul>
    </li>
    <li><a href="#pki">pki</a></li>
    <li><a href="#openssl">OpenSSL</a></li>
    <li><a href="#openvpn">OpenVPN</a>
      <ul>
        <li><a href="#serverovpn">server.ovpn</a></li>
        <li><a href="#clientovpn">client.ovpn</a></li>
        <li><a href="#client">Client</a></li>
      </ul>
    </li>
    <li><a href="#route">Route</a></li>
    <li><a href="#nat">NAT</a></li>
    <li><a href="#wireguard">WireGuard</a></li>
    <li><a href="#vpnclient">VpnClient</a></li>
    <li><a href="#proxy">Proxy</a></li>
    <li><a href="#netsh">netsh</a>
      <ul>
        <li><a href="#proxy-1">Proxy</a></li>
        <li><a href="#wlan">Wlan</a></li>
        <li><a href="#firewall-1">Firewall</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#winrm">WinRM</a>
      <ul>
        <li><a href="#windows-remote-management-configuration">Windows Remote Management Configuration</a></li>
        <li><a href="#kerberos">Kerberos</a></li>
      </ul>
    </li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="network">Network</h2>
<h3 id="ping">ping</h3>
<p><code>Test-Connection -Count 1 $srv1, $srv2</code> отправить icmp-пакет двум хостам <br>
<code>Test-Connection $srv -ErrorAction SilentlyContinue</code> не выводить ошибок, если хост не отвечает <br>
<code>Test-Connection -Source $srv1 -ComputerName $srv2</code> пинг с удаленного компьютера</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="function%20Test-PingNetwork%20%7b%0d%0aparam%20%28%0d%0a%20%20%20%20[Parameter%28Mandatory,ValueFromPipeline%29][string[]]$Network,%0d%0a%20%20%20%20[ValidateRange%28100,10000%29][int]$Timeout%20=%20100%0d%0a%29%0d%0a$ping%20=%20New-Object%20System.Net.NetworkInformation.Ping%0d%0a$Network%20%20=%20$Network%20-replace%20%220$%22%0d%0a$net%20=%20@%28%29%0d%0aforeach%20%28$r%20in%20@%281..254%29%29%20%7b%0d%0a%20%20%20%20$net%20&#43;=%20%22$network$r%22%0d%0a%7d%0d%0aforeach%20%28$n%20in%20$net%29%20%7b%0d%0a%20%20%20%20$ping.Send%28$n,%20$timeout%29%20%7c%20select%20@%7bName=%22Address%22;%20Expression=%7b$n%20-replace%20%22.&#43;%5c.%22%7d%7d,%20Status%0d%0a%7d%0d%0a%7d">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Test-PingNetwork {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> (
</span></span><span style="display:flex;"><span>    [Parameter(<span style="color:#a6e22e">Mandatory</span>,<span style="color:#a6e22e">ValueFromPipeline</span>)][<span style="color:#66d9ef">string[]</span>]$Network,
</span></span><span style="display:flex;"><span>    [ValidateRange(<span style="color:#ae81ff">100</span>,<span style="color:#ae81ff">10000</span>)][<span style="color:#66d9ef">int</span>]$Timeout = <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>$ping = New-Object System.Net.NetworkInformation.Ping
</span></span><span style="display:flex;"><span>$Network  = $Network <span style="color:#f92672">-replace</span> <span style="color:#e6db74">&#34;0$&#34;</span>
</span></span><span style="display:flex;"><span>$net = @()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($r <span style="color:#66d9ef">in</span> @(<span style="color:#ae81ff">1</span>.<span style="color:#ae81ff">.254</span>)) {
</span></span><span style="display:flex;"><span>    $net += <span style="color:#e6db74">&#34;</span>$network$r<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($n <span style="color:#66d9ef">in</span> $net) {
</span></span><span style="display:flex;"><span>    $ping.Send($n, $timeout) | select @{Name=<span style="color:#e6db74">&#34;Address&#34;</span>; Expression={$n <span style="color:#f92672">-replace</span> <span style="color:#e6db74">&#34;.+\.&#34;</span>}}, Status
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p><code>Test-PingNetwork -Network 192.168.3.0</code> <br>
<code>Test-PingNetwork -Network 192.168.3.0 -Timeout 1000</code></p>
<p><code>Get-CimInstance -Class Win32_PingStatus -Filter &quot;Address='127.0.0.1'&quot;</code> <br>
<code>Get-CimInstance -Class Win32_PingStatus -Filter &quot;Address='127.0.0.1'&quot; | Format-Table -Property Address,ResponseTime,StatusCode -Autosize</code> 0 - успех <br>
<code>'127.0.0.1','8.8.8.8' | ForEach-Object -Process {Get-CimInstance -Class Win32_PingStatus -Filter (&quot;Address='$_'&quot;) | Select-Object -Property Address,ResponseTime,StatusCode}</code> <br>
<code>$ips = 1..254 | ForEach-Object -Process {'192.168.1.' + $_}</code> сформировать массив из ip-адресов подсети</p>
<h3 id="dhcp">dhcp</h3>
<p><code>Get-CimInstance -Class Win32_NetworkAdapterConfiguration -Filter &quot;DHCPEnabled=$true&quot;</code> отобразить адаптеры с включенным DHCP <br>
<code>$wql = 'SELECT * from Win32_NetworkAdapterConfiguration WHERE IPEnabled=True and DHCPEnabled=False'</code> <br>
<code>Invoke-CimMethod -MethodName ReleaseDHCPLease -Query $wql</code> включение DHCP на всех адаптерах <br>
<code>Invoke-CimMethod -ClassName Win32_NetworkAdapterConfiguration -MethodName ReleaseDHCPLeaseAll</code> отменить аренду адресов DHCP на всех адаптерах <br>
<code>Invoke-CimMethod -ClassName Win32_NetworkAdapterConfiguration -MethodName RenewDHCPLeaseAll</code> обновить аренду адресов DHCP на всех адаптерах</p>
<h3 id="port">port</h3>
<p><code>tnc $srv -p 5985</code> <br>
<code>tnc $srv -CommonTCPPort WINRM</code> HTTP,RDP,SMB <br>
<code>tnc ya.ru –TraceRoute -Hops 2</code> TTL=2 <br>
<code>tnc ya.ru -DiagnoseRouting</code> маршрутизация до хоста, куда (DestinationPrefix: 0.0.0.0/0) через (NextHop: 192.168.1.254)</p>
<h3 id="nslookup">nslookup</h3>
<p><code>nslookup ya.ru 1.1.1.1</code> с указанием DNS сервера <br>
<code>nslookup -type=any ya.ru</code> указать тип записи <br>
<code>Resolve-DnsName ya.ru -Type MX</code> ALL,ANY,A,NS,SRV,CNAME,PTR,TXT(spf) <br>
<code>[System.Net.Dns]::GetHostEntry(&quot;ya.ru&quot;)</code></p>
<h3 id="ipconfig">ipconfig</h3>
<p><code>Get-NetIPConfiguration</code> <br>
<code>Get-NetIPConfiguration -InterfaceIndex 14 -Detailed</code></p>
<h3 id="adapter">Adapter</h3>
<p><code>Get-NetAdapter</code> <br>
<code>Set-NetIPInterface -InterfaceIndex 14 -Dhcp Disabled</code> отключить DHCP <br>
<code>Get-NetAdapter -InterfaceIndex 14 | New-NetIPAddress –IPAddress 192.168.3.99 -DefaultGateway 192.168.3.1 -PrefixLength 24</code> задать/добавить статический IP-адрес <br>
<code>Set-NetIPAddress -InterfaceIndex 14 -IPAddress 192.168.3.98</code> изменить IP-адреас на адаптере <br>
<code>Remove-NetIPAddress -InterfaceIndex 14 -IPAddress 192.168.3.99</code> удалить IP-адрес на адаптере <br>
<code>Set-NetIPInterface -InterfaceIndex 14 -Dhcp Enabled</code> включить DHCP</p>
<h3 id="dnsclient">DNSClient</h3>
<p><code>Get-DNSClientServerAddress</code> <br>
<code>Set-DNSClientServerAddress -InterfaceIndex 14 -ServerAddresses 8.8.8.8</code></p>
<h3 id="dnscache">DNSCache</h3>
<p><code>Get-DnsClientCache</code> отобразить кэшированные записи клиента DNS <br>
<code>Clear-DnsClientCache</code> очистить кэш</p>
<h3 id="binding">Binding</h3>
<p><code>Get-NetAdapterBinding -Name Ethernet -IncludeHidden -AllBindings</code> <br>
<code>Get-NetAdapterBinding -Name &quot;Беспроводная сеть&quot; -DisplayName &quot;IP версии 6 (TCP/IPv6)&quot; | Set-NetAdapterBinding -Enabled $false</code> отключить IPv6 на адаптере</p>
<h3 id="tcpsetting">TCPSetting</h3>
<p><code>Get-NetTCPSetting</code> <br>
<code>Set-NetTCPSetting -SettingName DatacenterCustom,Datacenter -CongestionProvider DCTCP</code> <br>
<code>Set-NetTCPSetting -SettingName DatacenterCustom,Datacenter -CwndRestart True</code> <br>
<code>Set-NetTCPSetting -SettingName DatacenterCustom,Datacenter -ForceWS Disabled</code></p>
<h3 id="netstat">netstat</h3>
<p><code>netstat -anop tcp</code> -n/-f/-b <br>
<code>Get-NetTCPConnection -State Established,Listen | ? LocalPort -Match 3389</code> <br>
<code>Get-NetTCPConnection -State Established,Listen | ? RemotePort -Match 22</code> <br>
<code>Get-NetUDPEndpoint | ? LocalPort -Match 514</code> netstat -ap udp`</p>
<h3 id="statistics">Statistics</h3>
<p><code>netstat -se</code> <br>
<code>Get-NetAdapterStatistics</code></p>
<h3 id="hostname">hostname</h3>
<p><code>$env:computername</code> <br>
<code>hostname.exe</code> <br>
<code>(Get-CIMInstance CIM_ComputerSystem).Name</code> <br>
<code>(New-Object -ComObject WScript.Network).ComputerName</code> <br>
<code>[System.Environment]::MachineName</code> <br>
<code>[System.Net.Dns]::GetHostName()</code></p>
<h3 id="arp">arp</h3>
<p><code>ipconfig /all | Select-String &quot;физ&quot;</code> grep <br>
<code>Get-NetNeighbor -AddressFamily IPv4</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Get-ARP {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Param</span> (
</span></span><span style="display:flex;"><span>$proxy,
</span></span><span style="display:flex;"><span>$search
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (!$proxy) {
</span></span><span style="display:flex;"><span>$arp = arp -a
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($proxy) {
</span></span><span style="display:flex;"><span>$arp = icm $proxy {arp -a}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$mac = $arp[<span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">.260</span>]
</span></span><span style="display:flex;"><span>$mac = $mac <span style="color:#f92672">-replace</span> <span style="color:#e6db74">&#34;^\s\s&#34;</span>
</span></span><span style="display:flex;"><span>$mac = $mac <span style="color:#f92672">-replace</span> <span style="color:#e6db74">&#34;\s{1,50}&#34;</span>,<span style="color:#e6db74">&#34; &#34;</span>
</span></span><span style="display:flex;"><span>$mac_coll = New-Object System.Collections.Generic.List[<span style="color:#66d9ef">System.Object</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($m <span style="color:#66d9ef">in</span> $mac) {
</span></span><span style="display:flex;"><span>$smac = $m -split <span style="color:#e6db74">&#34; &#34;</span>
</span></span><span style="display:flex;"><span>$mac_coll.Add([<span style="color:#66d9ef">PSCustomObject</span>]@{
</span></span><span style="display:flex;"><span>IP = $smac[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>MAC = $smac[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>Type = $smac[<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($search) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($search <span style="color:#f92672">-NotMatch</span> <span style="color:#e6db74">&#34;\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}&#34;</span>) {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#$ns = nslookup $search</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#$ns = $ns[-2]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#$global:ns = $ns -replace &#34;Address:\s{1,10}&#34;</span>
</span></span><span style="display:flex;"><span>$rdns = Resolve-DnsName $search -ErrorAction Ignore
</span></span><span style="display:flex;"><span>$ns = $rdns.IPAddress
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($ns <span style="color:#f92672">-eq</span> $null) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>$ns = $search
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$mac_coll = $mac_coll | ? ip <span style="color:#f92672">-Match</span> $ns
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$mac_coll
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p><code>Get-ARP -search 192.168.3.100</code> <br>
<code>Get-ARP -search 192.168.3.100 -proxy dc-01</code></p>
<h2 id="firewall">Firewall</h2>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="$days%20=%205%0d%0a$obj%20=%20@%28%29%0d%0a$fw%20=%20Get-WinEvent%20%22Microsoft-Windows-Windows%20Firewall%20With%20Advanced%20Security/Firewall%22%0d%0aforeach%20%28$temp_fw%20in%20$fw%29%20%7b%0d%0aif%20%28$temp_fw.id%20-eq%202097%29%20%7b%20#%202004%0d%0a%20%20%20%20$type%20=%20%22Added%20Rule%22%0d%0a%7d%0d%0aelseif%20%28$temp_fw.id%20-eq%202006%29%20%7b%0d%0a%20%20%20%20$type%20=%20%22Deleted%20Rule%22%0d%0a%7d%0d%0a$port%20=%20$temp_fw.Properties[7]%20%7c%20select%20-ExpandProperty%20value%0d%0a$name%20=%20$temp_fw.Properties[1]%20%7c%20select%20-ExpandProperty%20value%0d%0a$obj%20&#43;=%20[PSCustomObject]@%7b%0d%0a%20%20%20%20Time%20=%20$temp_fw.TimeCreated;%0d%0a%20%20%20%20Type%20=%20$type;%0d%0a%20%20%20%20Port%20=%20$port;%0d%0a%20%20%20%20Name%20=%20$name%7d%0d%0a%7d%0d%0a$obj%20%7c%20Where-Object%20time%20-gt%20%28Get-Date%29.AddDays%28-$days%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$days = <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>$obj = @()
</span></span><span style="display:flex;"><span>$fw = Get-WinEvent <span style="color:#e6db74">&#34;Microsoft-Windows-Windows Firewall With Advanced Security/Firewall&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($temp_fw <span style="color:#66d9ef">in</span> $fw) {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($temp_fw.id <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">2097</span>) { <span style="color:#75715e"># 2004</span>
</span></span><span style="display:flex;"><span>    $type = <span style="color:#e6db74">&#34;Added Rule&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elseif</span> ($temp_fw.id <span style="color:#f92672">-eq</span> <span style="color:#ae81ff">2006</span>) {
</span></span><span style="display:flex;"><span>    $type = <span style="color:#e6db74">&#34;Deleted Rule&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$port = $temp_fw.Properties[<span style="color:#ae81ff">7</span>] | select -ExpandProperty value
</span></span><span style="display:flex;"><span>$name = $temp_fw.Properties[<span style="color:#ae81ff">1</span>] | select -ExpandProperty value
</span></span><span style="display:flex;"><span>$obj += [<span style="color:#66d9ef">PSCustomObject</span>]@{
</span></span><span style="display:flex;"><span>    Time = $temp_fw.TimeCreated;
</span></span><span style="display:flex;"><span>    Type = $type;
</span></span><span style="display:flex;"><span>    Port = $port;
</span></span><span style="display:flex;"><span>    Name = $name}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$obj | Where-Object time <span style="color:#f92672">-gt</span> (Get-Date).AddDays(-$days)</span></span></code></pre></div>
    
</div>
<p><code>New-NetFirewallRule -Profile Any -DisplayName &quot;Open Port 135 RPC&quot; -Direction Inbound -Protocol TCP -LocalPort 135</code> открыть in-порт <br>
<code>Get-NetFirewallRule | where DisplayName -match kms | select *</code> найти правило по имени <br>
<code>Get-NetFirewallPortFilter | where LocalPort -like 80</code> найти действующие правило по номеру порта</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="Get-NetFirewallRule%20-Enabled%20True%20-Direction%20Inbound%20%7c%20select%20-Property%20DisplayName,%0d%0a@%7bName=%27Protocol%27;Expression=%7b%28$_%20%7c%20Get-NetFirewallPortFilter%29.Protocol%7d%7d,%0d%0a@%7bName=%27LocalPort%27;Expression=%7b%28$_%20%7c%20Get-NetFirewallPortFilter%29.LocalPort%7d%7d,%0d%0a@%7bName=%27RemotePort%27;Expression=%7b%28$_%20%7c%20Get-NetFirewallPortFilter%29.RemotePort%7d%7d,%0d%0a@%7bName=%27RemoteAddress%27;Expression=%7b%28$_%20%7c%20Get-NetFirewallAddressFilter%29.RemoteAddress%7d%7d,%0d%0aEnabled,Profile">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>Get-NetFirewallRule -Enabled True -Direction Inbound | select -Property DisplayName,
</span></span><span style="display:flex;"><span>@{Name=<span style="color:#e6db74">&#39;Protocol&#39;</span>;Expression={($_ | Get-NetFirewallPortFilter).Protocol}},
</span></span><span style="display:flex;"><span>@{Name=<span style="color:#e6db74">&#39;LocalPort&#39;</span>;Expression={($_ | Get-NetFirewallPortFilter).LocalPort}},
</span></span><span style="display:flex;"><span>@{Name=<span style="color:#e6db74">&#39;RemotePort&#39;</span>;Expression={($_ | Get-NetFirewallPortFilter).RemotePort}},
</span></span><span style="display:flex;"><span>@{Name=<span style="color:#e6db74">&#39;RemoteAddress&#39;</span>;Expression={($_ | Get-NetFirewallAddressFilter).RemoteAddress}},
</span></span><span style="display:flex;"><span>Enabled,Profile</span></span></code></pre></div>
    
</div>
<h3 id="firewall-manager">Firewall-Manager</h3>
<p><code>Install-Module Firewall-Manager</code> <br>
<code>Export-FirewallRules -Name * -CSVFile $home\documents\fw.csv</code> -Inbound -Outbound -Enabled -Disabled -Allow -Block (фильтр правил для экспорта) <br>
<code>Import-FirewallRules -CSVFile $home\documents\fw.csv</code></p>
<h2 id="rdp">RDP</h2>
<p><code>Get-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; -Name &quot;PortNumber&quot;</code> отобразить номер текущего RDP порта <br>
<code>Set-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; -Name &quot;PortNumber&quot; -Value &quot;3390&quot;</code> изменить RDP-порт <br>
<code>$(Get-ItemProperty -Path &quot;HKLM:\System\CurrentControlSet\Control\Terminal Server\&quot; -Name &quot;fDenyTSConnections&quot;).fDenyTSConnections</code> если 0, то включен <br>
<code>Set-ItemProperty -Path &quot;HKLM:\System\CurrentControlSet\Control\Terminal Server\&quot; -Name &quot;fDenyTSConnections&quot; -Value 0</code> включить RDP <br>
<code>reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f</code> <br>
<code>(gcim -Class Win32_TerminalServiceSetting -Namespace root\CIMV2\TerminalServices).SetAllowTSConnections(0)</code> включить RDP (для Windows Server) <br>
<code>Get-Service TermService | Restart-Service -Force</code> перезапустить rdp-службу <br>
<code>New-NetFirewallRule -Profile Any -DisplayName &quot;RDP 3390&quot; -Direction Inbound -Protocol TCP -LocalPort 3390</code> открыть RDP-порт</p>
<h3 id="ipban">IPBan</h3>
<p><code>auditpol /get /category:*</code> отобразить все политики аудита <br>
<code>auditpol /get /category:Вход/выход</code> отобразить локальные политики аудита для Входа и Выхода из системы <br>
<code>auditpol /set /subcategory:&quot;Вход в систему&quot; /success:enable /failure:enable</code> включить локальные политики - Аудит входа в систему <br>
<code>auditpol /set /subcategory:&quot;Выход из системы&quot; /success:enable /failure:enable</code></p>
<p><code>$url = $($(Invoke-RestMethod https://api.github.com/repos/DigitalRuby/IPBan/releases/latest).assets | Where-Object name -match &quot;.+win.+x64.+&quot;).browser_download_url</code> получить ссылку для загрузки последней версии <br>
<code>$version = $(Invoke-RestMethod https://api.github.com/repos/DigitalRuby/IPBan/releases/latest).tag_name</code> получить номер последней версии <br>
<code>$path = &quot;$home\Documents\ipban-$version&quot;</code> путь для установки <br>
<code>Invoke-RestMethod $url -OutFile &quot;$home\Downloads\IPBan-$version.zip&quot;</code> скачать дистрибутив <br>
<code>Expand-Archive &quot;$home\Downloads\ipban-$version.zip&quot; -DestinationPath $path</code> разархивировать в путь для установки <br>
<code>Remove-Item &quot;$home\Downloads\ipban-$version.zip&quot;</code> удалить дистрибутив <br>
<code>sc create IPBan type=own start=delayed-auto binPath=&quot;$path\DigitalRuby.IPBan.exe&quot; DisplayName=IPBan</code> создать службу <br>
<code>Get-Service IPBan</code> статус службы <br>
<code>$conf = $(Get-Content &quot;$path\ipban.config&quot;)</code> читаем конфигурацию <br>
<code>$conf = $conf -replace '&lt;add key=&quot;Whitelist&quot; value=&quot;&quot;/&gt;','&lt;add key=&quot;Whitelist&quot; value=&quot;192.168.3.0/24&quot;/&gt;'</code> добавить в белый лист домашнюю сеть для исключения <br>
<code>$conf = $conf -replace '&lt;add key=&quot;ProcessInternalIPAddresses&quot; value=&quot;false&quot;/&gt;','&lt;add key=&quot;ProcessInternalIPAddresses&quot; value=&quot;true&quot;/&gt;'</code> включить обработку локальных (внутренних) ip-адресов <br>
<code>$conf = $conf -replace '&lt;add key=&quot;FailedLoginAttemptsBeforeBanUserNameWhitelist&quot; value=&quot;20&quot;/&gt;','&lt;add key=&quot;FailedLoginAttemptsBeforeBanUserNameWhitelist&quot; value=&quot;5&quot;/&gt;'</code> указать количество попыток подключения до блокировки <br>
<code>$conf = $conf -replace '&lt;add key=&quot;ExpireTime&quot; value=&quot;01:00:00:00&quot;/&gt;','&lt;add key=&quot;ExpireTime&quot; value=&quot;00:01:00:00&quot;/&gt;'</code> задать время блокировки 1 час <br>
<code>$conf &gt; &quot;$path\ipban.config&quot;</code> обновить конфигурацию <br>
<code>Get-Service IPBan | Start-Service</code> запустить службу</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="Get-NetFirewallRule%20%7c%20Where-Object%20DisplayName%20-Match%20%22IPBan%22%20%7c%20ForEach-Object%20%7b%0d%0a%20%20%20%20$Name%20=%20$_.DisplayName%0d%0a%20%20%20%20Get-NetFirewallAddressFilter%20-AssociatedNetFirewallRule%20$_%20%7c%20Select-Object%20@%7bName=%22Name%22;%20Expression=%7b$Name%7d%7d,LocalIP,RemoteIP%0d%0a%7d%20#%20%d0%be%d1%82%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b8%d1%82%d1%8c%20%d0%be%d0%b1%d0%bb%d0%b0%d1%81%d1%82%d1%8c%20%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d0%bd%d0%b5%d0%bd%d0%b8%d1%8f%20%d0%bf%d1%80%d0%b0%d0%b2%d0%b8%d0%bb%20%d0%91%d1%80%d0%b0%d0%bd%d0%b4%d0%bc%d0%b0%d1%83%d1%8d%d1%80%d0%b0%20%d0%b4%d0%bb%d1%8f%20IPBan">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>Get-NetFirewallRule | Where-Object DisplayName -Match &#34;IPBan&#34; | ForEach-Object {
    $Name = $_.DisplayName
    Get-NetFirewallAddressFilter -AssociatedNetFirewallRule $_ | Select-Object @{Name=&#34;Name&#34;; Expression={$Name}},LocalIP,RemoteIP
} # отобразить область применения правил Брандмауэра для IPBan</code></pre>
    
</div>
<p><code>Get-Content -Wait &quot;$path\logfile.txt&quot;</code> читать лог <br>
<code>Get-Service IPBan | Stop-Service</code> остановить службу <br>
<code>sc delete IPBan</code> удалить службу</p>
<h2 id="smtp">SMTP</h2>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> Send-SMTP {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">param</span> (
</span></span><span style="display:flex;"><span>[Parameter(<span style="color:#a6e22e">Mandatory</span> = $True)]$mess
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>$srv_smtp = <span style="color:#e6db74">&#34;smtp.yandex.ru&#34;</span> 
</span></span><span style="display:flex;"><span>$port = <span style="color:#e6db74">&#34;587&#34;</span>
</span></span><span style="display:flex;"><span>$from = <span style="color:#e6db74">&#34;login1@yandex.ru&#34;</span> 
</span></span><span style="display:flex;"><span>$to = <span style="color:#e6db74">&#34;login2@yandex.ru&#34;</span> 
</span></span><span style="display:flex;"><span>$user = <span style="color:#e6db74">&#34;login1&#34;</span>
</span></span><span style="display:flex;"><span>$pass = <span style="color:#e6db74">&#34;password&#34;</span>
</span></span><span style="display:flex;"><span>$subject = <span style="color:#e6db74">&#34;Service status on Host: </span>$hostname<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>$Message = New-Object System.Net.Mail.MailMessage
</span></span><span style="display:flex;"><span>$Message.From = $from
</span></span><span style="display:flex;"><span>$Message.To.Add($to) 
</span></span><span style="display:flex;"><span>$Message.Subject = $subject 
</span></span><span style="display:flex;"><span>$Message.IsBodyHTML = $true 
</span></span><span style="display:flex;"><span>$Message.Body = <span style="color:#e6db74">&#34;&lt;h1&gt; </span>$mess<span style="color:#e6db74"> &lt;/h1&gt;&#34;</span>
</span></span><span style="display:flex;"><span>$smtp = New-Object Net.Mail.SmtpClient($srv_smtp, $port)
</span></span><span style="display:flex;"><span>$smtp.EnableSSL = $true 
</span></span><span style="display:flex;"><span>$smtp.Credentials = New-Object System.Net.NetworkCredential($user, $pass);
</span></span><span style="display:flex;"><span>$smtp.Send($Message) 
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
    
</div>
<p><code>Send-SMTP $(Get-Service)</code></p>
<h2 id="snmp">SNMP</h2>
<h3 id="setup-snmp-service">Setup SNMP Service</h3>
<p><code>Install-WindowsFeature SNMP-Service,SNMP-WMI-Provider -IncludeManagementTools</code> установить роль SNMP и WMI провайдер через Server Manager <br>
<code>Get-WindowsFeature SNMP*</code> <br>
<code>Add-WindowsCapability -Online -Name SNMP.Client~~~~0.0.1.0</code> установить компонент Feature On Demand для Windows 10/11<code>\</code>Get-Service SNMP*<code>\</code>Get-NetFirewallrule -DisplayName <em>snmp</em> | ft<code>\</code>Get-NetFirewallrule -DisplayName <em>snmp</em> | Enable-NetFirewallRule`</p>
<h3 id="setting-snmp-service-via-regedit">Setting SNMP Service via Regedit</h3>
<p>Agent: <br>
<code>New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\services\SNMP\Parameters\RFC1156Agent&quot; -Name &quot;sysContact&quot; -Value &quot;lifailon-user&quot;</code> создать (New) или изменить (Set) <br>
<code>New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\services\SNMP\Parameters\RFC1156Agent&quot; -Name &quot;sysLocation&quot; -Value &quot;plex-server&quot;</code></p>
<p>Security: <br>
<code>New-Item -Path &quot;HKLM:\SYSTEM\CurrentControlSet\services\SNMP\Parameters\TrapConfiguration\public&quot;</code> создать новый community string <br>
<code>New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Services\SNMP\Parameters\ValidCommunities&quot; -Name &quot;public&quot; -Value 16</code> назначить права на public <br>
<code>1 — NONE</code> <br>
<code>2 — NOTIFY</code> позволяет получать SNMP ловушки <br>
<code>4 — READ ONLY</code> позволяет получать данные с устройства <br>
<code>8 — READ WRITE</code> позволяет получать данные и изменять конфигурацию устройства <br>
<code>16 — READ CREATE</code> позволяет читать данные, изменять и создавать объекты <br>
<code>New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Services\SNMP\Parameters\PermittedManagers&quot; -Name &quot;1&quot; -Value &quot;192.168.3.99&quot;</code> от кого разрешено принимать запросы <br>
<code>Get-Service SNMP | Restart-Service</code></p>
<h3 id="snmpwalk">snmpwalk</h3>
<p><code>snmpwalk -v 2c -c public 192.168.3.100</code> <br>
<code>snmpwalk -v 2c -c public -O e 192.168.3.100</code></p>
<h3 id="snmp-modules">SNMP Modules</h3>
<p><code>Install-Module -Name SNMP</code> <br>
<code>Get-SnmpData -IP 192.168.3.100 -OID 1.3.6.1.2.1.1.4.0 -UDPport 161 -Community public</code> <br>
<code>(Get-SnmpData -IP 192.168.3.100 -OID 1.3.6.1.2.1.1.4.0).Data</code> <br>
<code>Invoke-SnmpWalk -IP 192.168.3.100 -OID 1.3.6.1.2.1.1</code> пройтись по дереву OID <br>
<code>Invoke-SnmpWalk -IP 192.168.3.100 -OID 1.3.6.1.2.1.25.6.3.1.2</code> список установленного ПО <br>
<code>Invoke-SnmpWalk -IP 192.168.3.100 -OID 1.3.6.1.2.1.25.2.3.1</code> список разделов и памяти (C: D: Virtual Memory и Physical Memory) <br>
<code>Set-SnmpData</code> изменение данных на удаленном устройстве</p>
<p><code>Install-Module -Name SNMPv3</code> <br>
<code>Invoke-SNMPv3Get</code> получение данных по одному OID <br>
<code>Invoke-SNMPv3Set</code> изменение данных <br>
<code>Invoke-SNMPv3Walk</code> обход по дереву OID <br>
<code>Invoke-SNMPv3Walk -UserName lifailon -Target 192.168.3.100 -AuthSecret password -PrivSecret password -OID 1.3.6.1.2.1.1 -AuthType MD5 -PrivType AES128</code></p>
<h3 id="lextmsharpsnmplib">Lextm.SharpSnmpLib</h3>
<p><a href="https://learn.microsoft.com/ru-ru/powershell/dsc/reference/resources/windows/fileresource?view=dsc-1.1">Синтаксис</a> <br>
<a href="https://api.nuget.org/v3-flatcontainer/lextm.sharpsnmplib/12.5.2/lextm.sharpsnmplib.12.5.2.nupkg">Download lib</a></p>
<p><code>Add-Type -LiteralPath &quot;$home\Desktop\lextm.sharpsnmplib-12.5.2\net471\SharpSnmpLib.dll&quot;</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$port = <span style="color:#ae81ff">161</span>
</span></span><span style="display:flex;"><span>$OID = <span style="color:#e6db74">&#34;1.3.6.1.2.1.1.4.0&#34;</span>
</span></span><span style="display:flex;"><span>$variableList = New-Object Collections.Generic.List[<span style="color:#66d9ef">Lextm.SharpSnmpLib.Variable</span>]
</span></span><span style="display:flex;"><span>$variableList.Add([<span style="color:#66d9ef">Lextm.SharpSnmpLib.Variable</span>]::new([<span style="color:#66d9ef">Lextm.SharpSnmpLib.ObjectIdentifier</span>]::new($OID)))
</span></span><span style="display:flex;"><span>$timeout = <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">Net.IPAddress</span>]$ip = <span style="color:#e6db74">&#34;192.168.3.100&#34;</span>
</span></span><span style="display:flex;"><span>$endpoint = New-Object Net.IpEndPoint $ip, $port
</span></span><span style="display:flex;"><span>$Community = <span style="color:#e6db74">&#34;public&#34;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">Lextm.SharpSnmpLib.VersionCode</span>]$Version = <span style="color:#e6db74">&#34;V2&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$message = [<span style="color:#66d9ef">Lextm.SharpSnmpLib.Messaging.Messenger</span>]::Get(
</span></span><span style="display:flex;"><span>$Version,
</span></span><span style="display:flex;"><span>$endpoint,
</span></span><span style="display:flex;"><span>$Community,
</span></span><span style="display:flex;"><span>$variableList,
</span></span><span style="display:flex;"><span>$TimeOut
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>$message.Data.ToString()</span></span></code></pre></div>
    
</div>
<h3 id="walk">Walk</h3>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>[<span style="color:#66d9ef">Lextm.SharpSnmpLib.ObjectIdentifier</span>]$OID = <span style="color:#e6db74">&#34;1.3.6.1.2.1.1&#34;</span> <span style="color:#75715e"># дерево или конечный OID</span>
</span></span><span style="display:flex;"><span>$WalkMode = [<span style="color:#66d9ef">Lextm.SharpSnmpLib.Messaging.WalkMode</span>]::WithinSubtree <span style="color:#75715e"># режим обхода по дереву</span>
</span></span><span style="display:flex;"><span>$results = New-Object Collections.Generic.List[<span style="color:#66d9ef">Lextm.SharpSnmpLib.Variable</span>]
</span></span><span style="display:flex;"><span>$message = [<span style="color:#66d9ef">Lextm.SharpSnmpLib.Messaging.Messenger</span>]::Walk(
</span></span><span style="display:flex;"><span>  $Version,
</span></span><span style="display:flex;"><span>  $endpoint,
</span></span><span style="display:flex;"><span>  $Community,
</span></span><span style="display:flex;"><span>  $OID,
</span></span><span style="display:flex;"><span>  $results,
</span></span><span style="display:flex;"><span>  $TimeOut,
</span></span><span style="display:flex;"><span>  $WalkMode
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>$results
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$results2 = @()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($d <span style="color:#66d9ef">in</span> $results) {
</span></span><span style="display:flex;"><span>$results2 +=[<span style="color:#66d9ef">PSCustomObject</span>]@{<span style="color:#e6db74">&#39;ID&#39;</span>=$d.id.ToString();<span style="color:#e6db74">&#39;Data&#39;</span>=$d.Data.ToString()} <span style="color:#75715e"># перекодировать вывод построчно в строку</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$results2</span></span></code></pre></div>
    
</div>
<h2 id="pki">pki</h2>
<p><code>New-SelfSignedCertificate -CertStoreLocation Cert:\LocalMachine\My -DnsName &quot;$env:computername&quot; -FriendlyName &quot;Test Certificate&quot; -NotAfter (Get-Date).AddYears(5)</code> создать самоподписанный сертификат (в LocalMachine\My - Сертификаты компьютера\Личное) с сроком действия 5 лет</p>
<p><code>Get-ChildItem -Path Cert:\CurrentUser\Root\</code> список всех установленных сертификатов в хранилище Доверенные корневые ЦС Текущего пользователя <br>
<code>Get-ChildItem -Path Cert:\CurrentUser\My\</code> список самозаверяющих сертификатов в Личное хранилище Текущего пользователя <br>
<code>Get-ChildItem -Path Cert:\LocalMachine\My\</code> список самозаверяющих сертификатов в Личное хранилище Локального компьютера <br>
<code>Get-ChildItem -Path Cert:\LocalMachine\My\ | select NotBefore,NotAfter,Thumbprint,Subject</code> срок действия сертификата <br>
<code>Get-ChildItem -Path Cert:\LocalMachine\My\ | where Thumbprint -eq D9356FB774EE0E6206B7D5B59B99102CA5B17BDA</code> поиск сертификат по отпечатку</p>
<p><code>Get-ChildItem -Path $env:APPDATA\Microsoft\SystemCertificates\My\Certificates\</code> сертификаты в файловой системе, каждый файл соответствует сертификату, установленному в личном хранилище текущего пользователя <br>
<code>Get-ChildItem -Path $env:APPDATA\Microsoft\SystemCertificates\My\Keys\</code> ссылки на объекты закрытых ключей, созданных поставщиком хранилища ключей (KSP) <br>
<code>Get-ChildItem -Path HKCU:\Software\Microsoft\SystemCertificates\CA\Certificates | ft -AutoSize</code> список сертификатов в реестре вошедшего в систему пользователя</p>
<p><code>$cert = (Get-ChildItem -Path Cert:\CurrentUser\My\)[1]</code> выбрать сертификат <br>
<code>$cert | Remove-Item</code> удалить сертификат</p>
<p><code>Export-Certificate -FilePath $home\Desktop\certificate.cer -Cert $cert</code> экспортировать сертификат <br>
<code>$cert.HasPrivateKey</code> проверить наличие закрытого ключа <br>
<code>$pass = &quot;password&quot; | ConvertTo-SecureString -AsPlainText -Force</code> создать пароль для шифрования закрытого ключа <br>
<code>Export-PfxCertificate -FilePath $home\Desktop\certificate.pfx -Password $pass -Cert $certificate</code> экспортировать сертификат с закрытым ключем</p>
<p><code>Import-Certificate -FilePath $home\Desktop\certificate.cer -CertStoreLocation Cert:\CurrentUser\My</code> импортировать сертификат <br>
<code>Import-PfxCertificate -Exportable -Password $pass -CertStoreLocation Cert:\CurrentUser\My -FilePath $home\Desktop\certificate.pfx</code></p>
<h2 id="openssl">OpenSSL</h2>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>Invoke-WebRequest -Uri https<span style="color:#960050;background-color:#1e0010">:</span>//slproweb.com/download/Win64OpenSSL_Light-3_1_1.msi -OutFile $home\Downloads\OpenSSL-Light-<span style="color:#ae81ff">3.1</span>.1.msi
</span></span><span style="display:flex;"><span>Start-Process $home\Downloads\OpenSSL-Light-<span style="color:#ae81ff">3.1</span>.1.msi -ArgumentList <span style="color:#e6db74">&#39;/quiet&#39;</span> -Wait` установить msi пакет в тихом режиме (запуск от имени Администратора)
</span></span><span style="display:flex;"><span>rm $home\Downloads\OpenSSL-Light-<span style="color:#ae81ff">3.1</span>.1.msi
</span></span><span style="display:flex;"><span>cd <span style="color:#e6db74">&#34;C:\Program Files\OpenSSL-Win64\bin&#34;</span></span></span></code></pre></div>
    
</div>
<ul>
<li>
<p>Изменить пароль для PFX <br>
<code>openssl pkcs12 -in &quot;C:\Cert\domain.ru.pfx&quot; -out &quot;C:\Cert\domain.ru.pem&quot; -nodes</code> экспортируем имеющийся сертификат и закрытый ключ в .pem-файл без пароля с указанием текущего пароля <br>
<code>openssl pkcs12 -export -in &quot;C:\Cert\domain.ru.pem&quot; -out &quot;C:\Cert\domain.ru_password.pfx&quot; -nodes</code> конвертируем .pem обратно в .pfx c указанием нового пароля</p>
</li>
<li>
<p>Конвертация из закрытого и открытого ключа PEM в PFX <br>
<code>openssl pkcs12 -export -in &quot;C:\tmp\vpn\vpn.itproblog.ru-crt.pem&quot; -inkey &quot;C:\tmp\vpn\vpn.itproblog.ru-key.pem&quot; -out &quot;C:\tmp\vpn\vpn.iiproblog.ru.pfx&quot;</code> <br>
in – путь до файла с открытым ключом <br>
inkey – путь до файла с закрытым ключом <br>
out – путь до файла, в который будет конвертирован сертификат (pfx)</p>
</li>
<li>
<p>Конвертация PFX в CRT <br>
<code>openssl pkcs12 -in &quot;C:\OpenSSL-Win64\bin\_.domain.ru.pfx&quot; -clcerts -out &quot;C:\OpenSSL-Win64\bin\_.domain.ru.crt&quot;</code> указывается текущий и 2 раза новый пароль PEM pass phrase (файл содержит EGIN CERTIFICATE и BEGIN ENCRYPTED PRIVATE KEY) <br>
<code>openssl pkcs12 -in &quot;C:\OpenSSL-Win64\bin\_.domain.ru.pfx&quot; -clcerts -nokeys -out &quot;C:\OpenSSL-Win64\bin\_.domain.ru.crt&quot;</code> без ключа, получить открытую часть (файл содержит только EGIN CERTIFICATE)</p>
</li>
<li>
<p>Конвертация PFX в KEY <br>
<code>openssl pkcs12 -in &quot;C:\OpenSSL-Win64\bin\_.domain.ru.pfx&quot; -nocerts -out &quot;C:\OpenSSL-Win64\bin\_.domain.ru.key&quot;</code> файл содержит только BEGIN ENCRYPTED PRIVATE KEY</p>
</li>
<li>
<p>Снять пароль к закрытого ключа .key <br>
<code>openssl rsa -in &quot;C:\OpenSSL-Win64\bin\_.domain.ru.key&quot; -out &quot;C:\OpenSSL-Win64\bin\_.domain.ru-decrypted.key&quot;</code></p>
</li>
<li>
<p>CRT и KEY в PFX: <br>
<code>openssl pkcs12 -inkey certificate.key -in certificate.crt -export -out certificate.pfx</code></p>
</li>
</ul>
<h2 id="openvpn">OpenVPN</h2>
<p><code>Invoke-WebRequest -Uri https://swupdate.openvpn.org/community/releases/OpenVPN-2.6.5-I001-amd64.msi -OutFile $home\Downloads\OpenVPN-2.6.5.msi</code> <br>
<code>Start-Process $home\Downloads\OpenVPN-2.6.5.msi -ArgumentList '/quiet /SELECT_OPENSSL_UTILITIES=1' -Wait</code> <br>
<code>msiexec /i $home\Downloads\OpenVPN-2.6.5.msi ADDLOCAL=EasyRSA /passive /quiet # установить отдельный компонент EasyRSA Certificate Management Scripts</code> <br>
<code># msiexec /i $home\Downloads\OpenVPN-2.6.5.msi ADDLOCAL=OpenVPN.Service,Drivers,Drivers.Wintun,OpenVPN,OpenVPN.GUI,OpenVPN.GUI.OnLogon,EasyRSA /passive</code> выборочная установка <br>
<code># Invoke-WebRequest -Uri https://github.com/OpenVPN/easy-rsa/releases/download/v3.1.5/EasyRSA-3.1.5-win64.zip -OutFile $home\Downloads\EasyRSA-3.1.5.zip</code> скачать отдельный пакет EasyRSA <br>
<code>rm $home\Downloads\OpenVPN-2.6.5.msi</code></p>
<p><code>cd &quot;C:\Program Files\OpenVPN\easy-rsa&quot;</code> <br>
<code>Copy-Item vars.example vars</code> файл конфигурации для EasyRSA</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="set_var%20EASYRSA_TEMP_DIR%20%22$EASYRSA_PKI%22%0d%0aset_var%20EASYRSA_REQ_COUNTRY%20%22RU%22%0d%0aset_var%20EASYRSA_REQ_PROVINCE%20%22MSK%22%0d%0aset_var%20EASYRSA_REQ_CITY%20%22MSK%22%0d%0aset_var%20EASYRSA_REQ_ORG%20%22FAILON.NET%22%0d%0aset_var%20EASYRSA_REQ_EMAIL%20%22lifailon@domain.ru%22%0d%0aset_var%20EASYRSA_REQ_OU%20%22IT%22%0d%0a#set_var%20EASYRSA_KEY_SIZE%202048%0d%0a#set_var%20EASYRSA_CA_EXPIRE%203650%0d%0a#set_var%20EASYRSA_CERT_EXPIRE%20825">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>set_var EASYRSA_TEMP_DIR &#34;$EASYRSA_PKI&#34;
set_var EASYRSA_REQ_COUNTRY &#34;RU&#34;
set_var EASYRSA_REQ_PROVINCE &#34;MSK&#34;
set_var EASYRSA_REQ_CITY &#34;MSK&#34;
set_var EASYRSA_REQ_ORG &#34;FAILON.NET&#34;
set_var EASYRSA_REQ_EMAIL &#34;lifailon@domain.ru&#34;
set_var EASYRSA_REQ_OU &#34;IT&#34;
#set_var EASYRSA_KEY_SIZE 2048
#set_var EASYRSA_CA_EXPIRE 3650
#set_var EASYRSA_CERT_EXPIRE 825</code></pre>
    
</div>
<p><code>.\EasyRSA-Start.bat</code> среда EasyRSA Shell <br>
<code>easyrsa init-pki</code> инициализация PKI, создает директорию: C:\Program Files\OpenVPN\easy-rsa\pki и читает переменные файла \easy-rsa\vars <br>
<code>easyrsa build-ca</code> генерация корневого CA с указанием пароля и произвольное имя сервера (\pki\ca.crt и \pki\private\ca.key) <br>
<code>easyrsa gen-req server nopass</code> генерация запроса сертификата и ключ для сервера OpenVPN - yes (\pki\reqs\server.req и \pki\private\server.key) <br>
<code>easyrsa sign-req server server</code> подписать запрос на выпуск сертификата сервера с помощью CA - yes (\pki\issued\server.crt) <br>
<code>easyrsa gen-dh</code> создать ключ Диффи-Хеллмана (\pki\dh.pem) <br>
<code>easyrsa gen-req client1</code> nopass<code> генерация запроса сертификата и ключ для клиента OpenVPN (\pki\reqs\client1.req и \pki\private\client1.key)</code> <br>
<code>easyrsa sign-req client client1</code> подписать запрос на выпуск сертификата клиента с помощью CA - yes (\pki\issued\client1.crt) <br>
<code>easyrsa revoke client1</code> отозвать сертификат пользователя <br>
<code>openssl rsa -in &quot;C:\Program Files\OpenVPN\easy-rsa\pki\private\client1.key&quot; -out &quot;C:\Program Files\OpenVPN\easy-rsa\pki\private\client1_nopass.key&quot;</code> снять защиту паролем для ключа (BEGIN ENCRYPTED PRIVATE KEY -&gt; BEGIN PRIVATE KEY) <br>
<code>exit</code> <br>
<code>cd &quot;C:\Program Files\OpenVPN\bin&quot;</code> <br>
<code>.\openvpn --genkey secret ta.key</code> генерация ключа tls-auth (\bin\ta.key) <br>
<code>Move-Item &quot;C:\Program Files\OpenVPN\bin\ta.key&quot; &quot;C:\Program Files\OpenVPN\easy-rsa\pki\&quot;</code></p>
<h3 id="serverovpn">server.ovpn</h3>
<p><code># Copy-Item &quot;C:\Program Files\OpenVPN\sample-config\server.ovpn&quot; &quot;C:\Program Files\OpenVPN\config-auto\server.ovpn&quot;</code> <br>
<code>New-Item -ItemType File -Path &quot;C:\Program Files\OpenVPN\config-auto\server.ovpn&quot;</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>port 1194
proto udp
# Что именно инкапсулировать в туннеле (ethernet фреймы - tap или ip пакеты - tun)
dev tun
ca &#34;C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\ca.crt&#34;
cert &#34;C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\issued\\server.crt&#34;
key &#34;C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\private\\server.key&#34;
dh &#34;C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\dh.pem&#34;
server 192.168.4.0 255.255.255.0
# Хранит список сопоставления ip для клиентов, что бы назначить тот же адрес при перезапуске сервера
# ifconfig-pool-persist &#34;C:\\Program Files\\OpenVPN\\dhcp-client-list.txt&#34;
# Разрешить клиентам подключаться под одним ключом
# duplicate-cn
# max-clients 30
# Разрешить обмен трафиком между клиентами
client-to-client
# compress
tls-auth &#34;C:\\Program Files\\OpenVPN\\easy-rsa\\pki\\ta.key&#34; 0
cipher AES-256-GCM
keepalive 20 60
# Не перечитавать файлы ключей при перезапуске туннеля
persist-key
# Оставляет без изменения устройства tun/tap при перезапуске OpenVPN
persist-tun
status &#34;C:\\Program Files\\OpenVPN\\log\\status.log&#34;
log &#34;C:\\Program Files\\OpenVPN\\log\\openvpn.log&#34;
verb 3
mute 20
windows-driver wintun
# Открыть доступ к подсети за сервером
push &#34;route 192.168.3.0 255.255.255.0&#34;
push &#34;route 192.168.4.0 255.255.255.0&#34;
# Завернуть все запросы клиента (в том числе Интернет трафик) на OpenVPN сервер
# push &#34;redirect-gateway def1&#34;
# push &#34;dhcp-option DNS 192.168.3.101&#34;
# push &#34;dhcp-option DOMAIN failon.net&#34;</code></pre>
    
</div>
<p><code>New-NetFirewallRule -DisplayName &quot;AllowOpenVPN-In&quot; -Direction Inbound -Protocol UDP –LocalPort 1194 -Action Allow</code> на сервере <br>
<code>New-NetFirewallRule -DisplayName &quot;AllowOpenVPN-Out&quot; -Direction Outbound -Protocol UDP –LocalPort 1194 -Action Allow</code> на клиенте <br>
<code>Get-Service *openvpn* | Restart-Service</code></p>
<h3 id="clientovpn">client.ovpn</h3>
<p><code># Copy-Item &quot;C:\Program Files\OpenVPN\sample-config\client.ovpn&quot; &quot;C:\Program Files\OpenVPN\config-auto\client.ovpn&quot;</code> <br>
<code>New-Item -ItemType File -Path &quot;C:\Program Files\OpenVPN\config-auto\client.ovpn&quot;</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="client%0d%0adev%20tun%0d%0aproto%20udp%0d%0aremote%2026.115.154.67%201194%0d%0aresolv-retry%20infinite%0d%0anobind%0d%0apersist-key%0d%0apersist-tun%0d%0aca%20ca.crt%0d%0acert%20client1.crt%0d%0akey%20client1.key%0d%0aremote-cert-tls%20server%0d%0atls-auth%20ta.key%201%0d%0acipher%20AES-256-GCM%0d%0aconnect-retry-max%2025%0d%0a#%20%d0%98%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d1%82%d1%8c%20%d0%b4%d1%80%d0%b0%d0%b9%d0%b2%d0%b5%d1%80%20wintun%20%d0%b8%20%d0%bf%d0%be%d0%bb%d0%bd%d1%8b%d0%b9%20%d0%bf%d1%83%d1%82%d1%8c%20%d0%b4%d0%be%20%d1%81%d0%b5%d1%80%d1%82%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%82%d0%be%d0%b2%20%d0%bf%d1%80%d0%b8%20%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b8%20openvpn%20gui%0d%0awindows-driver%20wintun%0d%0averb%203">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>client
dev tun
proto udp
remote 26.115.154.67 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert client1.crt
key client1.key
remote-cert-tls server
tls-auth ta.key 1
cipher AES-256-GCM
connect-retry-max 25
# Использовать драйвер wintun и полный путь до сертификатов при использовании openvpn gui
windows-driver wintun
verb 3</code></pre>
    
</div>
<h3 id="client">Client</h3>
<p><code>iwr -Uri https://openvpn.net/downloads/openvpn-connect-v3-windows.msi -OutFile &quot;$home\downloads\OpenVPN-Connect-3.msi&quot;</code> <br>
Передать конфигурацию и ключи: <br>
<code>client.ovpn</code> <br>
<code>ca.crt</code> <br>
<code>dh.pem</code> <br>
<code>ta.key</code> <br>
<code>client1.crt</code> <br>
<code>client1.key</code></p>
<h2 id="route">Route</h2>
<p><code>Get-Service RemoteAccess | Stop-Service</code> <br>
<code>Set-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters&quot; -Name &quot;IPEnableRouter&quot; -Value 1</code> включает IP маршрутизацию <br>
<code>(Get-ItemProperty &quot;HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters&quot;).IPEnableRouter</code> <br>
<code>Get-NetIPInterface | select ifIndex,InterfaceAlias,AddressFamily,ConnectionState,Forwarding | ft</code> отобразить сетевые интерфейсы <br>
<code>Set-NetIPInterface -ifIndex 13 -Forwarding Enabled</code> включить переадресацию на интерфейсе</p>
<p><code>sysctl net.ipv4.ip_forward=1</code> <br>
<code>echo &quot;sysctl net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</code></p>
<p><code>Get-NetRoute</code> <br>
<code>New-NetRoute -DestinationPrefix &quot;192.168.3.0/24&quot; -NextHop &quot;192.168.4.1&quot; -InterfaceIndex 8</code> <br>
<code>route -p add 192.168.3.0 mask 255.255.255.0 192.168.4.1 metric 1</code> <br>
<code>route -p change 192.168.3.0 mask 255.255.255.0 192.168.4.1 metric 2</code> <br>
<code>route -p add 192.168.3.0 mask 255.255.255.0 192.168.4.1 metric 1 if 7</code> указать номер сетевого интерфейса на который необходимо посылать пакет (Wintun Userspace Tunnel) <br>
<code>route print -4</code> <br>
<code>route delete 192.168.3.0</code></p>
<p><code>tracert 192.168.3.101</code> с 192.168.4.6</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="1%20%20%20%2017%20ms%20%20%20%20%20*%20%20%20%20%20%20%2022%20ms%20%20192.168.4.1%0d%0a2%20%20%20%2012%20ms%20%20%20%2013%20ms%20%20%20%2014%20ms%20%20192.168.3.101">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>1    17 ms     *       22 ms  192.168.4.1
2    12 ms    13 ms    14 ms  192.168.3.101</code></pre>
    
</div>
<p><code>route add -net 192.168.4.0 netmask 255.255.255.0 gw 192.168.3.100</code> <br>
<code>route -e</code></p>
<p><code>traceroute 192.168.4.6</code> с 192.168.3.101</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="1%20%20192.168.3.100%20%28192.168.3.100%29%20%200.148%20ms%20%200.110%20ms%20%200.106%20ms%0d%0a2%20%20192.168.4.6%20%28192.168.4.6%29%20%2014.573%20ms%20*%20*">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>1  192.168.3.100 (192.168.3.100)  0.148 ms  0.110 ms  0.106 ms
2  192.168.4.6 (192.168.4.6)  14.573 ms * *</code></pre>
    
</div>
<p><code>ping 192.168.3.101 -t</code> с 192.168.4.6 <br>
<code>tcpdump -n -i ens33 icmp</code> на 192.168.3.101</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="#ZgotmplZ">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>14:36:34.533771 IP 192.168.4.6 &gt; 192.168.3.101: ICMP echo request, id 1, seq 2962, length 40 # отправил запрос
14:36:34.533806 IP 192.168.3.101 &gt; 192.168.4.6: ICMP echo reply, id 1, seq 2962, length 40 # отправил ответ</code></pre>
    
</div>
<h2 id="nat">NAT</h2>
<p><code>Get-Command -Module NetNat</code> <br>
<code>New-NetNat -Name LocalNat -InternalIPInterfaceAddressPrefix &quot;192.168.3.0/24&quot;</code> <br>
<code>Add-NetNatStaticMapping -NatName LocalNat -Protocol TCP -ExternalIPAddress 0.0.0.0 -ExternalPort 80 -InternalIPAddress 192.168.3.102 -InternalPort 80</code> <br>
<code>Remove-NetNatStaticMapping -StaticMappingID 0</code> <br>
<code>Remove-NetNat -Name LocalNat</code></p>
<h2 id="wireguard">WireGuard</h2>
<p><code>Invoke-WebRequest &quot;https://download.wireguard.com/windows-client/wireguard-amd64-0.5.3.msi&quot; -OutFile &quot;$home\Downloads\WireGuard-Client-0.5.3.msi&quot;</code> <br>
<code>msiexec.exe /i &quot;$home\Downloads\WireGuard-Client-0.5.3.msi&quot; DO_NOT_LAUNCH=1 /qn</code> <br>
<code>Invoke-WebRequest &quot;http://www.wiresock.net/downloads/wiresock-vpn-gateway-x64-1.1.4.1.msi&quot; -OutFile &quot;$home\Downloads\WireSock-VPN-Gateway-1.1.4.1.msi&quot;</code> <br>
<code>msiexec.exe /i &quot;http://www.wiresock.net/downloads/wiresock-vpn-gateway-x64-1.1.4.1.msi&quot; /qn</code> <br>
<code>$env:Path = [System.Environment]::GetEnvironmentVariable(&quot;Path&quot;,&quot;Machine&quot;) + &quot;;&quot; + [System.Environment]::GetEnvironmentVariable(&quot;Path&quot;,&quot;User&quot;)</code> <br>
<code>wg-quick-config -add -start</code> <br>
<code>26.115.154.67:8181</code> <br>
<code>192.168.21.4/24</code> <br>
<code>Successfully saved client configuration: C:\ProgramData\NT KERNEL\WireSock VPN Gateway\wsclient_1.conf</code> <br>
<code>Successfully saved server configuration: C:\ProgramData\NT KERNEL\WireSock VPN Gateway\wiresock.conf</code> <br>
<code>get-service *wire*</code> <br>
<code>wg show</code> <br>
<code>wg-quick-config -add -restart</code> add client</p>
<p>wiresock.conf</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="[Interface]%0d%0aPrivateKey%20=%20gCHC0g2JPwr6sXPiaOL4/KTkMyjN9TculrJUA/GORV8=%0d%0aAddress%20=%20192.168.21.5/24%0d%0aListenPort%20=%208181%0d%0a%0d%0a[Peer]%0d%0aPublicKey%20=%20NoSxjew2RCHiUzI6mlahjd4I&#43;0EcLsoYom/H01z91yU=%0d%0aAllowedIPs%20=%20192.168.21.6/32">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>[Interface]
PrivateKey = gCHC0g2JPwr6sXPiaOL4/KTkMyjN9TculrJUA/GORV8=
Address = 192.168.21.5/24
ListenPort = 8181

[Peer]
PublicKey = NoSxjew2RCHiUzI6mlahjd4I&#43;0EcLsoYom/H01z91yU=
AllowedIPs = 192.168.21.6/32</code></pre>
    
</div>
<p>wsclient_1.conf (добавить маршруты для клиента в AllowedIPs)</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="[Interface]%0d%0aPrivateKey%20=%20yIpRQRmaGrrk9Y&#43;49E8JhEpFmKzSeecvUAdeNgf1hUM=%0d%0aAddress%20=%20192.168.21.6/24%0d%0aDNS%20=%208.8.8.8,%201.1.1.1%0d%0aMTU%20=%201420%0d%0a%0d%0a[Peer]%0d%0aPublicKey%20=%20Fp7674VSYeGj8CYt6RCKR7Qz1y/IKUXCw8ImOFhX3hk=%0d%0aAllowedIPs%20=%20192.168.21.0/24,%20192.168.3.0/24%0d%0aEndpoint%20=%2026.115.154.67:8181%0d%0aPersistentKeepalive%20=%2025">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>[Interface]
PrivateKey = yIpRQRmaGrrk9Y&#43;49E8JhEpFmKzSeecvUAdeNgf1hUM=
Address = 192.168.21.6/24
DNS = 8.8.8.8, 1.1.1.1
MTU = 1420

[Peer]
PublicKey = Fp7674VSYeGj8CYt6RCKR7Qz1y/IKUXCw8ImOFhX3hk=
AllowedIPs = 192.168.21.0/24, 192.168.3.0/24
Endpoint = 26.115.154.67:8181
PersistentKeepalive = 25</code></pre>
    
</div>
<h2 id="vpnclient">VpnClient</h2>
<p><code>Get-Command -Module VpnClient</code> <br>
<code>Add-VpnConnection -Name &quot;vpn-failon&quot; -ServerAddress &quot;26.115.154.67&quot; -TunnelType L2TP -L2tpPsk &quot;123098&quot; -EncryptionLevel &quot;Required&quot; -AuthenticationMethod MSChapv2 -RememberCredential -AllUserConnection –PassThru -Force</code> <br>
<code>-TunnelType PPTP/L2TP/SSTP/IKEv2/Automatic</code> <br>
<code>-L2tpPsk</code> использовать общий ключ для аутентификации (без параметра, для L2TP аутентификации используется сертификат) <br>
<code>-AuthenticationMethod Pap/Chap/MSChapv2/Eap/MachineCertificate</code> <br>
<code>-EncryptionLevel NoEncryption/Optional/Required/Maximum/Custom</code> <br>
<code>-SplitTunneling</code> заворачивать весь трафик через VPN-туннель (включение Use default gateway on remote network в настройках параметра VPN адаптера) <br>
<code>-UseWinlogonCredential</code> использовать учетные данные текущего пользователя для аутентификации на VPN сервере <br>
<code>-RememberCredential</code> разрешить сохранять учетные данные для VPN подключения (учетная запись и пароль сохраняются в диспетчер учетных данных Windows после первого успешного подключения) <br>
<code>-DnsSuffix domain.local</code> <br>
<code>-AllUserConnection</code> разрешить использовать VPN подключение для всех пользователей компьютера (сохраняется в конфигурационный файл: C:\ProgramData\Microsoft\Network\Connections\Pbk\rasphone.pbk)</p>
<p><code>Install-Module -Name VPNCredentialsHelper</code> модуль для сохранения логина и пароля в Windows Credential Manager для VPN подключения <br>
<code>Set-VpnConnectionUsernamePassword -connectionname vpn-failon -username user1 -password password</code></p>
<p><code>rasdial &quot;vpn-failon&quot;</code> подключиться <br>
<code>Get-VpnConnection -AllUserConnection | select *</code> список VPN подключения, доступных для всех пользователей, найстройки и текущий статус подключения (ConnectionStatus) <br>
<code>Add-VpnConnectionRoute -ConnectionName vpn-failon -DestinationPrefix 192.168.3.0/24 –PassThru</code> динамически добавить в таблицу маршрутизации маршрут, который будет активен при подключении к VPN <br>
<code>Remove-VpnConnection -Name vpn-failon -AllUserConnection -Force</code> удалить</p>
<p><code>Set-VpnConnection -Name &quot;vpn-failon&quot; -SplitTunneling $True</code> включить раздельное тунеллирование <br>
<code>Add-VpnConnectionRoute -ConnectionName &quot;vpn-failon&quot; -DestinationPrefix 172.22.22.0/24</code> настроить маршрутизацию к указанной подсети через VPN-соединение <br>
<code>(Get-VpnConnection -ConnectionName &quot;vpn-failon&quot;).routes</code> отобразить таблицу маршрутизации для указанного соединения <br>
<code>Remove-VpnConnectionRoute -ConnectionName &quot;vpn-failon&quot; -DestinationPrefix &quot;172.22.23.0/24&quot;</code></p>
<h2 id="proxy">Proxy</h2>
<p><code>$user = &quot;lifailon&quot;</code> <br>
<code>$pass = &quot;Proxy&quot;</code> <br>
<code>$SecureString = ConvertTo-SecureString $pass -AsPlainText -Force</code> <br>
<code>$Credential = New-Object System.Management.Automation.PSCredential($user, $SecureString)</code> <br>
<code>[System.Net.Http.HttpClient]::DefaultProxy = New-Object System.Net.WebProxy(&quot;http://192.168.3.100:9090&quot;)</code> <br>
<code>[System.Net.Http.HttpClient]::DefaultProxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials</code> <br>
<code>[System.Net.Http.HttpClient]::DefaultProxy.Credentials = $Credential</code> <br>
<code>Invoke-RestMethod http://ifconfig.me/ip</code> <br>
<code>Invoke-RestMethod https://kinozal.tv/rss.xml</code></p>
<h2 id="netsh">netsh</h2>
<h3 id="proxy-1">Proxy</h3>
<p><code>netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.3.108</code> <br>
<code>netsh interface portproxy show all</code> <br>
<code>netsh interface portproxy delete v4tov4 listenport=8080 listenaddress=0.0.0.0</code></p>
<h3 id="wlan">Wlan</h3>
<p><code>netsh wlan show profile</code> список сохраненны профилей Wi-Fi и паролей <br>
<code>netsh wlan show interfaces</code> хар-ки текущей сети (MAC, speed) <br>
<code>netsh wlan show profile SSID-Name-Network key=clear</code> очистить пароль <br>
<code>netsh wlan show networks</code> список видемых сетей <br>
<code>netsh wlan disconnect</code> отключиться от Wi-Fi <br>
<code>netsh wlan connect name=&quot;SSID-Name-Network&quot;</code> подключиться <br>
<code>netsh wlan show drivers</code> драйвер Wi-Fi <br>
<code>netsh wlan set hostednetwork mode=allow ssid=&quot;WiFi-Test&quot; key=&quot;password&quot;</code> создание точки доступа Wi-Fi (SoftAP)</p>
<h3 id="firewall-1">Firewall</h3>
<p><code>netsh advfirewall set allprofiles state off</code> отключить fw <br>
<code>netsh advfirewall reset</code> сбросить настройки <br>
<code>netsh advfirewall firewall add rule name=&quot;Open Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow</code> открыть порт 3389 <br>
<code>netsh advfirewall firewall add rule name=&quot;All ICMP V4&quot; dir=in action=allow protocol=icmpv4</code> открыть icmp</p>
<h1 id="openssh">OpenSSH</h1>
<p><code>Get-WindowsCapability -Online | ? Name -like 'OpenSSH.Client*'</code> <br>
<code>Add-WindowsCapability -Online -Name OpenSSH.Client*</code> <br>
<code>dism /Online /Add-Capability /CapabilityName:OpenSSH.Client~~~~0.0.1.0</code> <br>
<code>iwr https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.2.2.0p1-Beta/OpenSSH-Win64-v9.2.2.0.msi -OutFile $home\Downloads\OpenSSH-Win64-v9.2.2.0.msi</code> скачать <br>
<code>msiexec /i $home\Downloads\OpenSSH-Win64-v9.2.2.0.msi</code> установить msi пакет <br>
<code>Set-Service sshd -StartupType Automatic</code> <br>
<code>Get-NetTCPConnection | where LocalPort -eq 22</code> <br>
<code>New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22</code> <br>
<code>Get-NetFirewallRule -Name *ssh*</code> <br>
<code>Start-Process notepad++ C:\Programdata\ssh\sshd_config</code> конфигурационный файл <br>
<code>GSSAPIAuthentication yes</code> включить Kerberos аутентификацию (через AD) <br>
<code>SyslogFacility LOCAL0</code> включить локальное ведение журнала в файл (C:\ProgramData\ssh\logs\sshd.log) <br>
<code>LogLevel INFO</code> <br>
<code>Restart-Service sshd</code> <br>
<code>ssh -K $srv</code> выполнить Kerberos аутентификацию <br>
<code>ssh Lifailon@192.168.3.99 -p 22</code> <br>
<code>pwsh -command Get-Service</code> <br>
<code>ssh -L 3101:192.168.3.101:22 -R 3101:192.168.3.101:22 lifailon@192.168.3.101 -p 22</code> SSH Tunnel lifailon@localhost:3101 -&gt; 192.168.3.101:3101</p>
<h2 id="winrm">WinRM</h2>
<p><code>Enter-PSSession -ComputerName $srv</code> подключиться к PowerShell сессии через PSRemoting. Подключение возможно только по FQDN-имени <br>
<code>Invoke-Command $srv -ScriptBlock {Get-ComputerInfo}</code> выполнение команды через PSRemoting <br>
<code>$session = New-PSSession $srv</code> открыть сессию <br>
<code>Get-PSSession</code> отобразить активные сессии <br>
<code>icm -Session $session {$srv = $using:srv}</code> передать переменную текущей сессии ($using) в удаленную <br>
<code>Disconnect-PSSession $session</code> закрыть сессию <br>
<code>Remove-PSSession $session</code> удалить сессию <br>
<code>Import-Module -Name ActiveDirectory -PSSession $srv</code> импортировать модуль с удаленного компьютера в локальную сессию</p>
<h3 id="windows-remote-management-configuration">Windows Remote Management Configuration</h3>
<p><code>winrm quickconfig -quiet</code> изменит запуск службы WinRM на автоматический, задаст стандартные настройки WinRM и добавить исключения для портов в fw <br>
<code>Enable-PSRemoting –Force</code> включить PowerShell Remoting, работает только для доменного и частного сетевых профилей Windows <br>
<code>Enable-PSRemoting -SkipNetworkProfileCheck -Force</code> для настройки компьютера в общей (public) сети (работает с версии powershell 6)</p>
<p><code>$NetProfiles = Get-NetConnectionProfile</code> отобразить профили сетевых подключений <br>
<code>Set-NetConnectionProfile -InterfaceIndex $NetProfiles[1].InterfaceIndex -NetworkCategory Private</code> изменить тип сети для профиля (DomainAuthenticated/Public) <br>
<code>(Get-CimInstance -ClassName Win32_ComputerSystem).PartOfDomain</code> проверить, что компьютер добавлен в домен AD <br>
<code>Get-Service WinRM | Set-Service -StartupType AutomaticDelayedStart</code> отложенный запуск <br>
<code>Get-Service -Name winrm -RequiredServices</code> статус зависимых служб <br>
<code>New-NetFirewallRule -Profile Any -DisplayName &quot;WinRM HTTP&quot; -Direction Inbound -Protocol TCP -LocalPort 5985,5986</code> <br>
<code>Test-NetConnection $srv -port 5895</code> проверить порт <br>
<code>Test-WSMan $srv -ErrorAction Ignore</code> проверить работу WinRM на удаленном компьютере (игнорировать вывод ошибок для скрипта) или локально (localhost)</p>
<p><code>$Cert = New-SelfSignedCertificate -CertStoreLocation Cert:\LocalMachine\My -DnsName &quot;$env:computername&quot; -FriendlyName &quot;WinRM HTTPS Certificate&quot; -NotAfter (Get-Date).AddYears(5)</code> создать самоподписанный сертификат <br>
<code>$Thumbprint = $Cert.Thumbprint</code> забрать отпечаток <br>
<code>New-Item -Path WSMan:\Localhost\Listener -Transport HTTPS -Address * -CertificateThumbprint $Thumbprint -Name WinRM_HTTPS_Listener -Force</code> создать прослушиватель <br>
<code>New-NetFirewallRule -DisplayName 'WinRM HTTPS' -Profile Domain,Private -Direction Inbound -Action Allow -Protocol TCP -LocalPort 5986</code> открыть порт в fw</p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="$selector_set%20=%20@%7b%0d%0a%20%20%20%20Address%20=%20%22*%22%0d%0a%20%20%20%20Transport%20=%20%22HTTPS%22%0d%0a%7d%0d%0a$value_set%20=%20@%7b%0d%0a%20%20%20%20CertificateThumbprint%20=%20%2266ABFDA044D8C85135048186E2FDC0DBE6125163%22%0d%0a%7d%0d%0aNew-WSManInstance%20-ResourceURI%20%22winrm/config/Listener%22%20-SelectorSet%20$selector_set%20-ValueSet%20$value_set">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>$selector_set = @{
    Address = &#34;*&#34;
    Transport = &#34;HTTPS&#34;
}
$value_set = @{
    CertificateThumbprint = &#34;66ABFDA044D8C85135048186E2FDC0DBE6125163&#34;
}
New-WSManInstance -ResourceURI &#34;winrm/config/Listener&#34; -SelectorSet $selector_set -ValueSet $value_set</code></pre>
    
</div>
<p><code>winrm get winrm/config</code> отобразить всю конфигурацию (Client/Service) <br>
<code>winrm get winrm/config/service/auth</code> конфигурация авторизации на сервере <br>
<code>winrm enumerate winrm/config/listener</code> текущая конфигурация прослушивателей WinRM (отображает отпечаток сертификата для HTTPS 5986) <br>
<code>Get-ChildItem -Path Cert:\LocalMachine\My\ | where Thumbprint -eq D9356FB774EE0E6206B7D5B59B99102CA5B17BDA | select *</code> информация о сертификате</p>
<p><code>ls WSMan:\localhost\Client</code> конфигурацию клиента <br>
<code>ls WSMan:\localhost\Service</code> конфигурация сервера <br>
<code>ls WSMan:\localhost\Service\auth</code> список всех конфигураций аутентификации WinRM сервера <br>
<code>Set-Item -path WSMan:\localhost\Service\auth\basic -value $true</code> разрешить локальную аутентификацию к текущему серверу <br>
<code>ls HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WSMAN</code> настройки в реестре (например, для включения аудентификации в \Service\auth_basic = 1) <br>
<code>Set-Item WSMan:\localhost\Client\TrustedHosts -Value 192.168.* -Force</code> добавить доверенные хосты в конфигурацию на клиенте, чтобы работала Negotiate аутентификация через NTLM <br>
<code>Set-Item WSMan:\localhost\Client\TrustedHosts -Value 192.168.3.100 -Concatenate -Force</code> добавить второй компьютер <br>
<code>ls WSMan:\localhost\Client\TrustedHosts</code> <br>
<code>Set-Item WSMan:\localhost\Client\AllowUnencrypted $true</code> включить передача незашифрованных данных конфигурации клиента <br>
<code>Set-Item WSMan:\localhost\Service\AllowUnencrypted $true</code> включить передача незашифрованных данных конфигурации сервера (необходимо быть в private сети)</p>
<p><code>Get-PSSessionConfiguration</code> проверить, включен ли PSremoting и вывести список пользователей и групп, которым разрешено подключаться через WinRM <br>
<code>Set-PSSessionConfiguration -Name Microsoft.PowerShell -ShowSecurityDescriptorUI</code> назначить права доступа через дескриптор безопасности текущей сессии (до перезагруки) <br>
<code>(Get-PSSessionConfiguration -Name &quot;Microsoft.PowerShell&quot;).SecurityDescriptorSDDL</code> получить настройки дескриптора в формате SDDL <br>
<code>Set-PSSessionConfiguration -Name Microsoft.PowerShell -SecurityDescriptorSDDL $SDDL</code> применить настройки дескриптора на другом компьютере без использования GUI \</p>
<p><code>New-LocalUser &quot;WinRM-Writer&quot; -Password (ConvertTo-SecureString -AsPlainText &quot;123098&quot;)</code> создать пользователя <br>
<code>Add-LocalGroupMember -Group &quot;Remote Management Users&quot; -Member &quot;WinRM-Writer&quot;</code> добавить пользователя WinRM-Writer в локальную группу доступа &ldquo;Пользователи удаленного управления&rdquo; <br>
<code>cmdkey /add:192.168.3.99 /user:WinRM-Writer /pass:123098</code> сохранить пароль в CredentialManager
<code>cmdkey /list</code> <br>
<code>Import-Module CredentialManager</code> <br>
<code>Add-Type -AssemblyName System.Web</code> <br>
<code>New-StoredCredential -Target 192.168.3.99 -UserName WinRM-Writer -Password 123098 -Comment WinRM</code> сохранить пароль в CredentialManager (из PS5) <br>
<code>Get-StoredCredential -AsCredentialObject</code> <br>
<code>$cred = Get-StoredCredential -Target 192.168.3.99</code> <br>
<code>Enter-PSSession -ComputerName 192.168.3.99 -Credential $cred -Authentication Negotiate</code> <br>
<code>Enter-PSSession -ComputerName 192.168.3.99 -Credential $cred -Authentication Basic -Port 5985</code> работает при отключении allowunencrypted на стороне сервера и клиента <br>
<code>winrs -r:http://192.168.3.100:5985/wsman -u:WinRM-Writer -p:123098 ipconfig</code> передать команду через winrs (-?) <br>
<code>winrs -r:https://192.168.3.100:5985/wsman -u:WinRM-Writer -p:123098 -ssl ipconfig</code> через https <br>
<code>pwsh -Command &quot;Install-Module -Name PSWSMan&quot;</code> установить модуль для использования в Linux системе</p>
<h3 id="kerberos">Kerberos</h3>
<p><code>.\CheckMaxTokenSize.ps1 -Principals login -OSEmulation $true -Details $true</code> узнать размер токена пользователя в домене <br>
<code>Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\Kerberos\Parameters | select maxtokensize</code> максимальный размер токена на сервере <br>
<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\HTTP\Parameters</code> изменить размера, если заголовок пакета аутентификации превышает 16 Кб (из за большого кол-ва групп) <br>
<code>MaxFieldLength увеличить до 0000ffff (65535)</code> <br>
<code>MaxRequestBytes увеличить до 0000ffff (65535)</code></p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>GitHub</li>
            

            
                <li>Lifailon</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/Lifailon" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            

            
            

            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.123.8</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Mar 14 2024
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
