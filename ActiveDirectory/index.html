
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Lifailon">
      
      
        <link rel="canonical" href="https://lifailon.github.io/ActiveDirectory/">
      
      
        <link rel="prev" href="../ServerManager/">
      
      
        <link rel="next" href="../Exchange/">
      
      
      <link rel="icon" href="../Logo/PowerShell-Logo.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.20">
    
    
      
        <title>Active Directory - PowerShell Commands</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.66ac8b77.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CInter:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Inter"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/highlight/obsidian.min.css">
    
      <link rel="stylesheet" href="../assets/custom/headers.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rsat-remote-server-administration-tools" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PowerShell Commands" class="md-header__button md-logo" aria-label="PowerShell Commands" data-md-component="logo">
      
  <img src="../Logo/PowerShell-Logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PowerShell Commands
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Active Directory
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Lifailon/PS-Commands" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PowerShell Commands" class="md-nav__button md-logo" aria-label="PowerShell Commands" data-md-component="logo">
      
  <img src="../Logo/PowerShell-Logo.png" alt="logo">

    </a>
    PowerShell Commands
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Lifailon/PS-Commands" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Syntax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Syntax
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../FileSystem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    File System
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Threads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Threads
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Modules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modules
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dotNET/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    .NET
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../COM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    COM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ServerManager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Server Manager
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Active Directory
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Active Directory
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rsat-remote-server-administration-tools" class="md-nav__link">
    <span class="md-ellipsis">
      RSAT (Remote Server Administration Tools)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-module-activedirectory" class="md-nav__link">
    <span class="md-ellipsis">
      Import-Module ActiveDirectory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adsi-active-directory-service-interface" class="md-nav__link">
    <span class="md-ellipsis">
      ADSI (Active Directory Service Interface)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ldap-lightweight-directory-access-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      LDAP (Lightweight Directory Access Protocol)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#laps-local-admin-password-management" class="md-nav__link">
    <span class="md-ellipsis">
      LAPS (Local Admin Password Management)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recycle-bin" class="md-nav__link">
    <span class="md-ellipsis">
      Recycle Bin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thumbnailphoto" class="md-nav__link">
    <span class="md-ellipsis">
      thumbnailPhoto
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addomaincontroller" class="md-nav__link">
    <span class="md-ellipsis">
      ADDomainController
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adcomputer" class="md-nav__link">
    <span class="md-ellipsis">
      ADComputer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aduser" class="md-nav__link">
    <span class="md-ellipsis">
      ADUser
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adgroupmember" class="md-nav__link">
    <span class="md-ellipsis">
      ADGroupMember
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adreplication" class="md-nav__link">
    <span class="md-ellipsis">
      ADReplication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repadmin" class="md-nav__link">
    <span class="md-ellipsis">
      repadmin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dcdiag" class="md-nav__link">
    <span class="md-ellipsis">
      dcdiag
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntdsutil" class="md-nav__link">
    <span class="md-ellipsis">
      ntdsutil
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpo" class="md-nav__link">
    <span class="md-ellipsis">
      GPO
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Exchange/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Microsoft Exchange
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Virtualization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Virtualization
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../MarkupLanguages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Markup Languages
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../DevOps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevOps
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../API/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SCM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SCM
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Ansible/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ansible
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Zabbix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Zabbix
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🐧 Linux
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rsat-remote-server-administration-tools" class="md-nav__link">
    <span class="md-ellipsis">
      RSAT (Remote Server Administration Tools)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-module-activedirectory" class="md-nav__link">
    <span class="md-ellipsis">
      Import-Module ActiveDirectory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adsi-active-directory-service-interface" class="md-nav__link">
    <span class="md-ellipsis">
      ADSI (Active Directory Service Interface)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ldap-lightweight-directory-access-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      LDAP (Lightweight Directory Access Protocol)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#laps-local-admin-password-management" class="md-nav__link">
    <span class="md-ellipsis">
      LAPS (Local Admin Password Management)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recycle-bin" class="md-nav__link">
    <span class="md-ellipsis">
      Recycle Bin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#thumbnailphoto" class="md-nav__link">
    <span class="md-ellipsis">
      thumbnailPhoto
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addomaincontroller" class="md-nav__link">
    <span class="md-ellipsis">
      ADDomainController
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adcomputer" class="md-nav__link">
    <span class="md-ellipsis">
      ADComputer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aduser" class="md-nav__link">
    <span class="md-ellipsis">
      ADUser
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adgroupmember" class="md-nav__link">
    <span class="md-ellipsis">
      ADGroupMember
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adreplication" class="md-nav__link">
    <span class="md-ellipsis">
      ADReplication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repadmin" class="md-nav__link">
    <span class="md-ellipsis">
      repadmin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dcdiag" class="md-nav__link">
    <span class="md-ellipsis">
      dcdiag
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntdsutil" class="md-nav__link">
    <span class="md-ellipsis">
      ntdsutil
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpo" class="md-nav__link">
    <span class="md-ellipsis">
      GPO
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Active Directory</h1>

<h2 id="rsat-remote-server-administration-tools">RSAT (Remote Server Administration Tools)</h2>
<p><code>DISM.exe /Online /add-capability /CapabilityName:Rsat.ActiveDirectory.DS-LDS.Tools~~~~0.0.1.0 /CapabilityName:Rsat.GroupPolicy.Management.Tools~~~~0.0.1.0</code> <br />
<code>Add-WindowsCapability –online –Name Rsat.Dns.Tools~~~~0.0.1.0</code> <br />
<code>Add-WindowsCapability -Online -Name Rsat.DHCP.Tools~~~~0.0.1.0</code> <br />
<code>Add-WindowsCapability –online –Name Rsat.FileServices.Tools~~~~0.0.1.0</code> <br />
<code>Add-WindowsCapability -Online -Name Rsat.WSUS.Tools~~~~0.0.1.0</code> <br />
<code>Add-WindowsCapability -Online -Name Rsat.CertificateServices.Tools~~~~0.0.1.0</code> <br />
<code>Add-WindowsCapability -Online -Name Rsat.RemoteDesktop.Services.Tools~~~~0.0.1.0</code> <br />
<code>Get-WindowsCapability -Name RSAT* -Online | Select-Object -Property DisplayName, State</code> отобразить список установленных компанентов</p>
<h2 id="import-module-activedirectory">Import-Module ActiveDirectory</h2>
<p><code>$Session = New-PSSession -ComputerName $srv</code> -Credential $cred <br />
<code>Export-PSsession -Session $Session -Module ActiveDirectory -OutputModule ActiveDirectory</code> экспортировать модуль из удаленной сесси (например, с DC) <br />
<code>Remove-PSSession -Session $Session</code> <br />
<code>Import-Module ActiveDirectory</code> <br />
<code>Get-Command -Module ActiveDirectory</code></p>
<h2 id="adsi-active-directory-service-interface">ADSI (Active Directory Service Interface)</h2>
<p><code>$d0 = $env:userdnsdomain</code> <br />
<code>$d0 = $d0 -split "\."</code> <br />
<code>$d1 = $d0[0]</code> <br />
<code>$d2 = $d0[1]</code> <br />
<code>$group = [ADSI]"LDAP://OU=Domain Controllers,DC=$d1,DC=$d2"</code> <br />
<code>$group | select *</code></p>
<p><code>$Local_User = [ADSI]"WinNT://./Администратор,user"</code> <br />
<code>$Local_User | Get-Member</code> <br />
<code>$Local_User.Description</code> <br />
<code>$Local_User.LastLogin</code> время последней авторизации локального пользователя</p>
<h2 id="ldap-lightweight-directory-access-protocol">LDAP (Lightweight Directory Access Protocol)</h2>
<p><code>$ldapsearcher = New-Object System.DirectoryServices.DirectorySearcher</code> <br />
<code>$ldapsearcher.SearchRoot = "LDAP://OU=Domain Controllers,DC=$d1,DC=$d2"</code> <br />
<code>$ldapsearcher.Filter = "(objectclass=computer)"</code> <br />
<code>$dc = $ldapsearcher.FindAll().path</code></p>
<p><code>$usr = $env:username</code> cписок групп текущего пользователя <br />
<code>$ldapsearcher = New-Object System.DirectoryServices.DirectorySearcher</code> <br />
<code>$ldapsearcher.Filter = "(&amp;(objectCategory=User)(samAccountName=$usr))"</code> <br />
<code>$usrfind = $ldapsearcher.FindOne()</code> <br />
<code>$groups = $usrfind.properties.memberof -replace "(,OU=.+)"</code> <br />
<code>$groups = $groups -replace "(CN=)"</code></p>
<p>DC (Domain Component) - компонент доменного имени <br />
OU (Organizational Unit) - организационные подразделения (type), используются для упорядочения объектов <br />
Container - так же используется для упорядочения объектов, контейнеры в отличии от подраделений не могут быть переименованы, удалены, созданы или связаны с объектом групповой политики (Computers, Domain Controllers, Users) <br />
DN (Distinguished Name) — уникальное имя объекта и местоположение в лесу AD. В DN описывается содержимое атрибутов в дереве (путь навигации), требуемое для доступа к конкретной записи или ее поиска <br />
CN (Common Name) - общее имя</p>
<p><code>(Get-ADObject (Get-ADRootDSE).DefaultNamingContext -Properties wellKnownObjects).wellKnownObjects</code> отобразить отобразить контейнеры по умолчанию <br />
<code>redircmp OU=Client Computers,DC=root,DC=domain,DC=local</code> изменить контейнер компьютеров по умолчанию <br />
<code>redirusr</code> изменить контейнер пользователей по умолчанию</p>
<h2 id="laps-local-admin-password-management">LAPS (Local Admin Password Management)</h2>
<p><code>Import-module AdmPwd.ps</code> импортировать модуль <br />
<code>Get-AdmPwdPassword -ComputerName NAME</code> посмотреть пароль <br />
<code>Reset-AdmPwdPassword -ComputerName NAME</code> изменить пароль <br />
<code>Get-ADComputer -Filter * -SearchBase "DC=$d1,DC=$d2" | Get-AdmPwdPassword -ComputerName {$_.Name} | select ComputerName,Password,ExpirationTimestamp | Out-GridView</code> <br />
<code>Get-ADComputer -Identity $srv | Get-AdmPwdPassword -ComputerName {$_.Name} | select ComputerName,Password,ExpirationTimestamp</code></p>
<h2 id="recycle-bin">Recycle Bin</h2>
<p>Удаленные объекты хранятся в корзине AD в течении времени захоронения (определяется в атрибуте домена msDS-deletedObjectLifetime), заданном для леса. По умолчанию это 180 дней. Если данный срок прошел, объект все еще остается в контейнере Deleted Objects, но большинство его атрибутов и связей очищаются (Recycled Object). После истечения периода tombstoneLifetime (по умолчанию также 180 дней, но можно увеличить) объект полностью удаляется из AD автоматическим процессом очистки. <br />
<code>Get-ADForest domain.local</code> отобразить уровень работы леса <br />
<code>Set-ADForestMode -Identity domain.local -ForestMode Windows2008R2Forest -force</code> увеличить уровень работы леса <br />
<code>Enable-ADOptionalFeature –Identity "CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,DC=domain,DC=local" –Scope ForestOrConfigurationSet –Target "domain.local"</code> включить корзину <br />
<code>Get-ADOptionalFeature "Recycle Bin Feature" | select-object name,EnabledScopes</code> если значение EnabledScopes не пустое, значит в домене корзина Active Directory включена <br />
<code>Get-ADObject -Filter 'Name -like "*tnas*"' -IncludeDeletedObjects</code> найти удаленную (Deleted: True) УЗ (ObjectClass: user) в AD <br />
<code>Get-ADObject -Filter 'Name -like "*tnas*"' –IncludeDeletedObjects -Properties *| select-object Name, sAMAccountName, LastKnownParent, memberOf, IsDeleted | fl</code> проверить значение атрибута IsDeleted, контейнер, в котором находился пользователе перед удалением (LastKnownParent) и список групп, в которых он состоял <br />
<code>Get-ADObject –filter {Deleted -eq $True -and ObjectClass -eq "user"} –includeDeletedObjects</code> вывести список удаленных пользователей <br />
<code>Restore-ADObject -Identity "3dc33c7c-b912-4a19-b1b7-415c1395a34e"</code> восстановить по значению атрибута ObjectGUID <br />
<code>Get-ADObject -Filter 'SAMAccountName -eq "tnas-01"' –IncludeDeletedObjects | Restore-ADObject</code> восстановить по SAMAccountName <br />
<code>Get-ADObject -Filter {Deleted -eq $True -and ObjectClass -eq 'group' -and Name -like '*Allow*'} –IncludeDeletedObjects | Restore-ADObject –Verbose</code> восстановить группу или компьютер</p>
<h2 id="thumbnailphoto">thumbnailPhoto</h2>
<p><code>$photo = [byte[]](Get-Content C:\Install\adm.jpg -Encoding byte)</code> преобразовать файл картинки в массив байтов (jpeg/bmp файл, размером фото до 100 Кб и разрешением 96?96) <br />
<code>Set-ADUser support4 -Replace @{thumbnailPhoto=$photo}</code> задать значение атрибута thumbnailPhoto</p>
<h2 id="addomaincontroller">ADDomainController</h2>
<p><code>Get-ADDomainController</code> выводит информацию о текущем контроллере домена (LogonServer), который используется данным компьютером для аутентификации (DC выбирается при загрузке в соответствии с топологией сайтов AD) <br />
<code>Get-ADDomainController -Discover -Service PrimaryDC</code> найти контроллер с ролью PDC в домене <br />
<code>Get-ADDomainController -Filter * | ft HostName,IPv4Address,Name,Site,OperatingSystem,IsGlobalCatalog</code> список все DC, принадлежность к сайту, версии ОС и GC</p>
<p>При загрузке ОС служба NetLogon делает DNS запрос со списком контроллеров домена (к SRV записи <em>ldap._tcp.dc._msdcs.domain</em>), DNS возвращает список DC в домене с записью Service Location (SRV). Клиент делает LDAP запрос к DC для определения сайта AD по своему IP адресу. Клиент через DNS запрашивает список контроллеров домена в сайте (в разделе _tcp.sitename._sites...).</p>
<p>USN (Update Sequence Numbers) - счетчик номера последовательного обновления, который существует у каждого объекта AD. При репликации контроллеры обмениваются значениями USN, объект с более низким USN будет при репликации перезаписан объектом с более высоким USN. Находится в свойствах - Object (включить View - Advanced Features). Каждый контроллер домена содержит отдельный счетчик USN, который начинает отсчет в момент запуска процесса Dcpromo и продолжает увеличивать значения в течение всего времени существования контроллера домена. Значение счетчика USN увеличивается каждый раз, когда на контроллере домена происходит транзакция, это операции создания, обновления или удаления объекта.</p>
<p><code>Get-ADDomainController -Filter * | % {</code> отобразить USN объекта на всех DC в домене<code></code>Get-ADUser -Server $_.HostName -Identity support4 -Properties uSNChanged | select SamAccountName,uSNChanged<code></code>}`</p>
<p><code>dcpromo /forceremoval</code> принудительно выполнит понижение в роли контроллера домена до уровня рядового сервера. После понижения роли выполняется удаление всех ссылок в домене на этот контроллер. Далее производит включение сервера в состав домена, и выполнение обратного процесса, т.е. повышение сервера до уровня контроллера домена.</p>
<h2 id="adcomputer">ADComputer</h2>
<p><code>nltest /DSGETDC:$env:userdnsdomain</code> узнать на каком DC аудентифицирован хост (Logon Server) <br />
<code>nltest /SC_RESET:$env:userdnsdomain\srv-dc2.$env:userdnsdomain</code> переключить компьютер на другой контроллер домена AD вручную (The command completed successfully) <br />
<code>Get-ADComputer –Identity $env:computername -Properties PasswordLastSet</code> время последней смены пароля на сервере <br />
<code>Test-ComputerSecureChannel –verbose</code> проверить доверительные отношения с доменом (соответствует ли локальный пароль компьютера паролю, хранящемуся в AD) <br />
<code>Reset-ComputerMachinePassword -Credential domain\admin</code> принудительно обновить пароль <br />
<code>Netdom ResetPWD /Server:dc-01 /UserD:domain\admin /PasswordD:*</code> сбросить хэш пароля компьютера в домене (перезагрузка не требуется) <br />
<code>Search-ADAccount -AccountDisabled -ComputersOnly | select Name,LastLogonDate,Enabled</code> отобразить все отключенные компьютеры</p>
<p><code>Get-ADComputer -Filter * -Properties * | select name</code> список всех компьютеров в домене (Filter), вывести все свойства (Properties) <br />
<code>Get-ADComputer -Identity $srv -Properties * | ft Name,LastLogonDate,PasswordLastSet,ms-Mcs-AdmPwd -Autosize</code> конкретного компьютера в AD (Identity) <br />
<code>Get-ADComputer -SearchBase "OU=Domain Controllers,DC=$d1,DC=$d2" -Filter * -Properties * | ft Name, LastLogonDate, distinguishedName -Autosize</code> поиск в базе по DN (SearchBase)</p>
<p><code>(Get-ADComputer -Filter {enabled -eq "true"}).count</code> получить общее количество активных (незаблокированных) компьютеров <br />
<code>(Get-ADComputer -Filter {enabled -eq "true" -and OperatingSystem -like "*Windows Server 2016*"}).count</code> кол-во активных копьютеров с ОС WS 2016</p>
<p><code>Get-ADComputer -Filter * -Properties * | select @{Label="Ping Status"; Expression={</code> <br />
<code>$ping = ping -n 1 -w 50 $_.Name</code> <br />
<code>if ($ping -match "TTL") {"Online"} else {"Offline"}</code> <br />
<code>}},</code> <br />
<code>@{Label="Status"; Expression={</code> <br />
<code>if ($_.Enabled -eq "True") {$_.Enabled -replace "True","Active"} else {$_.Enabled -replace "False","Blocked"}</code> <br />
<code>}}, Name, IPv4Address, OperatingSystem, @{Label="UserOwner"; Expression={$_.ManagedBy -replace "(CN=|,.+)"}</code> <br />
<code>},Created | Out-GridView</code></p>
<h2 id="aduser">ADUser</h2>
<p><code>Get-ADUser -Identity support4 -Properties *</code> список всех атрибутов <br />
<code>Get-ADUser -Identity support4 -Properties DistinguishedName, EmailAddress, Description</code> путь DN, email и описание <br />
<code>Get-ADUser -Filter {(Enabled -eq "True") -and (mail -ne "null")} -Properties mail | ft Name,mail</code> список активных пользователей и есть почтовый ящик <br />
<code>Get-ADUser -Filter {SamAccountName -like "*"} | Measure-Object</code> посчитать кол-во всех аккаунтов (Count) <br />
<code>Get-ADUser -Filter * -Properties WhenCreated | sort WhenCreated | ft Name, whenCreated</code> дата создания <br />
<code>Get-ADUser -Identity support4 -property LockedOut | select samaccountName,Name,Enabled,Lockedout</code> <br />
<code>Enabled=True</code> учетная запись включена - да <br />
<code>Lockedout=False</code> учетная запись заблокирована (например, политикой паролей) - нет <br />
<code>Get-ADUser -Identity support4 | Unlock-ADAccount</code> разблокировать учетную запись <br />
<code>Disable-ADAccount -Identity support4</code> отключить учетную запись <br />
<code>Enable-ADAccount -Identity support4</code> включить учетную запись <br />
<code>Search-ADAccount -LockedOut</code> найти все заблокированные учетные записи <br />
<code>Search-ADAccount -AccountDisabled | select Name,LastLogonDate,Enabled</code> отобразить все отключенные учетные записи с временем последнего входа</p>
<p><code>Get-ADUser -Identity support4 -Properties PasswordLastSet,PasswordExpired,PasswordNeverExpires</code> <br />
<code>PasswordLastSet</code> время последней смены пароля <br />
<code>PasswordExpired=False</code> пароль истек - нет <br />
<code>PasswordNeverExpires=True</code> срок действия пароля не истекает - да <br />
<code>Set-ADAccountPassword support4 -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "password" -Force -Verbose)</code> изменить пароль учетной записи <br />
<code>Set-ADUser -Identity support4 -ChangePasswordAtLogon $True</code> смена пароля при следующем входе в систему</p>
<p><code>$day = (Get-Date).adddays(-90)</code> <br />
<code>Get-ADUser -filter {(passwordlastset -le $day)} | ft</code> пользователи, которые не меняли свой пароль больше 90 дней</p>
<p><code>$day = (Get-Date).adddays(-30)</code> <br />
<code>Get-ADUser -filter {(Created -ge $day)} -Property Created | select Name,Created</code> Новые пользователи за 30 дней</p>
<p><code>$day = (Get-Date).adddays(-360)</code> <br />
<code>Get-ADUser -Filter {(LastLogonTimestamp -le $day)} -Property LastLogonTimestamp | select Name,SamAccountName,@{n='LastLogonTimestamp';e={[DateTime]::FromFileTime($_.LastLogonTimestamp)}} | sort -Descending LastLogonTimestamp</code> пользователи, которые не логинились больше 360 дней. Репликация атрибута LastLogonTimestamp составляет от 9 до 14 дней. <br />
<code>| Disable-ADAccount $_.SamAccountName</code> заблокировать <br />
<code>-WhatIf</code> отобразить вывод без применения изменений</p>
<h2 id="adgroupmember">ADGroupMember</h2>
<p><code>(Get-ADUser -Identity support4 -Properties MemberOf).memberof</code> список групп в которых состоит пользователь <br />
<code>Get-ADGroupMember -Identity "Domain Admins" | Select Name,SamAccountName</code> список пользователей в группе <br />
<code>Add-ADGroupMember -Identity "Domain Admins" -Members support5</code> добавить в группу <br />
<code>Remove-ADGroupMember -Identity "Domain Admins" -Members support5 -force</code> удалить из группы <br />
<code>Get-ADGroup -filter * | where {!($_ | Get-ADGroupMember)} | Select Name</code> отобразить список пустых групп (-Not)</p>
<h2 id="adreplication">ADReplication</h2>
<p><code>Get-Command -Module ActiveDirectory -Name *Replication*</code> список всех командлетов модуля <br />
<code>Get-ADReplicationFailure -Target dc-01</code> список ошибок репликации с партнерами <br />
<code>Get-ADReplicationFailure -Target $env:userdnsdomain -Scope Domain</code> <br />
<code>Get-ADReplicationPartnerMetadata -Target dc-01 | select Partner,LastReplicationAttempt,LastReplicationSuccess,LastReplicationResult,LastChangeUsn</code> время последней и время успешной репликации с партнерами <br />
<code>Get-ADReplicationUpToDatenessVectorTable -Target dc-01</code> Update Sequence Number (USN) увеличивается каждый раз, когда на контроллере домена происходит транзакция (операции создания, обновления или удаления объекта), при репликации DC обмениваются значениями USN, объект с более низким USN при репликации будет перезаписан высоким USN.</p>
<h2 id="repadmin">repadmin</h2>
<p><code>repadmin /replsummary</code> отображает время последней репликации на всех DC по направлению (Source и Destination) и их состояние с учетом партнеров <br />
<code>repadmin /showrepl $srv</code> отображает всех партнеров по реплкации и их статус для всех разделов Naming Contexts (DC=ForestDnsZones, DC=DomainDnsZones, CN=Schema, CN=Configuration) <br />
<code>repadmin /replicate $srv2 $srv1 DC=domain,DC=local</code> выполнить репликацию с $srv1 на $srv2 только указанный раздела домена <br />
<code>repadmin /SyncAll /AdeP</code> запустить межсайтовую исходящую репликацию всех разделов от текущего сервера со всеми партнерами по репликации <br />
<code>/A</code> выполнить для всех разделов NC <br />
<code>/d</code> в сообщениях идентифицировать серверы по DN (вместо GUID DNS - глобальным уникальным идентификаторам) <br />
<code>/e</code> межсайтовая синхронизация (по умолчанию синхронизирует только с DC текущего сайта) <br />
<code>/P</code> извещать об изменениях с этого сервера (по умолчанию: опрашивать об изменениях) <br />
<code>repadmin /Queue $srv</code> отображает кол-во запросов входящей репликации (очередь), которое необходимо обработать (причиной может быть большое кол-во партнеров или формирование 1000 объектов скриптом) <br />
<code>repadmin /showbackup *</code> узнать дату последнего Backup</p>
<p><code>Error: 1722</code> сервер rpc недоступен (ошибка отката репликации). Проверить имя домена в настройках сетевого адаптера, первым должен идти адрес DNS-сервера другого контроллера домена, вторым свой адрес. <br />
<code>Get-Service -ComputerName $srv | select name,status | ? name -like "RpcSs"</code> <br />
<code>Get-Service -ComputerName $srv -Name RpcSs -RequiredServices</code> зависимые службы <br />
Зависимые службы RPC: <br />
"Служба сведений о подключенных сетях" - должен быть включен отложенный запуск. Если служба срабатывает до "службы списка сетей", может падать связь с доменом (netlogon) <br />
"Центр распространения ключей Kerberos" <br />
"DNS-сервер" <br />
<code>nslookup $srv</code> <br />
<code>tnc $srv -p 135</code> <br />
<code>repadmin /retry</code> повторить попытку привязки к целевому DC, если была ошибка 1722 или 1753 (RPC недоступен)</p>
<p><code>repadmin /showrepl $srv</code> <br />
<code>Last attempt @ 2022-07-15 10:46:01 завершена с ошибкой, результат 8456 (0x2108)</code> при проверки showrepl этого партнера, его ошибка: 8457 (0x2109) <br />
<code>Last success @ 2022-07-11 02:29:46</code> последний успех <br />
Когда репликация автоматически отключена, ОС записывает в DSA - not writable одно из четырех значений: <br />
<code>Path: HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\NTDS\Parameters</code> <br />
<code>Dsa Not Writable</code> <br />
<code>##define DSA_WRITABLE_GEN 1</code> версия леса несовместима с ОС <br />
<code>##define DSA_WRITABLE_NO_SPACE 2</code> на диске, где размещена база данных Active Directory или файлы журналов (логи), недостаточно свободного места <br />
<code>##define DSA_WRITABLE_USNROLLBCK 4</code> откат USN произошел из-за неправильного отката базы данных Active Directory во времени (восстановление из снапшота) <br />
<code>##define DSA_WRITABLE_CORRUPT_UTDV 8</code> вектор актуальности поврежден на локальном контроллере домена</p>
<h2 id="dcdiag">dcdiag</h2>
<p><code>dcdiag /s:&lt;DomainController&gt; [/n:&lt;NamingContext&gt;] [[/u:&lt;domain\user&gt;] [/p:&lt;password&gt;]] [{/a|/e}{/q|/v}] [/f:&lt;LogFile&gt;] [/ferr:&lt;ErrorLog&gt;] [/test:&lt;test&gt;] [/fix]</code> <br />
<code>dcdiag /Test:replications /s:dc-01</code> отображает ошибки репликации <br />
<code>dcdiag /Test:DNS /e /v /q</code> тест DNS <br />
<code>/a</code> проверка всех серверов данного сайта <br />
<code>/e</code> проверка всех серверов предприятия <br />
<code>/q</code> выводить только сообщения об ошибках <br />
<code>/v</code> выводить подробную информацию <br />
<code>/fix</code> автоматически исправляет ошибки <br />
<code>/test:</code> <br />
<code>NetLogons</code> проверка наличие прав на выполнение репликации <br />
<code>Connectivity</code> проверяет регистрацию DNS для каждого контроллера домена, отправляет тестовый эхо-пакет на каждый контроллер домена и проверяет подключение по протоколам LDAP и RPC к каждому контроллеру домена <br />
<code>Services</code> проверяет работоспособность всех служб, необходимых для работы контроллера домена, на указанном контроллере домена <br />
<code>Systemlog</code> проверяет наличие ошибок в журналах контроллера домена <br />
<code>FRSEvent</code> проверяет ошибки репликации в работе службы репликации файлов, что может означать наличие проблем в репликации SYSVOL и, таким образом, целостности копий объектов групповых политик <br />
<code>FSMOCheck</code> не проверяет роли хозяев операций, а вместо этого запрашивает сервер глобального каталога, первичный контроллер домена, предпочтительный сервер времени, сервер времени и центр распространения ключей (контроллер домена может подключиться к KDC, PDC, серверу глобального каталога) <br />
<code>KnowsOfRoleHolders</code> пgроверяет возможность подключения контроллеров домена ко всем пяти хозяевам операций (ролями FSMO) <br />
<code>MachineAccount</code> проверяет правильность регистрации учетной записи целевого компьютера и правильность объявлений служб этого компьютера (корректность доверительных отношения с доменом). Если обнаружена ошибка, ее можно исправить с помощью утилиты dcdiag, указав параметры /fixmachineaccount или /recreatemachineaccount <br />
<code>Advertising</code> проверяет, правильно ли контроллер домена сообщает о себе и о своей роли хозяина операций. Этот тест завершиться неудачно, если служба NetLogon не запущена <br />
<code>CheckSDRefDom</code> проверяет правильность доменов ссылок дескрипторов безопасности для каждого раздела каталогов программ <br />
<code>CrossRefValidation</code> проверяет правильность перекрестных ссылок для доменов <br />
<code>RRSSysvol</code> проверяет состояние готовности для FRS SYSVOL <br />
<code>Intersite</code> проверяет наличие ошибок, которые могут помешать нормальной репликации между сайтами. Компания Microsoft предупреждает, что иногда результаты этого теста могут оказаться неточными <br />
<code>KCCEvent</code> проверяет безошибочность создания объектов соединений для репликации между сайтами <br />
<code>NCSecDesc</code> проверяет правильность разрешений для репликации в дескрипторах безопасности для заголовков контекста именования <br />
<code>ObjectsReplicated</code> проверяет правильность репликации агента сервера каталогов и объектов учетных записей компьютеров <br />
<code>OutboundSecureChannels</code> проверяется наличие безопасных каналов между всеми контроллерами домена в интересующем домене <br />
<code>Replications</code> проверяет возможность репликации между контроллерами домена и сообщает обо всех ошибках при репликации <br />
<code>RidManager</code> проверяет работоспособность и доступность хозяина относительных идентификаторов <br />
<code>VerifyEnterpriseReferences</code> проверяет действительность системных ссылок службы репликации файлов для всех объектов на всех контроллерах домена в лесу <br />
<code>VerifyReferences</code> проверяет действительность системных ссылок службы репликации файлов для всех объектов на указанном контроллере домена <br />
<code>VerifyReplicas</code> проверяет действительность всех разделов каталога приложения на всех серверах, принимающих участие в репликации</p>
<h2 id="ntdsutil">ntdsutil</h2>
<p>Перенос БД AD (ntds.dit): <br />
<code>Get-Acl C:\Windows\NTDS | Set-Acl D:\AD-DB</code> скопировать NTFS разрешения на новый каталог <br />
<code>Stop-Service -ComputerName dc -name NTDS</code> остановить службу Active Directory Domain Services <br />
<code>ntdsutil</code> запустить утилиту ntdsutil <br />
<code>activate instance NTDS</code> выбрать активный экземпляр базы AD <br />
<code>files</code> перейдем в контекст files, в котором возможно выполнение операция с файлами базы ntds.dit <br />
<code>move DB to D:\AD-DB\</code> перенести базу AD в новый каталог (предварительно нужно его создать) <br />
<code>info</code> проверить, что БД находится в новом каталоге <br />
<code>move logs to D:\AD-DB\</code> переместим в тот же каталог файлы с журналами транзакций <br />
<code>quit</code> <br />
<code>Start-Service -ComputerName dc -name NTDS</code></p>
<p>Сброс пароля DSRM (режим восстановления служб каталогов):<br />
<code>ntdsutil</code> <br />
<code>set dsrm password</code> <br />
<code>reset password on server NULL</code> <br />
новый пароль <br />
подтверждение пароля <br />
<code>quit</code> <br />
<code>quit</code></p>
<p>Синхронизировать с паролем УЗ в AD: <br />
<code>ntdsutil</code> <br />
<code>set dsrm password</code> <br />
<code>sync from domain account dsrmadmin</code> <br />
<code>quit</code> <br />
<code>quit</code></p>
<p>Ошибка 0x00002e2 при загрузке ОС. <br />
Загрузиться в режиме восстанавления WinRE (Windows Recovery Environment) - Startup Settings - Restart - DSRM (Directory Services Restore Mode) <br />
<code>reagentc /boottore</code> shutdown /f /r /o /t 0 перезагрузка в режиме WinRE - ОС на базе WinPE (Windows Preinstallation Environment), образ winre.wim находится на скрытом разделе System Restore <br />
На контроллере домена единственная локальная учетная запись — администратор DSRM. Пароль создается при установке роли контроллера домена ADDS на сервере (SafeModeAdministratorPassword). <br />
<code>ntdsutil</code> <br />
<code>activate instance ntds</code> <br />
<code>Files</code> <br />
<code>Info</code> <br />
<code>integrity</code> проверить целостность БД <br />
Ошибка: Failed to open DIT for AD DS/LDS instance NTDS. Error -2147418113 <br />
<code>mkdir c:\ntds_bak</code> <br />
<code>xcopy c:\Windows\NTDS\*.* c:\ntds_bak</code> backup содержимого каталога с БД <br />
<code>esentutl /g c:\windows\ntds\ntds.dit</code> проверим целостность файла <br />
Вывод: Integrity check completed. Database is CORRUPTED ошибка, база AD повреждена <br />
<code>esentutl /p c:\windows\ntds\ntds.dit</code> исправить ошибки <br />
Вывод: Operation completed successfully in xx seconds. нет ошибок <br />
<code>esentutl /g c:\windows\ntds\ntds.dit</code> проверим целостность файла <br />
Выполнить анализ семантики базы с помощью ntdsutil: <br />
<code>ntdsutil</code> <br />
<code>activate instance ntds</code> <br />
<code>semantic database analysis</code> <br />
<code>go</code> <br />
<code>go fixup</code> исправить семантические ошибки <br />
Сжать файл БД: <br />
<code>activate instance ntds</code> <br />
<code>files</code> <br />
<code>compact to C:\Windows\NTDS\TEMP</code> <br />
<code>copy C:\Windows\NTDS\TEMP\ntds.dit C:\Windows\NTDS\ntds.dit</code> заменить оригинальный файл ntds.dit <br />
<code>Del C:\Windows\NTDS\*.log</code> удалить все лог файлы из каталога NTDS</p>
<h2 id="gpo">GPO</h2>
<p><code>Get-Command -Module GroupPolicy</code> <br />
<code>Get-GPO -Domain domain.local -All | ft</code> <br />
<code>Get-GPO -Name LAPS</code> <br />
<code>[xml](Get-GPOReport LAPS -ReportType Xml)</code> <br />
<code>Get-GPPermission -Name LAPS -All</code> <br />
<code>Get-GPO LAPS | New-GPLink -Target "ou=servers,dc=domain,dc=local"</code> <br />
<code>Set-GPLink -Name LAPS -Target "ou=servers,dc=domain,dc=local" -LinkEnabled No</code> <br />
<code>Backup-GPO -Name LAPS -Path "$home\Desktop"</code> <br />
<code>Backup-GPO -All -Path "$home\Desktop"</code> <br />
<code>Restore-GPO -Name LAPS -Path C:\Backup\GPOs\</code></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2023-2024 Alex Kup (Lifailon)
    </div>
  
  
  PowerShell Commands on
  <a href="https://github.com/Lifailon/PS-Commands" target="_blank" rel="noopener">
    GitHub
  </a>
  | Theme
  <a href="https://github.com/squidfunk/mkdocs-material" target="_blank" rel="noopener">
    Material
  </a>
  for
  <a href="https://github.com/mkdocs/mkdocs" target="_blank" rel="noopener">
    MkDocs
  </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/Lifailon/PS-Commands" target="_blank" rel="noopener" title="PS-Commands on Github" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.dd8806f2.min.js"></script>
      
        <script src="../assets/highlight/highlight.min.js"></script>
      
        <script src="../assets/highlight/powershell.min.js"></script>
      
        <script src="../assets/highlight/init.js"></script>
      
    
  </body>
</html>