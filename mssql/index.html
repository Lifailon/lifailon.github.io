<!DOCTYPE html>
<html lang="en-us">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.123.8">

    

    

    
        
            <meta
                name="description"
                content="Large base of PowerShell notes in Russian language" />
        

        
            <meta
                name="keywords"
                content="PowerShell" />
        

        
            <meta name="author" content="Lifailon" />
        

    


    <title>
        
            MS SQL |
            Lifailon.GitHub.io
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
        


        
        


        <link
            rel="stylesheet"
            href="/css/index_d751713.min.912d03bce61461ecbc3ca083479e1ed814bba94df76d0bdc6aa88fdca33621b9bb410dc2c81af31e8101fec62decfa5f6e48901ad673bc5056d2f1d1f2368a34.css"
            integrity="sha512-kS0DvOYUYey8PKCDR54e2BS7qU33bQvcaqiP3KM2Ibm7QQ3CyBrzHoEB/sYt7PpfbkiQGtZzvFBW0vHR8jaKNA==" />
    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            MS SQL -
            Lifailon.GitHub.io
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/github/" title="./github/">
                        GitHub
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/powershell/" title="./powershell/">
                        PowerShell
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/dotnet/" title="./dotnet/">
                        .NET
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/activedirectory/" title="./activedirectory/">
                        Active Directory
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/ansible/" title="./ansible/">
                        Ansible
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/api/" title="./api/">
                        API
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/apps/" title="./apps/">
                        Apps
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/com/" title="./com/">
                        Component Object Model
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/git/" title="./git/">
                        Git
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/html/" title="./html/">
                        HTML
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/influxdb/" title="./influxdb/">
                        InfluxDB
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/exchange/" title="./exchange/">
                        MS Exchange
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/mssql/" title="./mssql/">
                        MS SQL
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/mysql/" title="./mysql/">
                        MySQL
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/network/" title="./network/">
                        Network
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/virtualization/" title="./virtualization/">
                        Virtualization
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/wmi/" title="./wmi/">
                        WMI
                    </a>
                </li>
            
        
            
                <li class="file">
                    <a href="https://lifailon.github.io/zabbix/" title="./zabbix/">
                        Zabbix
                    </a>
                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                MS SQL
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/lifailon/"
                                class="cat-btn">
                                Lifailon
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="Mar 14 2024"
                            >Mar 14 2024
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        11 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    




<a href="https://lifailon.github.io/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="https://lifailon.github.io/mssql/" class="bread-btn">
    

    
        MS SQL
    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#express">Express</a></li>
    <li><a href="#systemdatasqlclient">System.Data.SqlClient</a></li>
    <li><a href="#sqlclient-insert">SqlClient INSERT</a></li>
    <li><a href="#ssms-insert">SSMS INSERT</a></li>
    <li><a href="#t-sql">T-SQL</a></li>
    <li><a href="#тип-резервной-копии">Тип резервной копии</a></li>
    <li><a href="#модели-восстановления">Модели восстановления</a></li>
    <li><a href="#системные-бд">Системные БД</a></li>
    <li><a href="#регламентные-операции">Регламентные операции</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="express">Express</h2>
<p><code>wget -qO- https://packages.microsoft.com/keys/microsoft.asc | apt-key add -</code> импортировать GPG-ключ для репозитория <br>
<code>https://packages.microsoft.com/config/ubuntu/</code> выбрать репозиторий и скопировать URL <br>
<code>add-apt-repository &quot;$(wget -qO- https://packages.microsoft.com/config/ubuntu/20.04/mssql-server-2019.list)&quot;</code> <br>
<code>apt-get update</code> обновить список пакетов <br>
<code>apt-get install mssql-server</code> <br>
<code>/opt/mssql/bin/mssql-conf setup</code> скрипт начальной конфигурации (выбрать редакцию, 3 - express и русский язык 9 из 11) <br>
<code>systemctl status mssql-server</code> <br>
<code>curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -</code> установить клиент <br>
<code>curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | tee /etc/apt/sources.list.d/msprod.list</code> <br>
<code>apt-get update</code> <br>
<code>apt-get install mssql-tools</code> <br>
<code>echo 'export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;' &gt;&gt; ~/.bashrc</code> добавить в домашний каталог файла bashrc, что бы не писать путь к исполняемому файлу <br>
<code>export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;</code> <br>
<code>iptables -I INPUT 1 -p tcp --dport 1433 -j ACCEPT</code></p>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="sqlcmd%20-S%20localhost%20-U%20SA%0d%0aCREATE%20DATABASE%20itinvent%0d%0ago%0d%0aSELECT%20name%20FROM%20master.dbo.sysdatabases%0d%0ago">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>sqlcmd -S localhost -U SA
CREATE DATABASE itinvent
go
SELECT name FROM master.dbo.sysdatabases
go</code></pre>
    
</div>
<h2 id="systemdatasqlclient">System.Data.SqlClient</h2>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="$user%20=%20%22itinvent%22%0d%0a$pass%20=%20%22itinvent%22%0d%0a$db%20%20%20=%20%22itinvent%22%0d%0a$srv%20%20=%20%22192.168.3.103%22%0d%0a$SqlConnection%20=%20New-Object%20System.Data.SqlClient.SqlConnection%0d%0a$SqlConnection.ConnectionString%20=%20%22server=$srv;database=$db;user%20id=$user;password=$pass;Integrated%20Security=false%22%0d%0a%0d%0a$SqlCommand%20=%20New-Object%20System.Data.SqlClient.SqlCommand%60%20%d0%ba%d0%bb%d0%b0%d1%81%d1%81%20%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82%d0%b0%20%d0%ba%d0%be%d0%bc%d0%b0%d0%bd%d0%b4%d1%8b%0d%0a$SqlCommand.CommandText%20=%20%22SELECT%20*%20FROM%20ITINVENT.dbo.USERS%22%60%20%d0%be%d1%82%d0%be%d0%b1%d1%80%d0%b0%d0%b7%d0%b8%d1%82%d1%8c%20%d1%81%d0%be%d0%b4%d0%b5%d1%80%d0%b6%d0%b8%d0%bc%d0%be%d0%b5%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d1%8b%0d%0a#$SqlCommand.CommandText%20=%20%22SELECT%20LICENCE_DATE,DESCR,MODEL_NO,TYPE_NO%20FROM%20ITINVENT.dbo.ITEMS%20where%20LICENCE_DATE%20IS%20NOT%20NULL%22%0d%0a$SqlCommand.Connection%20=%20$SqlConnection%60%20%d0%bf%d0%b5%d1%80%d0%b5%d0%b4%d0%b0%d1%82%d1%8c%20%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82%20%d0%bf%d0%be%d0%b4%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d1%8f%0d%0a$SqlAdapter%20=%20New-Object%20System.Data.SqlClient.SqlDataAdapter%60%20%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d1%82%d1%8c%20%d0%b0%d0%b4%d0%b0%d0%bf%d1%82%d0%b5%d1%80%20%d0%bf%d0%be%d0%b4%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d1%8f%20%d0%b4%d0%bb%d1%8f%20%d0%b2%d1%8b%d0%bf%d0%be%d0%bb%d0%bd%d0%b5%d0%bd%d0%b8%d1%8f%20SELECT%20%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d0%be%d0%b2%20%d0%ba%20%d0%91%d0%94%0d%0a$SqlAdapter.SelectCommand%20=%20$SqlCommand%60%20%d0%bf%d0%b5%d1%80%d0%b5%d0%b4%d0%b0%d1%82%d1%8c%20%d0%ba%d0%be%d0%bc%d0%b0%d0%bd%d0%b4%d1%83%0d%0a%0d%0a$DataSet%20=%20New-Object%20System.Data.DataSet%60%20%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d1%82%d1%8c%20%d0%be%d0%b1%d1%8a%d0%b5%d0%ba%d1%82%20%d0%bf%d1%80%d0%b8%d0%b5%d0%bc%d0%b0%20%d0%b4%d0%b0%d0%bd%d0%bd%d1%8b%d1%85%20%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82%d0%b0%20XML%0d%0a$SqlAdapter.Fill%28$DataSet%29%60%20%d0%b7%d0%b0%d0%bf%d0%be%d0%bb%d0%bd%d0%b8%d1%82%d1%8c%20%d0%b4%d0%b0%d0%bd%d0%bd%d1%8b%d0%bc%d0%b8%20%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%bd%d1%8b%d0%b5%20%d0%be%d1%82%20%d0%b0%d0%b4%d0%b0%d0%bf%d1%82%d0%b5%d1%80%d0%b0%20%28%d0%b2%d0%be%d0%b7%d0%b2%d1%80%d0%b0%d1%89%d0%b0%d0%b5%d1%82%20%d0%ba%d0%be%d0%bb-%d0%b2%d0%be%20%d0%be%d0%b1%d1%8a%d0%b5%d0%ba%d1%82%d0%be%d0%b2%29%0d%0a$SqlConnection.Close%28%29%0d%0a$Data%20=%20$DataSet.Tables%0d%0a$Data[0]%20%7c%20ft">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$user = <span style="color:#e6db74">&#34;itinvent&#34;</span>
</span></span><span style="display:flex;"><span>$pass = <span style="color:#e6db74">&#34;itinvent&#34;</span>
</span></span><span style="display:flex;"><span>$db   = <span style="color:#e6db74">&#34;itinvent&#34;</span>
</span></span><span style="display:flex;"><span>$srv  = <span style="color:#e6db74">&#34;192.168.3.103&#34;</span>
</span></span><span style="display:flex;"><span>$SqlConnection = New-Object System.Data.SqlClient.SqlConnection
</span></span><span style="display:flex;"><span>$SqlConnection.ConnectionString = <span style="color:#e6db74">&#34;server=</span>$srv<span style="color:#e6db74">;database=</span>$db<span style="color:#e6db74">;user id=</span>$user<span style="color:#e6db74">;password=</span>$pass<span style="color:#e6db74">;Integrated Security=false&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$SqlCommand = New-Object System.Data.SqlClient.SqlCommand` класс формата команды
</span></span><span style="display:flex;"><span>$SqlCommand.CommandText = <span style="color:#e6db74">&#34;SELECT * FROM ITINVENT.dbo.USERS&#34;</span>` отобразить содержимое таблицы
</span></span><span style="display:flex;"><span><span style="color:#75715e">#$SqlCommand.CommandText = &#34;SELECT LICENCE_DATE,DESCR,MODEL_NO,TYPE_NO FROM ITINVENT.dbo.ITEMS where LICENCE_DATE IS NOT NULL&#34;</span>
</span></span><span style="display:flex;"><span>$SqlCommand.Connection = $SqlConnection` передать формат подключения
</span></span><span style="display:flex;"><span>$SqlAdapter = New-Object System.Data.SqlClient.SqlDataAdapter` создать адаптер подключения для выполнения SELECT запросов к БД
</span></span><span style="display:flex;"><span>$SqlAdapter.SelectCommand = $SqlCommand` передать команду
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$DataSet = New-Object System.Data.DataSet` создать объект приема данных формата XML
</span></span><span style="display:flex;"><span>$SqlAdapter.Fill($DataSet)` заполнить данными полученные от адаптера (возвращает кол-во объектов)
</span></span><span style="display:flex;"><span>$SqlConnection.Close()
</span></span><span style="display:flex;"><span>$Data = $DataSet.Tables
</span></span><span style="display:flex;"><span>$Data[<span style="color:#ae81ff">0</span>] | ft</span></span></code></pre></div>
    
</div>
<h2 id="sqlclient-insert">SqlClient INSERT</h2>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="$user%20=%20%22itinvent%22%0d%0a$pass%20=%20%22itinvent%22%0d%0a$db%20%20%20=%20%22db_test%22%0d%0a$srv%20%20=%20%22192.168.3.103%22%0d%0a$sql%20=%20%22INSERT%20INTO%20table_test%20%28column_user%29%20VALUES%20%28%27lifailon%27%29%22%60%20%d0%b4%d0%be%d0%b1%d0%b0%d0%b2%d0%b8%d1%82%d1%8c%20%d0%b4%d0%b0%d0%bd%d0%bd%d1%8b%d0%b5%20%d0%b2%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d1%83%20table_test%20%d0%b2%20%d0%ba%d0%be%d0%bb%d0%be%d0%bd%d0%ba%d1%83%20column_user%0d%0a$SqlConnection%20=%20New-Object%20System.Data.SqlClient.SqlConnection%0d%0a$SqlConnection.ConnectionString%20=%20%22server=$srv;database=$db;user%20id=$user;password=$pass;Integrated%20Security=false%22%0d%0a$SqlCommand%20=%20New-Object%20System.Data.SqlClient.SqlCommand%0d%0a$SqlCommand.CommandText%20=%20$sql%0d%0a$SqlCommand.Connection%20=%20$SqlConnection%0d%0a$SqlConnection.Open%28%29%0d%0a$rowsAffected%20=%20$SqlCommand.ExecuteNonQuery%28%29;%60%20%d0%b4%d0%bb%d1%8f%20%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%d0%be%d0%b2%20INSERT/UPDATE/DELETE%20%d0%bd%d0%b5%20%d0%b8%d1%81%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d1%83%d0%b5%d1%82%d1%81%d1%8f%20SqlDataAdapter%0d%0a$SqlConnection.Close%28%29">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$user = <span style="color:#e6db74">&#34;itinvent&#34;</span>
</span></span><span style="display:flex;"><span>$pass = <span style="color:#e6db74">&#34;itinvent&#34;</span>
</span></span><span style="display:flex;"><span>$db   = <span style="color:#e6db74">&#34;db_test&#34;</span>
</span></span><span style="display:flex;"><span>$srv  = <span style="color:#e6db74">&#34;192.168.3.103&#34;</span>
</span></span><span style="display:flex;"><span>$sql = <span style="color:#e6db74">&#34;INSERT INTO table_test (column_user) VALUES (&#39;lifailon&#39;)&#34;</span>` добавить данные в таблицу table_test в колонку column_user
</span></span><span style="display:flex;"><span>$SqlConnection = New-Object System.Data.SqlClient.SqlConnection
</span></span><span style="display:flex;"><span>$SqlConnection.ConnectionString = <span style="color:#e6db74">&#34;server=</span>$srv<span style="color:#e6db74">;database=</span>$db<span style="color:#e6db74">;user id=</span>$user<span style="color:#e6db74">;password=</span>$pass<span style="color:#e6db74">;Integrated Security=false&#34;</span>
</span></span><span style="display:flex;"><span>$SqlCommand = New-Object System.Data.SqlClient.SqlCommand
</span></span><span style="display:flex;"><span>$SqlCommand.CommandText = $sql
</span></span><span style="display:flex;"><span>$SqlCommand.Connection = $SqlConnection
</span></span><span style="display:flex;"><span>$SqlConnection.Open()
</span></span><span style="display:flex;"><span>$rowsAffected = $SqlCommand.ExecuteNonQuery();` для запросов INSERT/UPDATE/DELETE не используется SqlDataAdapter
</span></span><span style="display:flex;"><span>$SqlConnection.Close()</span></span></code></pre></div>
    
</div>
<h2 id="ssms-insert">SSMS INSERT</h2>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="USE%20[db_test]%0d%0aGO%0d%0aINSERT%20INTO%20[dbo].[table_test]%0d%0a%20%20%20%20%20%20%20%20%20%20%20%28[column_user]%29%0d%0a%20%20%20%20%20VALUES%0d%0a%20%20%20%20%20%20%20%20%20%20%20%28%27lifailon%27%29%0d%0aGO%0d%0aSELECT%20TOP%20%281000%29%20[column_user]%0d%0aFROM%20[db_test].[dbo].[table_test]">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>USE [db_test]
GO
INSERT INTO [dbo].[table_test]
           ([column_user])
     VALUES
           (&#39;lifailon&#39;)
GO
SELECT TOP (1000) [column_user]
FROM [db_test].[dbo].[table_test]</code></pre>
    
</div>
<h2 id="t-sql">T-SQL</h2>
<ul>
<li>
<p>DDL (Data Definition Language / Язык определения данных). К этому типу относятся команды, которые создают базу данных, таблицы, индексы, хранимые процедуры. <br>
<code>CREATE</code> создает объекты базы данных (саму базу даных, таблицы, индексы и т.д.) <br>
<code>ALTER</code> изменяет объекты базы данных <br>
<code>DROP</code> удаляет объекты базы данных <br>
<code>TRUNCATE</code> удаляет все данные из таблиц</p>
</li>
<li>
<p>DML (Data Manipulation Language / Язык манипуляции данными). К этому типу относят команды по выбору, обновлению, добавлению и удалению данных. <br>
<code>SELECT</code> извлекает данные из БД <br>
<code>UPDATE</code> обновляет данные <br>
<code>INSERT</code> добавляет новые данные <br>
<code>DELETE</code> удаляет данные</p>
</li>
<li>
<p>DCL (Data Control Language / Язык управления доступа к данным). К этому типу относят команды, которые управляют правами по доступу к данным. <br>
<code>GRANT</code> предоставляет права для доступа к данным <br>
<code>REVOKE</code> отзывает права на доступ к данным</p>
</li>
</ul>







<div class="codeblock">
    
        <div class="copy-button-box">
            <button class="copy-button" state="copy" data="--%20%d0%9f%d0%b5%d1%80%d0%b5%d0%bc%d0%b5%d0%bd%d0%bd%d1%8b%d0%b5%0d%0aDECLARE%20@text%20NVARCHAR%2820%29,%20@int%20INT;%0d%0aSET%20@text=%27Test%27;%0d%0aSET%20@int%20=%2021;%0d%0aselect%20@text,@int%0d%0a%0d%0a--%20%d0%98%d0%bc%d0%b5%d0%bd%d0%b0%20%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0%20%d0%b8%20%d1%8d%d0%ba%d0%b7%d0%b5%d0%bc%d0%bf%d0%bb%d1%8f%d1%80%d0%b0%20%0d%0aSelect%20@@SERVERNAME%20as%20[Server%5cInstance];%20%0d%0a%0d%0a--%20%d0%b2%d0%b5%d1%80%d1%81%d0%b8%d1%8f%20SQL%20Server%20%0d%0aSelect%20@@VERSION%20as%20SQLServerVersion;%20%0d%0a%0d%0a--%20%d0%a2%d0%b5%d0%ba%d1%83%d1%89%d0%b0%d1%8f%20%d0%91%d0%94%20%28%d0%91%d0%94,%20%d0%b2%20%d0%ba%d0%be%d0%bd%d1%82%d0%b5%d0%ba%d1%81%d1%82%d0%b5%20%d0%ba%d0%be%d1%82%d0%be%d1%80%d0%be%d0%b9%20%d0%b2%d1%8b%d0%bf%d0%be%d0%bb%d0%bd%d1%8f%d0%b5%d1%82%d1%81%d1%8f%20%d0%b7%d0%b0%d0%bf%d1%80%d0%be%d1%81%29%0d%0aSelect%20DB_NAME%28%29%20AS%20CurrentDB_Name;%0d%0a%0d%0a--%20%d0%92%d1%80%d0%b5%d0%bc%d1%8f%20%d1%80%d0%b0%d0%b1%d0%be%d1%82%d1%8b%20%d1%81%20%d0%bc%d0%be%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%20%d0%b7%d0%b0%d0%bf%d1%83%d1%81%d0%ba%d0%b0%20%d1%81%d0%b5%d1%80%d0%b2%d0%b5%d1%80%d0%b0%0d%0aSELECT%20%20@@Servername%20AS%20ServerName%20,%0d%0a%20%20%20%20%20%20%20%20create_date%20AS%20%20ServerStarted%20,%0d%0a%20%20%20%20%20%20%20%20DATEDIFF%28s,%20create_date,%20GETDATE%28%29%29%20/%2086400.0%20AS%20DaysRunning%20,%0d%0a%20%20%20%20%20%20%20%20DATEDIFF%28s,%20create_date,%20GETDATE%28%29%29%20AS%20SecondsRunnig%0d%0aFROM%20%20%20%20sys.databases%0d%0aWHERE%20%20%20name%20=%20%27tempdb%27;%0d%0a%0d%0a--%20%d0%9a%d0%be%d0%bb%d0%b8%d1%87%d0%b5%d1%81%d1%82%d0%b2%d0%be%20%d0%b0%d0%ba%d1%82%d0%b8%d0%b2%d0%bd%d1%8b%d1%85%20%d1%81%d0%be%d0%b5%d0%b4%d0%b8%d0%bd%d0%b5%d0%bd%d0%b8%d0%b9%0d%0aSELECT%20%20@@Servername%20AS%20Server%20,%0d%0a%20%20%20%20%20%20%20%20DB_NAME%28database_id%29%20AS%20DatabaseName%20,%0d%0a%20%20%20%20%20%20%20%20COUNT%28database_id%29%20AS%20Connections%20,%0d%0a%20%20%20%20%20%20%20%20Login_name%20AS%20%20LoginName%20,%0d%0a%20%20%20%20%20%20%20%20MIN%28Login_Time%29%20AS%20Login_Time%20,%0d%0a%20%20%20%20%20%20%20%20MIN%28COALESCE%28last_request_end_time,%20last_request_start_time%29%29%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20AS%20%20Last_Batch%0d%0aFROM%20%20%20%20sys.dm_exec_sessions%0d%0aWHERE%20%20%20database_id%20%3e%200%0d%0a%20%20%20%20%20%20%20%20AND%20DB_NAME%28database_id%29%20NOT%20IN%20%28%20%27master%27,%20%27msdb%27%20%29%0d%0aGROUP%20BY%20database_id%20,%0d%0a%20%20%20%20%20%20%20%20%20login_name%0d%0aORDER%20BY%20DatabaseName;%0d%0a%0d%0a--%20%d0%a1%d1%82%d0%b0%d1%82%d1%83%d1%81%20Backup%0d%0aSELECT%20%20@@Servername%20AS%20ServerName%20,%0d%0a%20%20%20%20%20%20%20%20d.Name%20AS%20DBName%20,%0d%0a%20%20%20%20%20%20%20%20MAX%28b.backup_finish_date%29%20AS%20LastBackupCompleted%0d%0aFROM%20%20%20%20sys.databases%20d%0d%0a%20%20%20%20%20%20%20%20LEFT%20OUTER%20JOIN%20msdb..backupset%20b%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ON%20b.database_name%20=%20d.name%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20AND%20b.[type]%20=%20%27D%27%0d%0aGROUP%20BY%20d.Name%0d%0aORDER%20BY%20d.Name;%0d%0a%0d%0a--%20%d0%9f%d1%83%d1%82%d1%8c%20%d0%ba%20Backup%0d%0aSELECT%20%20@@Servername%20AS%20ServerName%20,%0d%0a%20%20%20%20%20%20%20%20d.Name%20AS%20DBName%20,%0d%0a%20%20%20%20%20%20%20%20b.Backup_finish_date%20,%0d%0a%20%20%20%20%20%20%20%20bmf.Physical_Device_name%0d%0aFROM%20%20%20%20sys.databases%20d%0d%0a%20%20%20%20%20%20%20%20INNER%20JOIN%20msdb..backupset%20b%20ON%20b.database_name%20=%20d.name%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20AND%20b.[type]%20=%20%27D%27%0d%0a%20%20%20%20%20%20%20%20INNER%20JOIN%20msdb.dbo.backupmediafamily%20bmf%20ON%20b.media_set_id%20=%20bmf.media_set_id%0d%0aORDER%20BY%20d.NAME%20,%0d%0a%20%20%20%20%20%20%20%20b.Backup_finish_date%20DESC;%20%0d%0a%0d%0a--%20%d0%92%d1%8b%d0%b2%d0%b5%d1%81%d1%82%d0%b8%20%d1%81%d0%bf%d0%b8%d1%81%d0%be%d0%ba%20%d0%b2%d1%81%d0%b5%d1%85%20%d0%91%d0%94,%20%d0%bc%d0%be%d0%b4%d0%b5%d0%bb%d0%b8%20%d0%b2%d0%be%d1%81%d1%81%d1%82%d0%b0%d0%bd%d0%be%d0%b2%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f%20%d0%b8%20%d0%bf%d1%83%d1%82%d1%8c%20%d0%ba%20mdf/ldf%0d%0aEXEC%20sp_helpdb;%20%0d%0aSELECT%20%20@@SERVERNAME%20AS%20Server%20,%0d%0a%20%20%20%20%20%20%20%20d.name%20AS%20DBName%20,%0d%0a%20%20%20%20%20%20%20%20create_date%20,%0d%0a%20%20%20%20%20%20%20%20recovery_model_Desc%20AS%20RecoveryModel%20,%0d%0a%20%20%20%20%20%20%20%20m.physical_name%20AS%20FileName%0d%0aFROM%20%20%20%20sys.databases%20d%0d%0a%20%20%20%20%20%20%20%20JOIN%20sys.master_files%20m%20ON%20d.database_id%20=%20m.database_id%0d%0aORDER%20BY%20d.name;%0d%0a%0d%0a--%20%d0%a0%d0%b0%d0%b7%d0%bc%d0%b5%d1%80%20%d0%91%d0%94%0d%0awith%20fs%0d%0aas%0d%0a%28%0d%0a%20%20%20%20select%20database_id,%20type,%20size%20*%208.0%20/%201024%20size%0d%0a%20%20%20%20from%20sys.master_files%0d%0a%29%0d%0aselect%20%0d%0a%20%20%20%20name,%0d%0a%20%20%20%20%28select%20sum%28size%29%20from%20fs%20where%20type%20=%200%20and%20fs.database_id%20=%20db.database_id%29%20DataFileSizeMB,%0d%0a%20%20%20%20%28select%20sum%28size%29%20from%20fs%20where%20type%20=%201%20and%20fs.database_id%20=%20db.database_id%29%20LogFileSizeMB%0d%0afrom%20sys.databases%20%0d%0a%0d%0a--%20%d0%9f%d0%be%d0%b8%d1%81%d0%ba%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d1%8b%20%d0%bf%d0%be%20%d0%bc%d0%b0%d1%81%d0%ba%d0%b5%20%d0%b8%d0%bc%d0%b5%d0%bd%d0%b8%20%28%d0%b2%d1%8b%d0%b2%d0%be%d0%b4:%20%d0%bd%d0%b0%d0%b7%d0%b2%d0%b0%d0%bd%d0%b8%d1%8f%20%d1%81%d1%85%d0%b5%d0%bc%d1%8b%20%d0%b3%d0%b4%d0%b5%20%d1%80%d0%b0%d1%81%d0%bf%d0%be%d0%bb%d0%be%d0%b3%d0%b0%d0%b5%d1%82%d1%81%d1%8f%20%d0%be%d0%b1%d1%8a%d0%b5%d0%ba%d1%82,%20%d1%82%d0%b8%d0%bf%20%d0%be%d0%b1%d1%8a%d0%b5%d0%ba%d1%82%d0%b0,%20%d0%b4%d0%b0%d1%82%d0%b0%20%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d0%bd%d0%b8%d1%8f%20%d0%b8%20%d0%bf%d0%be%d1%81%d0%bb%d0%b5%d0%b4%d0%bd%d0%b5%d0%b9%20%d0%bc%d0%be%d0%b4%d0%b8%d1%84%d0%b8%d0%ba%d0%b0%d1%86%d0%b8%d0%b8%29:%0d%0aselect%20[object_id],%20[schema_id],%0d%0a%09%20%20%20schema_name%28[schema_id]%29%20as%20[schema_name],%20%0d%0a%09%20%20%20[name],%20%0d%0a%09%20%20%20[type],%20%0d%0a%09%20%20%20[type_desc],%20%0d%0a%09%20%20%20[create_date],%20%0d%0a%09%20%20%20[modify_date]%0d%0afrom%20sys.all_objects%0d%0a--%20where%20[name]=%27INVENT%27;%0d%0awhere%20[name]%20like%20%27%25INVENT%25%27;%0d%0a%0d%0a--%20%d0%9a%d0%be%d0%bb-%d0%b2%d0%be%20%d1%81%d1%82%d1%80%d0%be%d0%ba%20%d0%b2%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0%d1%85%0d%0aSELECT%20%20@@ServerName%20AS%20Server%20,%0d%0a%20%20%20%20%20%20%20%20DB_NAME%28%29%20AS%20DBName%20,%0d%0a%20%20%20%20%20%20%20%20OBJECT_SCHEMA_NAME%28p.object_id%29%20AS%20SchemaName%20,%0d%0a%20%20%20%20%20%20%20%20OBJECT_NAME%28p.object_id%29%20AS%20TableName%20,%0d%0a%20%20%20%20%20%20%20%20i.Type_Desc%20,%0d%0a%20%20%20%20%20%20%20%20i.Name%20AS%20IndexUsedForCounts%20,%0d%0a%20%20%20%20%20%20%20%20SUM%28p.Rows%29%20AS%20Rows%0d%0aFROM%20%20%20%20sys.partitions%20p%0d%0a%20%20%20%20%20%20%20%20JOIN%20sys.indexes%20i%20ON%20i.object_id%20=%20p.object_id%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20AND%20i.index_id%20=%20p.index_id%0d%0aWHERE%20%20%20i.type_desc%20IN%20%28%20%27CLUSTERED%27,%20%27HEAP%27%20%29%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20--%20This%20is%20key%20%281%20index%20per%20table%29%20%0d%0a%20%20%20%20%20%20%20%20AND%20OBJECT_SCHEMA_NAME%28p.object_id%29%20%3c%3e%20%27sys%27%0d%0aGROUP%20BY%20p.object_id%20,%0d%0a%20%20%20%20%20%20%20%20i.type_desc%20,%0d%0a%20%20%20%20%20%20%20%20i.Name%0d%0aORDER%20BY%20SchemaName%20,%0d%0a%20%20%20%20%20%20%20%20TableName;%20%0d%0a%0d%0a--%20%d0%9d%d0%b0%d0%b9%d1%82%d0%b8%20%d1%81%d1%82%d1%80%d0%be%d0%ba%d0%be%d0%b2%d0%be%d0%b5%20%28nvarchar%29%20%d0%b7%d0%bd%d0%b0%d1%87%d0%b5%d0%bd%d0%b8%d0%b5%202023%20%d0%bf%d0%be%20%d0%b2%d1%81%d0%b5%d0%bc%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0%d0%bc%20%d0%b1%d0%b0%d0%b7%d1%8b%20%d0%b4%d0%b0%d0%bd%d0%bd%d1%8b%d1%85%0d%0a--%20%d0%9e%d1%82%d0%be%d0%b1%d1%80%d0%b0%d0%b6%d0%b0%d0%b5%d1%82%d1%81%d1%8f%20%d0%b2%20%d0%ba%d0%b0%d0%ba%d0%be%d0%b9%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b5%20%d0%b8%20%d1%81%d1%82%d0%be%d0%bb%d0%b1%d1%86%d0%b5%20%d1%85%d1%80%d0%b0%d0%bd%d0%b8%d1%82%d1%81%d1%8f%20%d0%b7%d0%bd%d0%b0%d1%87%d0%b5%d0%bd%d0%b8%d0%b5,%20%d0%b0%20%d1%82%d0%b0%d0%ba%d0%b6%d0%b5%20%d0%ba%d0%be%d0%bb%d0%b8%d1%87%d0%b5%d1%81%d1%82%d0%b2%d0%be%20%d0%bd%d0%b0%d0%b9%d0%b4%d0%b5%d0%bd%d0%bd%d1%8b%d1%85%20%d0%bf%d0%b0%d1%80%d1%8b%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b0-%d0%ba%d0%be%d0%bb%d0%be%d0%bd%d0%ba%d0%b0%0d%0aset%20nocount%20on%0d%0adeclare%20@name%20varchar%28128%29,%20@substr%20nvarchar%284000%29,%20@column%20varchar%28128%29%0d%0aset%20@substr%20=%20%27%2023%25%27%0d%0adeclare%20@sql%20nvarchar%28max%29;%0d%0acreate%20table%60rslt%20%0d%0a%28table_name%20varchar%28128%29,%20field_name%20varchar%28128%29,%20[value]%20nvarchar%28max%29%29%0d%0adeclare%20s%20cursor%20for%20select%20table_name%20as%20table_name%20from%20information_schema.tables%20where%20table_type%20=%20%27BASE%20TABLE%27%20order%20by%20table_name%0d%0aopen%20s%0d%0afetch%20next%20from%20s%20into%20@name%0d%0awhile%20@@fetch_status%20=%200%0d%0abegin%0d%0adeclare%20c%20cursor%20for%20%0d%0aselect%20quotename%28column_name%29%20as%20column_name%20from%20information_schema.columns%20%0d%0awhere%20data_type%20in%20%28%27text%27,%20%27ntext%27,%20%27varchar%27,%20%27char%27,%20%27nvarchar%27,%20%27char%27,%20%27sysname%27,%20%27int%27,%20%27tinyint%27%29%20and%20table_name%20%20=%20@name%0d%0aset%20@name%20=%20quotename%28@name%29%0d%0aopen%20c%0d%0afetch%20next%20from%20c%20into%20@column%0d%0awhile%20@@fetch_status%20=%200%0d%0abegin%0d%0a--print%20%27Processing%20table%20-%20%27%20&#43;%20@name%20&#43;%20%27,%20column%20-%20%27%20&#43;%20@column%0d%0aset%20@sql=%27insert%20into%60rslt%20select%20%27%27%27%20&#43;%20@name%20&#43;%20%27%27%27%20as%20Table_name,%20%27%27%27%20&#43;%20@column%20&#43;%20%27%27%27,%20cast%28%27%20&#43;%20@column%20&#43;%20%0d%0a%27%20as%20nvarchar%28max%29%29%20from%27%20&#43;%20@name%20&#43;%20%27%20where%20cast%28%27%20&#43;%20@column%20&#43;%20%27%20as%20nvarchar%28max%29%29%20like%20%27%27%27%20&#43;%20@substr%20&#43;%20%27%27%27%27;%0d%0aprint%20@sql;%0d%0aexec%28@sql%29;%0d%0afetch%20next%20from%20c%20into%20@column;%0d%0aend%0d%0aclose%20c%0d%0adeallocate%20c%0d%0afetch%20next%20from%20s%20into%20@name%0d%0aend%0d%0aselect%20table_name%20as%20[Table%20Name],%20field_name%20as%20[Field%20Name],%20count%28*%29%20as%20[Found%20Mathes]%20from%60rslt%0d%0agroup%20by%20table_name,%20field_name%0d%0aorder%20by%20table_name,%20field_name%0d%0adrop%20table%60rslt%0d%0aclose%20s%0d%0adeallocate%20s%0d%0a%0d%0a--%20%d0%9f%d0%be%d0%b8%d1%81%d0%ba%20%d0%b2%20%d1%82%d0%b0%d0%b1%d0%bb%d0%b8%d1%86%d0%b5%20[CI_HISTORY]%20%d0%b8%20%d1%81%d1%82%d0%be%d0%bb%d0%b1%d1%86%d1%83%20[HIST_ID]:%0d%0aSELECT%20*%20FROM%20ITINVENT.dbo.CI_HISTORY%20where%20[HIST_ID]%20like%20%27%2023%25%27;%0d%0a%0d%0a--%20%d0%a3%d0%b7%d0%bd%d0%b0%d1%82%d1%8c%20%d1%84%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8e%20%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d0%be%d0%b2%0d%0aDECLARE%20@db_id%20SMALLINT;%0d%0aSET%20@db_id%20=%20DB_ID%28N%27itinvent%27%29;%0d%0aIF%20@db_id%20IS%20NULL%0d%0aBEGIN;%0d%0a%20%20%20%20PRINT%20N%27%d0%9d%d0%b5%d0%bf%d1%80%d0%b0%d0%b2%d0%b8%d0%bb%d1%8c%d0%bd%d0%be%d0%b5%20%d0%b8%d0%bc%d1%8f%20%d0%b1%d0%b0%d0%b7%d1%8b%27;%0d%0aEND;%0d%0aELSE%0d%0aBEGIN;%0d%0a%09SELECT%0d%0a%09%09object_id%20AS%20[ID%20%d0%be%d0%b1%d1%8a%d0%b5%d0%ba%d1%82%d0%b0],%0d%0a%09%09index_id%20AS%20[ID%20%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d0%b0],%0d%0a%09%09index_type_desc%20AS%20[%d0%a2%d0%b8%d0%bf%20%d0%b8%d0%bd%d0%b4%d0%b5%d0%ba%d1%81%d0%b0],%0d%0a%09%09avg_fragmentation_in_percent%20AS%20[%d0%a4%d1%80%d0%b0%d0%b3%d0%bc%d0%b5%d0%bd%d1%82%d0%b0%d1%86%d0%b8%d1%8f%20%d0%b2%20%25]%0d%0a%09%09%0d%0a%09FROM%20sys.dm_db_index_physical_stats%28@db_id,%20NULL,%20NULL,%20NULL%20,%20%27LIMITED%27%29%0d%0a%09%20%0d%0a%09ORDER%20BY%20[avg_fragmentation_in_percent]%20DESC;%0d%0aEND;%0d%0aGO%0d%0a%0d%0a--%20TempDB%0d%0a--%20Initial%20size%20-%20%d0%bd%d0%b0%d1%87%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b9/%d0%bc%d0%b8%d0%bd%d0%b8%d0%bc%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%b9%20%d1%80%d0%b0%d0%b7%d0%bc%d0%b5%d1%80%20%d0%91%d0%94%20%281024%20MB%29%0d%0a--%20Autogrowh%20-%20%d0%bf%d1%80%d0%b8%d1%80%d0%be%d1%81%d1%82%20%28512MB%29%0d%0a--%20%d0%9f%d0%be%20%d1%83%d0%bc%d0%be%d0%bb%d1%87%d0%b0%d0%bd%d0%b8%d1%8e%20tempdb%20%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b5%d0%bd%d0%b0%20%d0%bd%d0%b0%20%d0%b0%d0%b2%d1%82%d0%be-%d1%80%d0%b0%d1%81%d1%88%d0%b8%d1%80%d0%b5%d0%bd%d0%b8%d0%b5%20%28Autogrow%29%20%d0%b8%20%d0%bf%d1%80%d0%b8%20%d0%ba%d0%b0%d0%b6%d0%b4%d0%be%d0%b9%20%d0%bf%d0%b5%d1%80%d0%b5%d0%b7%d0%b0%d0%b3%d1%80%d1%83%d0%b7%d0%ba%d0%b5%20SQL%20Server%20%d0%bf%d0%b5%d1%80%d0%b5%d1%81%d0%be%d0%b7%d0%b4%d0%b0%d1%91%d1%82%20%d1%84%d0%b0%d0%b9%d0%bb%d1%8b%20%d1%8d%d1%82%d0%be%d0%b9%20%d0%91%d0%94%20%d1%81%20%d0%bc%d0%b8%d0%bd%d0%b8%d0%bc%d0%b0%d0%bb%d1%8c%d0%bd%d1%8b%d0%bc%20%d1%80%d0%b0%d0%b7%d0%bc%d0%b5%d1%80%d0%be%d0%bc%20%d0%b8%d0%bd%d0%b8%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d0%b8.%0d%0a--%20%d0%a3%d0%b2%d0%b5%d0%bb%d0%b8%d1%87%d0%b8%d0%b2%20%d1%80%d0%b0%d0%b7%d0%bc%d0%b5%d1%80%20%d0%b8%d0%bd%d0%b8%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d0%b7%d0%b0%d1%86%d0%b8%d0%b8%20%d1%84%d0%b0%d0%b9%d0%bb%d0%be%d0%b2%20tempdb,%20%d0%bc%d0%be%d0%b6%d0%bd%d0%be%20%d1%81%d0%b2%d0%b5%d1%81%d1%82%d0%b8%20%d0%ba%20%d0%bc%d0%b8%d0%bd%d0%b8%d0%bc%d1%83%d0%bc%d1%83%20%d0%b7%d0%b0%d1%82%d1%80%d0%b0%d1%82%d1%8b%20%d1%81%d0%b8%d1%81%d1%82%d0%b5%d0%bc%d0%bd%d1%8b%d1%85%20%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%be%d0%b2%20%d0%bd%d0%b0%20%d0%be%d0%bf%d0%b5%d1%80%d0%b0%d1%86%d0%b8%d0%b8%20%d0%b0%d0%b2%d1%82%d0%be-%d1%80%d0%b0%d1%81%d1%88%d0%b8%d1%80%d0%b5%d0%bd%d0%b8%d1%8f.%0d%0a%0d%0a--%20%d0%98%d0%b7%d0%bc%d0%b5%d0%bd%d0%b8%d1%82%d1%8c%20%d0%bf%d1%83%d1%82%d1%8c%20%d0%ba%20%d0%91%d0%94:%0d%0aUSE%20master;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20tempdev,%20FILENAME%20=%20%27F:%5ctempdb.mdf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp2,%20FILENAME%20=%20%27F:%5ctempdb_mssql_2.ndf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp3,%20FILENAME%20=%20%27F:%5ctempdb_mssql_3.ndf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp4,%20FILENAME%20=%20%27F:%5ctempdb_mssql_4.ndf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp5,%20FILENAME%20=%20%27F:%5ctempdb_mssql_5.ndf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp6,%20FILENAME%20=%20%27F:%5ctempdb_mssql_6.ndf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp7,%20FILENAME%20=%20%27F:%5ctempdb_mssql_7.ndf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp8,%20FILENAME%20=%20%27F:%5ctempdb_mssql_8.ndf%27%29;%0d%0aGO%0d%0aALTER%20DATABASE%20tempdb%0d%0aMODIFY%20FILE%20%28NAME%20=%20templog,%20FILENAME%20=%20%27F:%5ctemplog.ldf%27%29;%0d%0aGO%0d%0a%0d%0a--%20%d0%a3%d0%ba%d0%b0%d0%b7%d0%b0%d1%82%d1%8c%20%d1%80%d0%b0%d0%b7%d0%bc%d0%b5%d1%80%20%d1%84%d0%b0%d0%b9%d0%bb%d0%b0:%0d%0aMODIFY%20FILE%20%28NAME%20=%20temp2,%20FILENAME%20=%20%27F:%5ctempdb_mssql_2.ndf%27%20,%20SIZE%20=%201048576KB%20,%20FILEGROWTH%20=%20524288KB%29;">
                <i class="bi bi-copy"></i>
            </button>
        </div>
    

    
        <pre><code>-- Переменные
DECLARE @text NVARCHAR(20), @int INT;
SET @text=&#39;Test&#39;;
SET @int = 21;
select @text,@int

-- Имена сервера и экземпляра 
Select @@SERVERNAME as [Server\Instance]; 

-- версия SQL Server 
Select @@VERSION as SQLServerVersion; 

-- Текущая БД (БД, в контексте которой выполняется запрос)
Select DB_NAME() AS CurrentDB_Name;

-- Время работы с момента запуска сервера
SELECT  @@Servername AS ServerName ,
        create_date AS  ServerStarted ,
        DATEDIFF(s, create_date, GETDATE()) / 86400.0 AS DaysRunning ,
        DATEDIFF(s, create_date, GETDATE()) AS SecondsRunnig
FROM    sys.databases
WHERE   name = &#39;tempdb&#39;;

-- Количество активных соединений
SELECT  @@Servername AS Server ,
        DB_NAME(database_id) AS DatabaseName ,
        COUNT(database_id) AS Connections ,
        Login_name AS  LoginName ,
        MIN(Login_Time) AS Login_Time ,
        MIN(COALESCE(last_request_end_time, last_request_start_time))
                                                         AS  Last_Batch
FROM    sys.dm_exec_sessions
WHERE   database_id &gt; 0
        AND DB_NAME(database_id) NOT IN ( &#39;master&#39;, &#39;msdb&#39; )
GROUP BY database_id ,
         login_name
ORDER BY DatabaseName;

-- Статус Backup
SELECT  @@Servername AS ServerName ,
        d.Name AS DBName ,
        MAX(b.backup_finish_date) AS LastBackupCompleted
FROM    sys.databases d
        LEFT OUTER JOIN msdb..backupset b
                    ON b.database_name = d.name
                       AND b.[type] = &#39;D&#39;
GROUP BY d.Name
ORDER BY d.Name;

-- Путь к Backup
SELECT  @@Servername AS ServerName ,
        d.Name AS DBName ,
        b.Backup_finish_date ,
        bmf.Physical_Device_name
FROM    sys.databases d
        INNER JOIN msdb..backupset b ON b.database_name = d.name
                                        AND b.[type] = &#39;D&#39;
        INNER JOIN msdb.dbo.backupmediafamily bmf ON b.media_set_id = bmf.media_set_id
ORDER BY d.NAME ,
        b.Backup_finish_date DESC; 

-- Вывести список всех БД, модели восстановления и путь к mdf/ldf
EXEC sp_helpdb; 
SELECT  @@SERVERNAME AS Server ,
        d.name AS DBName ,
        create_date ,
        recovery_model_Desc AS RecoveryModel ,
        m.physical_name AS FileName
FROM    sys.databases d
        JOIN sys.master_files m ON d.database_id = m.database_id
ORDER BY d.name;

-- Размер БД
with fs
as
(
    select database_id, type, size * 8.0 / 1024 size
    from sys.master_files
)
select 
    name,
    (select sum(size) from fs where type = 0 and fs.database_id = db.database_id) DataFileSizeMB,
    (select sum(size) from fs where type = 1 and fs.database_id = db.database_id) LogFileSizeMB
from sys.databases 

-- Поиск таблицы по маске имени (вывод: названия схемы где распологается объект, тип объекта, дата создания и последней модификации):
select [object_id], [schema_id],
	   schema_name([schema_id]) as [schema_name], 
	   [name], 
	   [type], 
	   [type_desc], 
	   [create_date], 
	   [modify_date]
from sys.all_objects
-- where [name]=&#39;INVENT&#39;;
where [name] like &#39;%INVENT%&#39;;

-- Кол-во строк в таблицах
SELECT  @@ServerName AS Server ,
        DB_NAME() AS DBName ,
        OBJECT_SCHEMA_NAME(p.object_id) AS SchemaName ,
        OBJECT_NAME(p.object_id) AS TableName ,
        i.Type_Desc ,
        i.Name AS IndexUsedForCounts ,
        SUM(p.Rows) AS Rows
FROM    sys.partitions p
        JOIN sys.indexes i ON i.object_id = p.object_id
                              AND i.index_id = p.index_id
WHERE   i.type_desc IN ( &#39;CLUSTERED&#39;, &#39;HEAP&#39; )
                             -- This is key (1 index per table) 
        AND OBJECT_SCHEMA_NAME(p.object_id) &lt;&gt; &#39;sys&#39;
GROUP BY p.object_id ,
        i.type_desc ,
        i.Name
ORDER BY SchemaName ,
        TableName; 

-- Найти строковое (nvarchar) значение 2023 по всем таблицам базы данных
-- Отображается в какой таблице и столбце хранится значение, а также количество найденных пары таблица-колонка
set nocount on
declare @name varchar(128), @substr nvarchar(4000), @column varchar(128)
set @substr = &#39;%2023%&#39;
declare @sql nvarchar(max);
create table`rslt 
(table_name varchar(128), field_name varchar(128), [value] nvarchar(max))
declare s cursor for select table_name as table_name from information_schema.tables where table_type = &#39;BASE TABLE&#39; order by table_name
open s
fetch next from s into @name
while @@fetch_status = 0
begin
declare c cursor for 
select quotename(column_name) as column_name from information_schema.columns 
where data_type in (&#39;text&#39;, &#39;ntext&#39;, &#39;varchar&#39;, &#39;char&#39;, &#39;nvarchar&#39;, &#39;char&#39;, &#39;sysname&#39;, &#39;int&#39;, &#39;tinyint&#39;) and table_name  = @name
set @name = quotename(@name)
open c
fetch next from c into @column
while @@fetch_status = 0
begin
--print &#39;Processing table - &#39; &#43; @name &#43; &#39;, column - &#39; &#43; @column
set @sql=&#39;insert into`rslt select &#39;&#39;&#39; &#43; @name &#43; &#39;&#39;&#39; as Table_name, &#39;&#39;&#39; &#43; @column &#43; &#39;&#39;&#39;, cast(&#39; &#43; @column &#43; 
&#39; as nvarchar(max)) from&#39; &#43; @name &#43; &#39; where cast(&#39; &#43; @column &#43; &#39; as nvarchar(max)) like &#39;&#39;&#39; &#43; @substr &#43; &#39;&#39;&#39;&#39;;
print @sql;
exec(@sql);
fetch next from c into @column;
end
close c
deallocate c
fetch next from s into @name
end
select table_name as [Table Name], field_name as [Field Name], count(*) as [Found Mathes] from`rslt
group by table_name, field_name
order by table_name, field_name
drop table`rslt
close s
deallocate s

-- Поиск в таблице [CI_HISTORY] и столбцу [HIST_ID]:
SELECT * FROM ITINVENT.dbo.CI_HISTORY where [HIST_ID] like &#39;%2023%&#39;;

-- Узнать фрагментацию индексов
DECLARE @db_id SMALLINT;
SET @db_id = DB_ID(N&#39;itinvent&#39;);
IF @db_id IS NULL
BEGIN;
    PRINT N&#39;Неправильное имя базы&#39;;
END;
ELSE
BEGIN;
	SELECT
		object_id AS [ID объекта],
		index_id AS [ID индекса],
		index_type_desc AS [Тип индекса],
		avg_fragmentation_in_percent AS [Фрагментация в %]
		
	FROM sys.dm_db_index_physical_stats(@db_id, NULL, NULL, NULL , &#39;LIMITED&#39;)
	 
	ORDER BY [avg_fragmentation_in_percent] DESC;
END;
GO

-- TempDB
-- Initial size - начальный/минимальный размер БД (1024 MB)
-- Autogrowh - прирост (512MB)
-- По умолчанию tempdb настроена на авто-расширение (Autogrow) и при каждой перезагрузке SQL Server пересоздаёт файлы этой БД с минимальным размером инициализации.
-- Увеличив размер инициализации файлов tempdb, можно свести к минимуму затраты системных ресурсов на операции авто-расширения.

-- Изменить путь к БД:
USE master;
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = tempdev, FILENAME = &#39;F:\tempdb.mdf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = temp2, FILENAME = &#39;F:\tempdb_mssql_2.ndf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = temp3, FILENAME = &#39;F:\tempdb_mssql_3.ndf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = temp4, FILENAME = &#39;F:\tempdb_mssql_4.ndf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = temp5, FILENAME = &#39;F:\tempdb_mssql_5.ndf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = temp6, FILENAME = &#39;F:\tempdb_mssql_6.ndf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = temp7, FILENAME = &#39;F:\tempdb_mssql_7.ndf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = temp8, FILENAME = &#39;F:\tempdb_mssql_8.ndf&#39;);
GO
ALTER DATABASE tempdb
MODIFY FILE (NAME = templog, FILENAME = &#39;F:\templog.ldf&#39;);
GO

-- Указать размер файла:
MODIFY FILE (NAME = temp2, FILENAME = &#39;F:\tempdb_mssql_2.ndf&#39; , SIZE = 1048576KB , FILEGROWTH = 524288KB);</code></pre>
    
</div>
<h2 id="тип-резервной-копии">Тип резервной копии</h2>
<ul>
<li>Full (Полная копия). Когда стартует полное резервирование, записывается Log Sequence Number (LSN - последовательный номер журнала), а так же LSN записывается и при завершении полного резервирования. Этот LSN является механизмом, используемым SQL Server, чтобы знать, в каком порядке выполнялись операторы INSERT, UPDATE или DELETE. При этом наличие записанных LSN начала и окончания, как части полного бэкапа, обеспечивает согласованное с точки зрения транзакций резервное копирование, поскольку при полном резервном копировании учитываются изменения, произошедшие во время резервного копирования. Это обеспечивает обработку таких транзакций в процессе восстановления бэкапа.</li>
<li>Differential (дифференциальная/разностная копия). Хранит данных, изменившиеся с момента последней Полной резервной копии. При восстановлении нужно сначала восстановить Полную резервную копию в режиме NORECOVERY, потом можно применить любую из последующих Разностных копий, без предыдущей Полной резервной копии Разностная копия бесполезна. Каждая последующая Разностная копия будет хранить все данные, входящие в предыдущую Разностную резервную копию, сделанную после предыдущей Полной копии.</li>
<li>Incremental (инкрементальная/копия журналов транзакций). Резервное копирования журнала транзакций копирует все транзакции, которые произошли с момента последнего резервного копирования, а затем урезает журнал транзакций для освобождения дискового пространства. Транзакции происходят в определенном порядке (LSN), бэкап журнала поддерживает этот порядок транзакций. Бэкапы журналов транзакций должны восстанавливаться по порядку. Для восстановления базы данных потребуется вся цепочка резервных копий: полная и все последующие инкрементальные журнала транзакций.</li>
</ul>
<h2 id="модели-восстановления">Модели восстановления</h2>
<ul>
<li>Simple (Простая). Хранится только необходимый для жизни остаток журнала транзакций. Журнал транзакций (лог) автоматически очищается. Создание резервных копий журнала транзакций невозможна, поэтому остается самое ограниченное число опций по восстановлению. Недоступен функционал: Always On, Point-In-Time восстановление, Резервные копии журнала транзакций.</li>
<li>Full (Полная). Хранится журнал транзакций всех изменений в БД с момента последнего резервного копирования журнала транзакций. Журнал транзакций не будет очищаться до тех пор, пока не будет сделана резервная копия журнала транзакций.</li>
<li>Bulk logged (С неполным протоколированием). Идентична Full, за исключение: SELECT INTO, BULK INSERT и BCP, INSERT INTO SELECT, операции с индексами (CREATE INDEX, ALTER INDEX REBUILD, DROP INDEX)</li>
</ul>
<h2 id="системные-бд">Системные БД</h2>
<ul>
<li>master. Хранятся все данные системного уровня (конфигурация системы, сведенья об учетных записях входа, информация обо всех других базах данных) для экземпляра SQL Server.</li>
<li>tempdb. Рабочее пространство для временных объектов, таких как глобальные или локальные временные таблицы, временные хранимые процедуры, табличные переменные и курсоры. Пересоздаётся при каждом запуске SQL Server.</li>
<li>model. Используется в качестве шаблона для всех баз данных, создаваемых в экземпляре SQL Server, все содержимое базы данных model, включая параметры базы данных, копируется в создаваемую базу данных. Так как база данных tempdb создается каждый раз при запуске SQL Server, база данных model всегда должна существовать в системе SQL Server.</li>
<li>msdb. Используется агентом SQL Server для создания расписания предупреждений (оператор) и выполнение заданий, а также другими компонентами. SQL Server хранит полный журнал резервного копирования и восстановления в базе данных msdb. Для отправки почты оператору используется: USE [msdb].</li>
<li>resource. Доступная только для чтения база данных, которая содержит все системные объекты, например sys.objects, физически хранятся в базе данных resource, но логически присутствуют в схеме sys каждой базы данных.</li>
</ul>
<h2 id="регламентные-операции">Регламентные операции</h2>
<ul>
<li>Проверка целостности базы данных</li>
</ul>
<p><code>DBCC CHECKDB</code></p>
<ul>
<li>
<p>Индексы. Индексы используются для быстрого поиска данных без необходимости поиска/просмотра всех строк в таблице базы данных при каждом обращении к таблице базы данных. Индекс ускоряет процесс запроса, предоставляя быстрый доступ к строкам данных в таблице, аналогично тому, как указатель в книге помогает вам быстро найти необходимую информацию. Индексы предоставляют путь для быстрого поиска данных на основе значений в этих столбцах. Для каждого индекса обязательно хранится его статистика. MS SQL Server самостоятельно создает и изменяет индексы при работе с базой. С течением времени данные в индексе становятся фрагментированными, т.е. разбросанными по базе данных, что серьезно снижает производительность запросов. Если фрагментация составляет от 5 до 30% (стандартно в задании 15%), то рекомендуется ее устранить с помощью реорганизации, при фрагментации выше 30% (по умолчанию в задаче &gt; 30% фрагментации и число страниц &gt; 1000) необходимо полное перестроение индексов. После перестроения планово используется только реорганизация.</p>
</li>
<li>
<p>Реорганизация (Reorganize) или дефрагментация индекса — это серия небольших локальных перемещений страниц так, чтобы индекс не был фрагментирован. После реорганизации статистика не обновляется. Во время выполнения почти все данные доступны, пользователи смогут работать.</p>
</li>
</ul>
<p><code>sp_msforeachtable N'DBCC INDEXDEFRAG (&lt;имя базы данных&gt;, ''?'')'</code></p>
<ul>
<li>Перестроение (Rebuild) индексов (или задача в мастере планов обслуживания: Восстановить индекс) запускает процесс полного построения индексов. В версии MS SQL Server Standard происходит отключение всех клиентов от базы на время выполнения операции. После перестроения обязательно обновляется статистика.</li>
</ul>
<p><code>sp_msforeachtable N'DBCC DBREINDEX (''?'')'</code></p>
<ul>
<li>Обновление статистики. Статистика — небольшая таблица (обычно до 200 строк), в которой хранится обобщенная информация о том, какие значения и как часто встречаются в таблице. На основании статистики сервер принимает решение, как лучше построить запрос. Когда происходят запросы к БД (например, SELECT) вы получаете данные, но не описываете то, как эти данные должны быть извлечены. В получении и обработке данных помогает статистика. Во время выполнения процедуры обновления статистики данные не блокируются.</li>
</ul>
<p><code>exec sp_msforeachtable N'UPDATE STATISTICS ? WITH FULLSCAN'</code></p>
<ul>
<li>Очистка процедурного кэша, выполняется после обновления статистики. Оптимизатор MS SQL Server кэширует планы запросов для их повторного выполнения. Это делается для того, чтобы экономить время, затрачиваемое на компиляцию запроса в том случае, если такой же запрос уже выполнялся и его план известен. После обновия статистики, не будет очищен процедурный кэш, то SQL Server может выбрать старый (неоптимальный) план запроса из кэша вместо того, чтобы построить новый (более оптимальный) план.</li>
</ul>
<p><code>DBCC FREEPROCCACHE</code></p>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>GitHub</li>
            

            
                <li>Lifailon</li>
            

            
                
            
                
            
                
                    <li>
                        
                            <a href="https://github.com/Lifailon" target="_blank">
                                <i class="bi-github"></i>
                            </a>
                        

                    </li>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            

            
            

            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.123.8</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Mar 14 2024
                        </time>
                    
                </li>
            

            
        </ul>
    </div>
</footer>

    </body>

    























    
    


    
    


    <script
        type="text/javascript"
        src="/js/index_d751713.min.5eeb120f16ea146352725c420364f87befead45f678142b8f0ffbef024646931fbc06bff07a7bd6cb57fa2f8cd8a21ba6a4ee5a278ec32303a378bc1cd17f246.js"
        integrity="sha512-XusSDxbqFGNSclxCA2T4e&#43;/q1F9ngUK48P&#43;&#43;8CRkaTH7wGv/B6e9bLV/ovjNiiG6ak7lonjsMjA6N4vBzRfyRg=="></script>














<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
